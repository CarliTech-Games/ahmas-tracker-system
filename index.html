<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>At HOME Massage & Spa Tracker</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- 3. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- 5. Firebase (Compat Version - CDN for single-file operation) -->
    <!-- UPDATED to v12.6.0 CDN -->
    <script src="https://www.gstatic.com/firebasejs/12.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore-compat.js"></script>

    <!-- 6. Styles -->
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #10b981;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- CONSTANTS ---
        const BRANCHES = [
            'Guadalupe', 
            'Mabolo', 
            'Talisay', 
            'Bacayan', 
            'Lapu-lapu', 
            'AS Fortuna'
        ];

        // --- FIREBASE CONFIGURATION (CUSTOMIZABLE FOR EXTERNAL DEPLOYMENT) ---
        const MANUAL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyAKXcZwKtFBRFvGbOKd0UnQrLuOLt7wV9M",
            authDomain: "ahmas-tracker.firebaseapp.com",
            projectId: "ahmas-tracker",
            storageBucket: "ahmas-tracker.firebasestorage.app",
            messagingSenderId: "6650730194",
            appId: "1:6650730194:web:eedf9c5bcb25cfe12ebf0b",
            measurementId: "G-XW2GZJXN08"
        };
        
        const firebaseConfig = MANUAL_FIREBASE_CONFIG; 
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;


        // --- ICON COMPONENT ---
        const Icon = ({ name, size = 24, className = "", ...props }) => {
            const wrapperRef = useRef(null);
            useEffect(() => {
                if (!wrapperRef.current) return;
                const tempIcon = document.createElement('i');
                tempIcon.setAttribute('data-lucide', name);
                wrapperRef.current.innerHTML = '';
                wrapperRef.current.appendChild(tempIcon);
                lucide.createIcons({
                    root: wrapperRef.current,
                    nameAttr: 'data-lucide',
                    attrs: { width: size, height: size, class: className, ...props }
                });
            }, [name, size, className]);
            return <span ref={wrapperRef} style={{ display: 'inline-flex', verticalAlign: 'middle' }}></span>;
        };

        const Icons = {
            LayoutDashboard: (p) => <Icon name="layout-dashboard" {...p} />,
            Plus: (p) => <Icon name="plus" {...p} />,
            DollarSign: (p) => <Icon name="dollar-sign" {...p} />,
            Calendar: (p) => <Icon name="calendar" {...p} />,
            CheckCircle2: (p) => <Icon name="check-circle-2" {...p} />,
            Clock: (p) => <Icon name="clock" {...p} />,
            Trash2: (p) => <Icon name="trash-2" {...p} />,
            Users: (p) => <Icon name="users" {...p} />,
            Sparkles: (p) => <Icon name="sparkles" {...p} />,
            Home: (p) => <Icon name="home" {...p} />,
            UserCircle2: (p) => <Icon name="user-circle-2" {...p} />,
            History: (p) => <Icon name="history" {...p} />,
            ChevronDown: (p) => <Icon name="chevron-down" {...p} />,
            ChevronUp: (p) => <Icon name="chevron-up" {...p} />,
            Archive: (p) => <Icon name="archive" {...p} />,
            AlertTriangle: (p) => <Icon name="alert-triangle" {...p} />,
            X: (p) => <Icon name="x" {...p} />,
            Download: (p) => <Icon name="download" {...p} />,
            LogOut: (p) => <Icon name="log-out" {...p} />,
            Lock: (p) => <Icon name="lock" {...p} />,
            ShieldCheck: (p) => <Icon name="shield-check" {...p} />,
            UserPlus: (p) => <Icon name="user-plus" {...p} />,
            User: (p) => <Icon name="user" {...p} />,
            Fingerprint: (p) => <Icon name="fingerprint" {...p} />,
            UserCog: (p) => <Icon name="user-cog" {...p} />,
            Cloud: (p) => <Icon name="cloud" {...p} />,
            WifiOff: (p) => <Icon name="wifi-off" {...p} />,
            Trophy: (p) => <Icon name="trophy" {...p} />,
            MapPin: (p) => <Icon name="map-pin" {...p} />
        };

        // --- List Management Component (Admin Only) ---
        // Service management removed, only Therapist management remains
        const ListManagement = ({ therapists, onAdd, onDelete }) => {
            const [newItemName, setNewItemName] = useState('');
            const [modal, setModal] = useState({ isOpen: false, type: 'confirm', title: '', message: '', onConfirm: null, confirmColor: 'red' });
            const closeModal = () => setModal({ ...modal, isOpen: false });
            
            const handleFormSubmit = (e) => {
                e.preventDefault();
                onAdd('therapist', newItemName);
                setNewItemName('');
            };
            
            const currentList = therapists;

            return (
                <div className="space-y-6 fade-in">
                    <h2 className="text-lg font-bold text-emerald-900 flex gap-2 items-center"><Icons.ShieldCheck size={18}/> Data Lists Management</h2>
                    
                    {/* SERVICE NOTE: Reassurance that pricing is flexible */}
                    <div className="bg-blue-50 border-l-4 border-blue-400 text-blue-800 p-3 rounded-lg text-sm">
                        <p className="font-semibold mb-1">Service & Pricing Note:</p>
                        <p>Service names and prices are now entered manually in the Booking tab, allowing for flexible/changing rates. Use this section only to manage the required **Therapist** staff list for consistent reporting.</p>
                    </div>

                    {/* Add New Therapist */}
                    <div className="bg-white rounded-xl shadow-sm border border-emerald-100 p-6">
                        <h3 className="font-bold mb-4 flex items-center gap-2"><Icons.Plus size={18} className="text-emerald-600"/> Add New Therapist</h3>
                        <form onSubmit={handleFormSubmit} className="flex gap-2">
                            <input 
                                required 
                                placeholder={`Enter Therapist Name`} 
                                value={newItemName} 
                                onChange={e => setNewItemName(e.target.value)} 
                                className="flex-1 p-3 border rounded-lg bg-slate-50"
                            />
                            <button type="submit" className="bg-emerald-600 text-white p-3 rounded-lg font-bold hover:bg-emerald-700 transition">Add</button>
                        </form>
                    </div>

                    {/* Current Therapist List */}
                    <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                        <div className="p-4 bg-emerald-50 font-bold text-emerald-800 text-sm border-b border-emerald-100 flex justify-between items-center">
                            Current Therapists ({currentList.length})
                        </div>
                        
                        {currentList.length === 0 ? (
                            <p className="text-center text-slate-400 p-6 italic">No therapists added yet.</p>
                        ) : (
                            currentList.map(item => (
                                <div key={item.id} className="p-4 border-b flex justify-between items-center last:border-b-0">
                                    <span className="text-slate-700 font-medium">{item.name}</span>
                                    <button onClick={() => onDelete('therapist', item.id, item.name)} className="text-slate-300 hover:text-red-500 p-1 rounded">
                                        <Icons.Trash2 size={16}/>
                                    </button>
                                </div>
                            ))
                        )}
                    </div>
                     {modal.isOpen && <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60"><div className="bg-white rounded-xl p-6 max-w-sm"><h3 className="font-bold mb-2">{modal.title}</h3><p className="mb-4 text-sm">{modal.message}</p><div className="flex gap-2 justify-end">{modal.type==='confirm'&&<button onClick={closeModal} className="px-4 py-2 text-slate-500">Cancel</button>}<button onClick={modal.onConfirm||closeModal} className={`px-4 py-2 rounded text-white ${modal.confirmColor==='red'?'bg-red-500':'bg-emerald-600'}`}>Okay</button></div></div></div>}
                </div>
            );
        };


        // --- MAIN APP ---
        const App = () => {
            const [fb, setFb] = useState(null);
            const [fbUser, setFbUser] = useState(null);
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            const [dbReady, setDbReady] = useState(false);
            const [configError, setConfigError] = useState(null); 

            const [user, setUser] = useState(null);
            const [users, setUsers] = useState([]);
            const [transactions, setTransactions] = useState([]);
            const [history, setHistory] = useState([]);
            
            // Master Lists
            // servicesList state kept, but populated manually by user input on Booking form
            const [therapistsList, setTherapistsList] = useState([]);
            
            const [view, setView] = useState('dashboard');
            const [expandedHistoryId, setExpandedHistoryId] = useState(null);
            
            // Staff Accountability State
            const [showMyShift, setShowMyShift] = useState(false);

            // History Filtering State
            const [historyStartDate, setHistoryStartDate] = useState('');
            const [historyEndDate, setHistoryEndDate] = useState('');
            
            // Forms
            const [loginUsername, setLoginUsername] = useState('');
            const [loginPin, setLoginPin] = useState('');
            const [loginBranch, setLoginBranch] = useState(''); 
            
            const [newUser, setNewUser] = useState({ name: '', username: '', pin: '', role: 'staff' });
            const [profileData, setProfileData] = useState({ username: '', pin: '' });
            // Removed 'duration' field
            const [formData, setFormData] = useState({
                clientName: '', service: '', therapist: '', amount: '', type: 'booking', time: new Date().toTimeString().slice(0, 5)
            });
            const [modal, setModal] = useState({
                isOpen: false, type: 'confirm', title: '', message: '', onConfirm: null, confirmColor: 'red'
            });

            // Utility to close modal
            const closeModal = () => setModal({ ...modal, isOpen: false });

            // --- 1. INITIALIZE FIREBASE ---
            useEffect(() => {
                const initFirebase = async () => {
                    if (!firebaseConfig || !firebaseConfig.projectId) {
                        setConfigError("Firebase configuration is incomplete. Please check the firebaseConfig object.");
                        return;
                    }
                    
                    try {
                        if (!firebase.apps.length) {
                            firebase.initializeApp(firebaseConfig);
                        }
                        
                        const auth = firebase.auth();
                        const db = firebase.firestore();
                        const currentAppId = firebaseConfig.projectId || 'default-app-id';

                        if (initialAuthToken) {
                            await auth.signInWithCustomToken(initialAuthToken);
                        } else {
                            await auth.signInAnonymously();
                        }

                        auth.onAuthStateChanged((u) => {
                            if (u) {
                                setFbUser(u);
                                setFb({ db, auth, appId: currentAppId });
                            }
                        });
                    } catch (error) { 
                        console.error("FB Init Error:", error); 
                        
                        let msg = error.message || "Unknown connection error";
                        
                        if (error.code === 'auth/operation-not-allowed') {
                            msg = "Anonymous Authentication is DISABLED. Please go to Firebase Console -> Authentication -> Sign-in method -> Enable Anonymous.";
                        } else if (error.code === 'auth/unauthorized-domain') {
                            msg = "Domain not authorized. Go to Firebase Console -> Authentication -> Settings -> Authorized Domains and add 'vercel.app' or your custom domain.";
                        }

                        setConfigError(msg); 
                    }
                };

                setTimeout(initFirebase, 500);

                window.addEventListener('online', () => setIsOnline(true));
                window.addEventListener('offline', () => setIsOnline(false));
                return () => {
                    window.removeEventListener('online', () => setIsOnline(true));
                    window.removeEventListener('offline', () => setIsOnline(false));
                };
            }, []);

            // --- 2. DATA SYNC ---
            // Removed service seeding logic as prices are now manual.
            
            useEffect(() => {
                if (!fb || !fbUser) return;
                const { db, appId } = fb;
                const basePath = `artifacts/${appId}/public/data`;
                
                // Helper to get collection reference
                const getCollection = (name) => db.collection(`${basePath}/${name}`);

                // Transactions
                const unsubTrans = getCollection('transactions')
                    .onSnapshot((snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        data.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                        setTransactions(data);
                        setDbReady(true);
                    }, (error) => console.error("Sync Error: Transactions", error));

                // History
                const unsubHistory = getCollection('history')
                    .onSnapshot((snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        data.sort((a, b) => (b.timestamp_val || 0) - (a.timestamp_val || 0));
                        setHistory(data);
                    }, (error) => console.error("Sync Error: History", error));

                // Users
                const unsubUsers = getCollection('users')
                    .onSnapshot((snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        if (data.length === 0) seedDefaultUsers(db, basePath);
                        else setUsers(data);
                    }, (error) => console.error("Sync Error: Users", error));

                // Therapists
                const unsubTherapists = getCollection('therapists')
                    .onSnapshot((snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setTherapistsList(data.sort((a, b) => a.name.localeCompare(b.name)));
                    }, (error) => console.error("Sync Error: Therapists", error));


                return () => { 
                    unsubTrans(); 
                    unsubHistory(); 
                    unsubUsers(); 
                    unsubTherapists(); 
                };
            }, [fb, fbUser]);

            // --- 3. HELPERS ---
            
            const seedDefaultUsers = async (db, basePath) => {
                const defaults = [
                    { name: 'Owner Admin', username: 'admin', pin: '8888', role: 'admin' },
                    { name: 'Morning Rec.', username: 'morning', pin: '1111', role: 'staff' },
                    { name: 'Night Rec.', username: 'night', pin: '2222', role: 'staff' }
                ];
                const userColl = db.collection(`${basePath}/users`);
                for (const u of defaults) await userColl.add(u);
            };

            useEffect(() => {
                if (view === 'profile' && user) {
                    const freshUser = users.find(u => u.id === user.id) || user;
                    setProfileData({ username: freshUser.username, pin: freshUser.pin });
                }
            }, [view, user, users]);

            const formatCurrency = (val) => new Intl.NumberFormat('en-PH', { style: 'currency', currency: 'PHP' }).format(val);
            
            const formatDate = (timestamp) => {
                if (!timestamp) return 'N/A';
                const date = new Date(timestamp);
                return date.toLocaleDateString();
            };
            
            // Filter Transactions by Branch AND My Shift Toggle
            const getFilteredData = () => {
                if (!user) return [];
                let data = transactions;

                // 1. Filter by Branch (if not ALL)
                if (user.currentBranch !== 'ALL') {
                    data = data.filter(t => t.branch === user.currentBranch);
                }

                // 2. Filter by User (if My Shift is toggled AND user is staff)
                if (showMyShift && user.role !== 'admin') {
                    data = data.filter(t => t.recordedBy === user.name);
                }
                
                return data;
            };

            const filteredTransactions = getFilteredData();

            const stats = useMemo(() => {
                const data = filteredTransactions;
                const totalRevenue = data.filter(t => t.status === 'completed').reduce((acc, curr) => acc + Number(curr.amount), 0);
                const pendingValue = data.filter(t => t.status === 'pending').reduce((acc, curr) => acc + Number(curr.amount), 0);
                const totalBookings = data.filter(t => t.type === 'booking').length;
                const completedSales = data.filter(t => t.status === 'completed').length;
                return { totalRevenue, pendingValue, totalBookings, completedSales };
            }, [filteredTransactions]);

            // Therapist Stats by Branch
            const therapistStats = useMemo(() => {
                const grouped = {};
                
                filteredTransactions.forEach(t => {
                    const branch = t.branch || (user.currentBranch !== 'ALL' ? user.currentBranch : 'Unknown');
                    const name = t.therapist ? t.therapist.trim() : 'Unassigned';
                    
                    if (!name) return;

                    if (!grouped[branch]) grouped[branch] = {};
                    if (!grouped[branch][name]) grouped[branch][name] = { name, count: 0, amount: 0 };
                    
                    grouped[branch][name].count++;
                    grouped[branch][name].amount += Number(t.amount);
                });

                const result = {};
                Object.keys(grouped).forEach(branch => {
                    result[branch] = Object.values(grouped[branch]).sort((a, b) => b.count - a.count);
                });
                
                return result;
            }, [filteredTransactions, user]);
            
            // Filtered History Logic (for Admin view)
            const filteredHistory = useMemo(() => {
                let data = history;

                if (historyStartDate) {
                    // Set start time to beginning of the day (00:00:00)
                    const startTimestamp = new Date(historyStartDate).getTime();
                    data = data.filter(h => (h.timestamp_val || 0) >= startTimestamp);
                }

                if (historyEndDate) {
                    // Set end time to midnight of the *next* day to include reports up to 23:59:59 of the selected day
                    const endTimestamp = new Date(historyEndDate);
                    endTimestamp.setDate(endTimestamp.getDate() + 1); 
                    const endTimestampVal = endTimestamp.getTime();
                    data = data.filter(h => (h.timestamp_val || 0) < endTimestampVal);
                }

                return data;
            }, [history, historyStartDate, historyEndDate]);


            const downloadCSV = (record) => {
                const headers = ['Date', 'Branch', 'Time', 'Client Name', 'Service', 'Therapist', 'Amount', 'Status', 'Recorded By'];
                const rows = record.transactions.map(t => [
                    `"${record.date}"`, `"${t.branch || 'N/A'}"`, `"${t.time}"`, `"${t.clientName}"`, `"${t.service}"`, `"${t.therapist}"`, t.amount, t.status, `"${t.recordedBy || 'System'}"`
                ]);
                const csvContent = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `AtHome_Report_${record.date.replace(/,/g, '').replace(/ /g, '_')}.csv`;
                link.click();
            };


            // --- 4. ACTIONS ---

            // List Management Handlers (Only for Therapists now)
            const handleAddItem = async (listType, itemName) => {
                if (listType !== 'therapist' || !itemName) return;

                const basePath = `artifacts/${fb.appId}/public/data`;
                
                const currentList = therapistsList;
                if (currentList.some(item => item.name.toLowerCase() === itemName.trim().toLowerCase())) {
                    setModal({ isOpen: true, type: 'alert', title: 'Duplicate Item', message: `${itemName} already exists in therapists.`, onConfirm: closeModal, confirmColor: 'red' });
                    return;
                }

                await fb.db.collection(`${basePath}/therapists`).add({
                    name: itemName.trim()
                });
            };

            const handleDeleteItem = (listType, id, name) => {
                if (listType !== 'therapist') return;

                const basePath = `artifacts/${fb.appId}/public/data`;
                
                setModal({
                    isOpen: true, type: 'confirm', title: `Delete Therapist?`, message: `Are you sure you want to permanently delete "${name}"?`, confirmColor: 'red',
                    onConfirm: async () => {
                        await fb.db.collection(`${basePath}/therapists`).doc(id).delete();
                        closeModal();
                    }
                });
            };

            // History Deletion Handler (Admin Only)
            const handleDeleteHistory = (id, date) => {
                if (user?.role !== 'admin') return;

                 setModal({
                    isOpen: true, type: 'confirm', title: `Delete Report?`, message: `Are you sure you want to permanently delete the archived report for ${date}? This action cannot be undone.`, confirmColor: 'red',
                    onConfirm: async () => {
                        const basePath = `artifacts/${fb.appId}/public/data`;
                        await fb.db.collection(`${basePath}/history`).doc(id).delete();
                        closeModal();
                    }
                });
            };
            

            const handleLoginSubmit = (e) => {
                e.preventDefault();
                if (!loginBranch) {
                    setModal({ isOpen: true, type: 'alert', title: 'Branch Required', message: 'Please select your branch location.', onConfirm: closeModal, confirmColor: 'red' });
                    return;
                }

                const found = users.find(u => u.username.toLowerCase() === loginUsername.toLowerCase() && u.pin === loginPin);
                if (found) {
                    setUser({ ...found, currentBranch: loginBranch });
                    setLoginUsername(''); setLoginPin(''); setLoginBranch(''); setView('dashboard');
                } else {
                    setModal({ isOpen: true, type: 'alert', title: 'Login Failed', message: 'Check credentials.', onConfirm: closeModal, confirmColor: 'red' });
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                // Validation for required fields (Client Name, Price, Service, Therapist)
                if (!formData.clientName || !formData.amount || !formData.service || !formData.therapist) {
                    setModal({ isOpen: true, type: 'alert', title: 'Missing Information', message: 'Please ensure Client Name, Service, Therapist, and Price are all entered.', onConfirm: closeModal, confirmColor: 'red' });
                    return;
                }
                
                const basePath = `artifacts/${fb.appId}/public/data`;
                await fb.db.collection(`${basePath}/transactions`).add({
                    ...formData,
                    amount: parseFloat(formData.amount),
                    status: formData.type === 'sale' ? 'completed' : 'pending',
                    recordedBy: user.name,
                    branch: user.currentBranch, 
                    timestamp: Date.now()
                });

                setFormData({ 
                    clientName: '', 
                    service: '', 
                    therapist: '', 
                    amount: '', 
                    type: 'booking', 
                    time: new Date().toTimeString().slice(0, 5) 
                });
                
                setModal({ isOpen: true, type: 'alert', title: 'Booking Saved!', message: `${formData.clientName}'s transaction has been successfully recorded.`, onConfirm: closeModal, confirmColor: 'emerald' });

                setView('dashboard');
            };

            const toggleStatus = async (t) => {
                const basePath = `artifacts/${fb.appId}/public/data`;
                const newStatus = t.status === 'pending' ? 'completed' : 'pending';
                await fb.db.collection(`${basePath}/transactions`).doc(t.id).update({ status: newStatus });
            };

            const requestDelete = (id) => {
                if (user?.role !== 'admin') {
                    setModal({ isOpen: true, type: 'alert', title: 'Access Denied', message: 'Only Admin can delete.', onConfirm: closeModal, confirmColor: 'red' });
                    return;
                }
                setModal({
                    isOpen: true, type: 'confirm', title: 'Delete Record?', message: 'Permanently remove from cloud?', confirmColor: 'red',
                    onConfirm: async () => {
                        const basePath = `artifacts/${fb.appId}/public/data`;
                        await fb.db.collection(`${basePath}/transactions`).doc(id).delete();
                        closeModal();
                    }
                });
            };

            const requestEndDay = () => {
                if (user?.role !== 'admin') {
                    setModal({ isOpen: true, type: 'alert', title: 'Access Denied', message: 'Only Admin can close the day.', onConfirm: closeModal, confirmColor: 'red' });
                    return;
                }
                if (filteredTransactions.length === 0) {
                    setModal({ isOpen: true, type: 'alert', title: 'No Data', message: 'Nothing to save for this branch.', onConfirm: closeModal, confirmColor: 'emerald' });
                    return;
                }

                setModal({
                    isOpen: true, type: 'confirm', title: 'End Day & Sync?', message: `Save ${user.currentBranch} report to history and clear board?`, confirmColor: 'emerald',
                    onConfirm: async () => {
                        const basePath = `artifacts/${fb.appId}/public/data`;
                        const historyColl = fb.db.collection(`${basePath}/history`);
                        const transColl = fb.db.collection(`${basePath}/transactions`);

                        await historyColl.add({
                            // Keep 'date' in the history format for backwards compatibility with existing history records
                            date: new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }),
                            timestamp: new Date().toLocaleString(),
                            timestamp_val: Date.now(),
                            transactions: filteredTransactions,
                            stats: stats,
                            branch: user.currentBranch,
                            closedBy: user.name
                        });

                        const deletePromises = filteredTransactions.map(t => transColl.doc(t.id).delete());
                        await Promise.all(deletePromises);

                        setView('history');
                        closeModal();
                    }
                });
            };

            // User & Profile Handlers
            const handleAddUser = async (e) => {
                e.preventDefault();
                if (!newUser.name || !newUser.username || !newUser.pin) return;
                if (users.some(u => u.username.toLowerCase() === newUser.username.toLowerCase())) { 
                    setModal({ isOpen: true, type: 'alert', title: 'Username Taken', message: 'This username is already in use.', onConfirm: closeModal, confirmColor: 'red' });
                    return; 
                }
                const basePath = `artifacts/${fb.appId}/public/data`;
                await fb.db.collection(`${basePath}/users`).add(newUser);
                setNewUser({ name: '', username: '', pin: '', role: 'staff' });
            };
            const handleDeleteUser = (id) => {
                if (users.length <= 1) { 
                    setModal({ isOpen: true, type: 'alert', title: 'Action Denied', message: 'Cannot delete the last remaining user.', onConfirm: closeModal, confirmColor: 'red' });
                    return; 
                }
                setModal({ isOpen: true, type: 'confirm', title: 'Remove Staff?', message: 'Revoke access for this user?', confirmColor: 'red', onConfirm: async () => { 
                    const basePath = `artifacts/${fb.appId}/public/data`;
                    await fb.db.collection(`${basePath}/users`).doc(id).delete(); 
                    closeModal(); 
                }});
            };
            const handleUpdateProfile = async (e) => {
                e.preventDefault();
                if (users.some(u => u.username.toLowerCase() === profileData.username.toLowerCase() && u.id !== user.id)) { 
                    setModal({ isOpen: true, type: 'alert', title: 'Username Taken', message: 'This username is already in use by another staff.', onConfirm: closeModal, confirmColor: 'red' });
                    return; 
                }
                const basePath = `artifacts/${fb.appId}/public/data`;
                await fb.db.collection(`${basePath}/users`).doc(user.id).update(profileData);
                setUser({ ...user, ...profileData });
                setModal({ isOpen: true, type: 'alert', title: 'Updated', message: 'Credentials synced.', onConfirm: closeModal, confirmColor: 'emerald' });
            };

            // --- RENDER ---

            if (configError) return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-slate-100 text-center p-4">
                    <div className="bg-white p-8 rounded-xl shadow-lg max-w-md">
                        <Icons.Cloud size={48} className="mx-auto text-slate-400 mb-4"/>
                        <h2 className="text-xl font-bold text-slate-800 mb-2">Setup Failed</h2>
                        <p className="text-slate-500 text-sm mb-6 font-mono bg-slate-50 p-2 rounded border text-left text-xs">{configError}</p>
                        <p className="text-xs text-slate-400">
                            Check: 
                            <ol className="list-decimal text-left pl-6 mt-2 space-y-1">
                                <li>Did you create the Firestore Database?</li>
                                <li>Did you enable Anonymous Authentication?</li>
                                <li>Did you add the Vercel domain to Authorized Domains?</li>
                            </ol>
                        </p>
                    </div>
                </div>
            );

            if (!dbReady) return <div className="min-h-screen flex flex-col items-center justify-center bg-slate-50"><div className="loader mb-4"></div><p className="text-slate-400 text-sm">Connecting to Spa Cloud...</p></div>;

            // LOGIN SCREEN
            if (!user) {
                return (
                    <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-6 fade-in">
                        <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm border border-emerald-100 text-center relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-emerald-400 to-teal-600"></div>
                            <div className="w-20 h-20 bg-emerald-50 rounded-full flex items-center justify-center mx-auto mb-6 shadow-sm border border-emerald-100"><Icons.Lock size={32} className="text-emerald-600" /></div>
                            <h1 className="text-2xl font-bold text-emerald-900 mb-1">At HOME Massage & Spa</h1>
                            <p className="text-slate-500 mb-6 text-sm">Staff Portal</p>
                            
                            <form onSubmit={handleLoginSubmit} className="space-y-4">
                                <div className="relative">
                                    <Icons.MapPin size={18} className="absolute left-3 top-3.5 text-slate-400" />
                                    <select required value={loginBranch} onChange={(e)=>setLoginBranch(e.target.value)} className="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-slate-50 focus:bg-white appearance-none text-slate-600">
                                        <option value="" disabled>Select Branch Location</option>
                                        {BRANCHES.map(b => <option key={b} value={b}>{b}</option>)}
                                        <option value="ALL" className="font-bold text-emerald-600">ALL BRANCHES (Owner View)</option>
                                    </select>
                                    <Icons.ChevronDown size={16} className="absolute right-3 top-4 text-slate-400 pointer-events-none"/>
                                </div>
                                <div className="relative"><Icons.User size={18} className="absolute left-3 top-3.5 text-slate-400" /><input required value={loginUsername} onChange={(e)=>setLoginUsername(e.target.value)} placeholder="Username" className="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-slate-50 focus:bg-white" /></div>
                                <div className="relative"><Icons.Fingerprint size={18} className="absolute left-3 top-3.5 text-slate-400" /><input required type="password" inputMode="numeric" value={loginPin} onChange={(e)=>setLoginPin(e.target.value)} placeholder="PIN" className="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-slate-50 focus:bg-white" /></div>
                                <button className="w-full bg-emerald-600 text-white font-bold py-3 rounded-xl hover:bg-emerald-700 transition-all shadow-lg shadow-emerald-200 mt-2">Login</button>
                            </form>
                            {!isOnline && <p className="mt-4 text-xs text-red-400 flex items-center justify-center gap-1"><Icons.WifiOff size={12}/> You are offline</p>}
                        </div>
                        {modal.isOpen && <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60"><div className="bg-white rounded-xl p-6 max-w-sm"><h3 className="font-bold mb-2">{modal.title}</h3><p className="mb-4 text-sm">{modal.message}</p><div className="flex gap-2 justify-end">{modal.type==='confirm'&&<button onClick={closeModal} className="px-4 py-2 text-slate-500">Cancel</button>}<button onClick={modal.onConfirm||closeModal} className={`px-4 py-2 rounded text-white ${modal.confirmColor==='red'?'bg-red-500':'bg-emerald-600'}`}>Okay</button></div></div></div>}
                    </div>
                );
            }

            // DASHBOARD
            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-800 pb-24 relative fade-in">
                    <header className="bg-white border-b border-emerald-100 sticky top-0 z-20 shadow-sm">
                        <div className="max-w-3xl mx-auto px-4 py-3 flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <div className={`p-2 rounded-lg shadow-md ${user.role==='admin'?'bg-emerald-600 shadow-emerald-200':'bg-slate-600 shadow-slate-200'}`}><Icons.Home size={22} className="text-white"/></div>
                                <div>
                                    <h1 className="text-lg font-bold text-emerald-800 leading-tight">At HOME Massage & Spa</h1>
                                    <div className="flex items-center gap-2 text-[10px] font-bold uppercase tracking-wide text-slate-500">
                                        <span className="bg-emerald-50 text-emerald-700 px-2 py-0.5 rounded flex items-center gap-1"><Icons.MapPin size={10}/> {user.currentBranch}</span>
                                        <span className="flex items-center gap-1"><Icons.UserCircle2 size={10}/> {user.name}</span>
                                    </div>
                                </div>
                            </div>
                            <button onClick={()=>{setUser(null); setView('dashboard');}} className="p-2 text-slate-400 hover:text-red-500 rounded-lg"><Icons.LogOut size={20}/></button>
                        </div>
                        {!isOnline && <div className="bg-red-500 text-white text-xs text-center py-1">No Internet - Sync Paused</div>}
                    </header>

                    <main className="max-w-3xl mx-auto px-4 py-6">
                        <div className="flex p-1 bg-slate-200/60 rounded-xl mb-6 sticky top-[70px] z-10 backdrop-blur-sm overflow-x-auto">
                            <button onClick={()=>setView('dashboard')} className={`flex-1 min-w-[70px] py-2.5 text-xs font-semibold rounded-lg flex flex-col sm:flex-row items-center justify-center gap-1 ${view==='dashboard'?'bg-white text-emerald-700 shadow-sm':'text-slate-500'}`}><Icons.LayoutDashboard size={16}/> Daily</button>
                            <button onClick={()=>setView('add')} className={`flex-1 min-w-[70px] py-2.5 text-xs font-semibold rounded-lg flex flex-col sm:flex-row items-center justify-center gap-1 ${view==='add'?'bg-white text-emerald-700 shadow-sm':'text-slate-500'}`}><Icons.Plus size={16}/> Booking</button>
                            <button onClick={()=>setView('profile')} className={`flex-1 min-w-[70px] py-2.5 text-xs font-semibold rounded-lg flex flex-col sm:flex-row items-center justify-center gap-1 ${view==='profile'?'bg-white text-emerald-700 shadow-sm':'text-slate-500'}`}><Icons.UserCog size={16}/> Profile</button>
                            {user.role === 'admin' && (
                                <>
                                    <button onClick={()=>setView('lists')} className={`flex-1 min-w-[70px] py-2.5 text-xs font-semibold rounded-lg flex flex-col sm:flex-row items-center justify-center gap-1 ${view==='lists'?'bg-white text-emerald-700 shadow-sm':'text-slate-500'}`}><Icons.ShieldCheck size={16}/> Lists</button>
                                    <button onClick={()=>setView('history')} className={`flex-1 min-w-[70px] py-2.5 text-xs font-semibold rounded-lg flex flex-col sm:flex-row items-center justify-center gap-1 ${view==='history'?'bg-white text-emerald-700 shadow-sm':'text-slate-500'}`}><Icons.History size={16}/> History</button>
                                    <button onClick={()=>setView('team')} className={`flex-1 min-w-[70px] py-2.5 text-xs font-semibold rounded-lg flex flex-col sm:flex-row items-center justify-center gap-1 ${view==='team'?'bg-white text-emerald-700 shadow-sm':'text-slate-500'}`}><Icons.Users size={16}/> Team</button>
                                </>
                            )}
                        </div>

                        {view === 'dashboard' && (
                            <div className="space-y-6 fade-in">
                                <div className="grid grid-cols-2 gap-3">
                                    <div className="bg-white p-4 rounded-xl shadow-sm border border-emerald-100"><p className="text-slate-500 text-xs font-medium uppercase">Sales ({user.currentBranch})</p><h3 className="text-2xl font-bold text-slate-800 mt-1">{formatCurrency(stats.totalRevenue)}</h3></div>
                                    <div className="bg-white p-4 rounded-xl shadow-sm border border-emerald-100"><p className="text-slate-500 text-xs font-medium uppercase">Unpaid</p><h3 className="text-2xl font-bold text-slate-800 mt-1">{formatCurrency(stats.pendingValue)}</h3></div>
                                </div>

                                <div className="bg-white p-4 rounded-xl shadow-sm border border-emerald-100">
                                    <h3 className="text-sm font-bold text-slate-500 uppercase tracking-wider mb-4 flex items-center gap-2"><Icons.Trophy size={16} className="text-emerald-500"/> Therapist Handles (Today)</h3>
                                    
                                    {Object.keys(therapistStats).length === 0 ? (
                                        <p className="text-sm text-slate-400 italic text-center py-2">No activity yet.</p>
                                    ) : (
                                        // Sort branches alphabetically, but try to follow BRANCHES order if possible
                                        Object.keys(therapistStats).sort((a, b) => {
                                             const idxA = BRANCHES.indexOf(a);
                                             const idxB = BRANCHES.indexOf(b);
                                             if (idxA === -1 && idxB === -1) return a.localeCompare(b);
                                             if (idxA === -1) return 1;
                                             if (idxB === -1) return -1;
                                             return idxA - idxB;
                                         }).map(branch => (
                                            <div key={branch} className="mb-4 last:mb-0">
                                                {/* Only show branch header if in ALL mode or multiple branches exist */}
                                                {(user.currentBranch === 'ALL' || Object.keys(therapistStats).length > 1) && (
                                                    <h4 className="text-[10px] font-bold text-emerald-700 uppercase mb-2 bg-emerald-50 px-2 py-1 rounded inline-block">
                                                        {branch}
                                                    </h4>
                                                )}
                                                <div className="space-y-2">
                                                    {therapistStats[branch].map((s) => (
                                                        <div key={s.name} className="flex justify-between items-center pb-2 border-b border-slate-50 last:border-0 last:pb-0 ml-1">
                                                            <div className="flex gap-2 items-center">
                                                                <span className="w-6 h-6 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center text-[10px] font-bold">{s.name.charAt(0)}</span>
                                                                <span className="text-sm font-semibold text-slate-700">{s.name}</span>
                                                            </div>
                                                            <div className="text-right flex flex-col">
                                                                <span className="text-sm font-bold text-emerald-600">{s.count} <span className="text-[9px] font-normal text-slate-400 uppercase">Handles</span></span>
                                                                {user.role === 'admin' && <span className="text-[9px] text-slate-400">{formatCurrency(s.amount)}</span>}
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>

                                <div>
                                    <div className="flex justify-between items-center mb-4">
                                        <h2 className="text-lg font-bold text-emerald-900 flex gap-2">
                                            <Icons.LayoutDashboard size={18}/> Live Schedule ({showMyShift ? 'My Shift' : user.currentBranch})
                                        </h2>
                                        <div className="flex items-center gap-2">
                                            {user.role !== 'admin' && (
                                                <button 
                                                    onClick={() => setShowMyShift(!showMyShift)}
                                                    className={`text-[10px] font-bold ${showMyShift ? 'bg-emerald-600 text-white' : 'bg-emerald-50 text-emerald-700'} px-3 py-1.5 rounded-full border border-emerald-200 flex gap-1 items-center transition-colors`}
                                                >
                                                    <Icons.User size={12}/> {showMyShift ? 'Showing My Shift' : 'Show Only Mine'}
                                                </button>
                                            )}
                                            {user.role === 'admin' && (
                                                <button onClick={requestEndDay} className="text-[10px] font-bold text-emerald-700 bg-emerald-50 px-3 py-1.5 rounded-full border border-emerald-200 flex gap-1"><Icons.Archive size={12}/> End Day</button>
                                            )}
                                        </div>
                                    </div>
                                    {filteredTransactions.length===0?<div className="text-center py-12 border border-dashed rounded-xl text-slate-400 text-sm">No bookings found for the current filter.</div>:
                                    <div className="space-y-3">
                                        {filteredTransactions.map(t=>(
                                            <div key={t.id} className={`bg-white p-4 rounded-xl border-l-[6px] flex justify-between items-center ${t.status==='completed'?'border-l-emerald-500':'border-l-orange-400'} shadow-sm`}>
                                                <div className="flex-1">
                                                    {/* Displaying timestamp date for consistency */}
                                                    <div className="flex gap-2 mb-1 items-center">
                                                        <span className="text-[10px] font-bold bg-slate-100 px-2 rounded text-slate-500">{t.branch}</span>
                                                        <span className="text-xs font-mono text-slate-400">{formatDate(t.timestamp)} - {t.time}</span>
                                                    </div>
                                                    <h3 className="font-bold text-slate-800">{t.clientName}</h3>
                                                    {/* Removed (t.duration) */}
                                                    <div className="text-xs text-slate-500 mt-1 flex gap-2"><span>{t.service}</span>  <span>{t.therapist}</span></div>
                                                </div>
                                                <div className="text-right"><div className="font-bold text-lg">{formatCurrency(t.amount)}</div><div className="flex justify-end gap-2 mt-1"><button onClick={()=>toggleStatus(t)} className={`p-1.5 rounded-full ${t.status==='completed'?'bg-emerald-100 text-emerald-600':'bg-orange-100 text-orange-600'}`}>{t.status==='completed'?<Icons.CheckCircle2 size={16}/>:<Icons.DollarSign size={16}/>}</button>{user.role==='admin'&&<button onClick={()=>requestDelete(t.id)} className="p-1.5 text-slate-300 hover:text-red-500"><Icons.Trash2 size={16}/></button>}</div></div>
                                            </div>
                                        ))}
                                    </div>}
                                </div>
                            </div>
                        )}

                        {view === 'add' && (
                            <div className="bg-white rounded-2xl shadow-sm border border-emerald-100 p-6 fade-in">
                                <h2 className="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2"><Icons.Plus size={24} className="text-emerald-600"/> New Booking</h2>
                                <form onSubmit={handleSubmit} className="space-y-5">
                                    <div className="p-3 bg-emerald-50 rounded-lg text-sm text-emerald-800 font-medium flex items-center gap-2"><Icons.MapPin size={16}/> Adding to: {user.currentBranch}</div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <label className={`border-2 rounded-xl p-3 flex flex-col items-center gap-2 ${formData.type==='booking'?'border-emerald-600 bg-emerald-50/50':'border-slate-100'}`}><input type="radio" name="type" value="booking" checked={formData.type==='booking'} onChange={(e)=>setFormData({...formData, type:e.target.value})} className="hidden"/><Icons.Calendar/><span className="text-sm font-bold">Appointment</span></label>
                                        <label className={`border-2 rounded-xl p-3 flex flex-col items-center gap-2 ${formData.type==='sale'?'border-teal-600 bg-teal-50/50':'border-slate-100'}`}><input type="radio" name="type" value="sale" checked={formData.type==='sale'} onChange={(e)=>setFormData({...formData, type:e.target.value})} className="hidden"/><Icons.DollarSign/><span className="text-sm font-bold">Direct Pay</span></label>
                                    </div>
                                    <input required placeholder="Client Name*" value={formData.clientName} onChange={e=>setFormData({...formData, clientName:e.target.value})} className="w-full p-3 border rounded-xl bg-slate-50"/>
                                    
                                    {/* Service is now free-text input (Manual Price) */}
                                    <div className="grid grid-cols-2 gap-4">
                                        <input required placeholder="Service Name (e.g., Swedish 90 mins)*" value={formData.service} onChange={e=>setFormData({...formData, service:e.target.value})} className="w-full p-3 border rounded-xl bg-slate-50"/>
                                        
                                        {/* Therapist Dropdown (Managed List) */}
                                        <select required value={formData.therapist} onChange={e=>setFormData({...formData, therapist:e.target.value})} className="w-full p-3 border rounded-xl bg-slate-50 appearance-none">
                                            <option value="" disabled>Select Therapist*</option>
                                            {therapistsList.map(t => <option key={t.id} value={t.name}>{t.name}</option>)}
                                        </select>
                                    </div>
                                    
                                    <div className="grid grid-cols-2 gap-4">
                                        {/* Price is now editable and required */}
                                        <input required 
                                            type="number" step="0.01" 
                                            placeholder="Price (P)*" 
                                            value={formData.amount} 
                                            onChange={e=>setFormData({...formData, amount:e.target.value})} 
                                            className="w-full p-3 border rounded-xl bg-slate-50"
                                        />
                                        <input type="time" value={formData.time} onChange={e=>setFormData({...formData, time:e.target.value})} className="w-full p-3 border rounded-xl bg-slate-50"/>
                                    </div>
                                    <button className="w-full bg-emerald-600 text-white font-bold py-4 rounded-xl shadow-lg mt-2">Save Booking</button>
                                </form>
                            </div>
                        )}

                        {view === 'profile' && (
                            <div className="bg-white rounded-xl shadow-sm border border-emerald-100 p-6 fade-in">
                                <h3 className="font-bold text-slate-800 mb-4 flex gap-2"><Icons.UserCog className="text-emerald-600"/> Profile</h3>
                                <div className="bg-slate-50 p-4 rounded-xl border mb-6"><p className="text-xs text-slate-400 uppercase font-bold">Account</p><p className="font-bold text-emerald-800 text-lg">{user.name}</p></div>
                                <form onSubmit={handleUpdateProfile} className="space-y-4">
                                    <input required value={profileData.username} onChange={e=>setProfileData({...profileData, username:e.target.value})} className="w-full p-3 border rounded-lg" placeholder="New Username"/>
                                    <input required type="text" inputMode="numeric" maxLength="4" value={profileData.pin} onChange={e=>setProfileData({...profileData, pin:e.target.value})} className="w-full p-3 border rounded-lg font-mono" placeholder="New PIN"/>
                                    <button className="w-full bg-emerald-600 text-white font-bold py-3 rounded-lg">Update Credentials</button>
                                </form>
                            </div>
                        )}
                        
                        {/* Data List Management View */}
                        {view === 'lists' && user.role === 'admin' && (
                            <ListManagement 
                                therapists={therapistsList} 
                                onAdd={handleAddItem} 
                                onDelete={handleDeleteItem}
                            />
                        )}

                        {view === 'team' && user.role === 'admin' && (
                            <div className="space-y-6 fade-in">
                                <h2 className="text-lg font-bold text-emerald-900 flex gap-2"><Icons.Users/> Manage Staff</h2>
                                <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                                    {users.filter(u => {
                                        // Owner Admin sees everyone
                                        if (user.username === 'admin') {
                                            return true;
                                        }

                                        // Regular Admin/Staff only sees staff accounts OR themselves
                                        return u.id === user.id || u.role === 'staff';
                                    }).map(u=>(
                                        <div key={u.id} className="p-4 border-b flex justify-between items-center">
                                            <div>
                                                <h3 className="font-bold">{u.name} {u.username === 'admin' && <span className="text-xs font-mono text-emerald-600 bg-emerald-100 px-1 rounded-sm">OWNER</span>}</h3>
                                                <p className="text-xs text-slate-400">
                                                    @{u.username}  PIN: {u.pin}
                                                </p>
                                            </div>
                                            {/* Delete button visible only to Admin (and Owner Admin) */}
                                            {user.role === 'admin' && (
                                                <button 
                                                    onClick={()=>handleDeleteUser(u.id)} 
                                                    className="text-slate-300 hover:text-red-500"
                                                >
                                                    <Icons.Trash2/>
                                                </button>
                                            )}
                                        </div>
                                    ))}
                                </div>
                                <div className="bg-white rounded-xl shadow-sm border p-6">
                                    <h3 className="font-bold mb-4">Add Staff</h3>
                                    <form onSubmit={handleAddUser} className="space-y-4">
                                        <input required placeholder="Name" value={newUser.name} onChange={e=>setNewUser({...newUser, name:e.target.value})} className="w-full p-2 border rounded"/>
                                        <input required placeholder="Username" value={newUser.username} onChange={e=>setNewUser({...newUser, username:e.target.value})} className="w-full p-2 border rounded"/>
                                        <div className="flex gap-2"><input required maxLength="4" placeholder="PIN" value={newUser.pin} onChange={e=>setNewUser({...newUser, pin:e.target.value})} className="w-full p-2 border rounded"/><select value={newUser.role} onChange={e=>setNewUser({...newUser, role:e.target.value})} className="w-full p-2 border rounded"><option value="staff">Staff</option><option value="admin">Admin</option></select></div>
                                        <button className="w-full bg-emerald-600 text-white py-2 rounded font-bold">Add User</button>
                                    </form>
                                </div>
                            </div>
                        )}

                        {view === 'history' && user.role === 'admin' && (
                            <div className="space-y-4 fade-in">
                                <h2 className="text-lg font-bold text-emerald-900 flex gap-2"><Icons.History/> History</h2>
                                
                                {/* Date Range Filters */}
                                <div className="bg-white p-4 rounded-xl shadow-sm border border-emerald-100 grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="block text-xs font-medium text-slate-500 mb-1">Start Date</label>
                                        <input type="date" value={historyStartDate} onChange={(e) => setHistoryStartDate(e.target.value)} className="w-full p-2 border rounded-lg bg-slate-50 text-sm"/>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-medium text-slate-500 mb-1">End Date</label>
                                        <input type="date" value={historyEndDate} onChange={(e) => setHistoryEndDate(e.target.value)} className="w-full p-2 border rounded-lg bg-slate-50 text-sm"/>
                                    </div>
                                </div>

                                {filteredHistory.length === 0 ? (
                                    <div className="text-center py-12 border border-dashed rounded-xl text-slate-400 text-sm">No historical reports found for this period.</div>
                                ) : (
                                    filteredHistory.map(h => (
                                        <div key={h.id} className="bg-white rounded-xl shadow-sm border overflow-hidden">
                                            <div onClick={()=>setExpandedHistoryId(expandedHistoryId===h.id?null:h.id)} className="p-4 flex justify-between items-center cursor-pointer">
                                                <div><h3 className="font-bold text-slate-800">{h.date}</h3><p className="text-xs text-slate-400">{h.branch || 'Unknown'}  Closed by {h.closedBy}</p></div>
                                                <div className="flex items-center gap-4">
                                                    <button onClick={(e)=>{e.stopPropagation();downloadCSV(h)}} title="Download CSV"><Icons.Download size={20} className="text-slate-400 hover:text-emerald-600"/></button>
                                                    <button onClick={(e)=>{e.stopPropagation();handleDeleteHistory(h.id, h.date)}} title="Delete Report"><Icons.Trash2 size={20} className="text-slate-400 hover:text-red-500"/></button>
                                                    <span className="font-bold text-emerald-600">{formatCurrency(h.stats.totalRevenue)}</span>
                                                    {expandedHistoryId===h.id?<Icons.ChevronUp size={20} className="text-slate-400"/>:<Icons.ChevronDown size={20} className="text-slate-400"/>}
                                                </div>
                                            </div>
                                            {expandedHistoryId===h.id && <div className="bg-slate-50 p-4 border-t text-sm">{h.transactions.map((t,i)=><div key={i} className="flex justify-between py-2 border-b last:border-0"><span>{t.time} - {t.clientName} ({t.service})</span><span className="font-bold">{formatCurrency(t.amount)}</span></div>)}</div>}
                                        </div>
                                    ))
                                )}
                            </div>
                        )}

                        {modal.isOpen && <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60"><div className="bg-white rounded-xl p-6 max-w-sm"><h3 className="font-bold mb-2">{modal.title}</h3><p className="mb-4 text-sm">{modal.message}</p><div className="flex gap-2 justify-end">{modal.type==='confirm'&&<button onClick={closeModal} className="px-4 py-2 text-slate-500">Cancel</button>}<button onClick={modal.onConfirm||closeModal} className={`px-4 py-2 rounded text-white ${modal.confirmColor==='red'?'bg-red-500':'bg-emerald-600'}`}>Okay</button></div></div></div>}
                    </main>
                    {view === 'dashboard' && <button onClick={()=>setView('add')} className="fixed bottom-6 right-6 bg-emerald-600 text-white p-4 rounded-full shadow-lg hover:scale-105 transition-transform"><Icons.Plus size={28}/></button>}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
