<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>At HOME Massage & Spa Tracker</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://unpkg.com/lucide@latest"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // Custom Tailwind Configuration to use the Logo's Primary Green (#008000)
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'logo-green': {
                            50: '#E6FFE6',      // Very light background
                            100: '#CCFFCC',     // Light background
                            500: '#00B300',     // Medium
                            600: '#009900',     // Primary Button Hover
                            700: '#008000',     // Base Logo Green / Primary
                            800: '#006600',     // Darker text/header
                            900: '#004C00',     // Deepest text
                        },
                        'teal': {
                            600: '#008080', // Keep some teal accent for contrast
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #008000; /* Use logo-green */
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        .loader-lg {
            width: 48px;
            height: 48px;
            border-width: 5px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- CONSTANTS ---
        const BRANCHES = [
            'Guadalupe', 
            'Mabolo', 
            'Talisay', 
            'Bacayan', 
            'Lapu-lapu', 
            'AS Fortuna'
        ];
        
        const BOOKING_TYPES = [ // ⬅️ NEW: Booking Types
            'In-Spa',
            'Home Service'
        ];
        
        // --- FIREBASE CONFIGURATION ---
        const MANUAL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyAKXcZwKtFBRFvGbOKd0UnQrLuOLt7wV9M",
            authDomain: "ahmas-tracker.firebaseapp.com",
            projectId: "ahmas-tracker",
            storageBucket: "ahmas-tracker.firebasestorage.app",
            messagingSenderId: "6650730194",
            appId: "1:6650730194:web:eedf9c5bcb25cfe12ebf0b",
            measurementId: "G-XW2GZJXN08"
        };
        
        const firebaseConfig = MANUAL_FIREBASE_CONFIG; 
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;


        // --- ICON COMPONENT ---
        const Icon = ({ name, size = 24, className = "", ...props }) => {
            const wrapperRef = useRef(null);
            useEffect(() => {
                if (!wrapperRef.current) return;
                const tempIcon = document.createElement('i');
                tempIcon.setAttribute('data-lucide', name);
                wrapperRef.current.innerHTML = '';
                wrapperRef.current.appendChild(tempIcon);
                lucide.createIcons({
                    root: wrapperRef.current,
                    nameAttr: 'data-lucide',
                    attrs: { width: size, height: size, class: className, ...props }
                });
            }, [name, size, className]);
            return <span ref={wrapperRef} style={{ display: 'inline-flex', verticalAlign: 'middle' }}></span>;
        };

        const Icons = {
            LayoutDashboard: (p) => <Icon name="layout-dashboard" {...p} />,
            Plus: (p) => <Icon name="plus" {...p} />,
            DollarSign: (p) => <Icon name="dollar-sign" {...p} />,
            Calendar: (p) => <Icon name="calendar" {...p} />,
            CheckCircle2: (p) => <Icon name="check-circle-2" {...p} />,
            Clock: (p) => <Icon name="clock" {...p} />,
            Trash2: (p) => <Icon name="trash-2" {...p} />,
            Users: (p) => <Icon name="users" {...p} />,
            Sparkles: (p) => <Icon name="sparkles" {...p} />,
            Home: (p) => <Icon name="home" {...p} />,
            UserCircle2: (p) => <Icon name="user-circle-2" {...p} />,
            History: (p) => <Icon name="history" {...p} />,
            ChevronDown: (p) => <Icon name="chevron-down" {...p} />,
            ChevronUp: (p) => <Icon name="chevron-up" {...p} />,
            Archive: (p) => <Icon name="archive" {...p} />,
            AlertTriangle: (p) => <Icon name="alert-triangle" {...p} />,
            X: (p) => <Icon name="x" {...p} />,
            Download: (p) => <Icon name="download" {...p} />,
            LogOut: (p) => <Icon name="log-out" {...p} />,
            Lock: (p) => <Icon name="lock" {...p} />,
            ShieldCheck: (p) => <Icon name="shield-check" {...p} />,
            UserPlus: (p) => <Icon name="user-plus" {...p} />,
            User: (p) => <Icon name="user" {...p} />,
            Fingerprint: (p) => <Icon name="fingerprint" {...p} />,
            UserCog: (p) => <Icon name="user-cog" {...p} />,
            Cloud: (p) => <Icon name="cloud" {...p} />,
            WifiOff: (p) => <Icon name="wifi-off" {...p} />,
            Trophy: (p) => <Icon name="trophy" {...p} />,
            MapPin: (p) => <Icon name="map-pin" {...p} />,
            Tag: (p) => <Icon name="tag" {...p} />,
            Hourglass: (p) => <Icon name="hourglass" {...p} />,
            Pencil: (p) => <Icon name="pencil" {...p} />,
            Loader2: (p) => <Icon name="loader-2" {...p} />,
            ClipboardList: (p) => <Icon name="clipboard-list" {...p} />,
            MinusCircle: (p) => <Icon name="minus-circle" {...p} />,
            Wallet: (p) => <Icon name="wallet" {...p} />,
            TrendingUp: (p) => <Icon name="trending-up" {...p} />,
            Car: (p) => <Icon name="car" {...p} />, // ⬅️ NEW: Icon for Home Service
        };

        // --- SECURITY HELPER: Hashing Function ---
        const hashPin = async (pin) => {
            if (!pin || pin.length < 4) return null;
            try {
                // Use subtle crypto for SHA-256 hashing
                const msgUint8 = new TextEncoder().encode(pin);
                const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                return hashHex;
            } catch (error) {
                console.error("Hashing failed:", error);
                return null;
            }
        };

        // --- SECURITY HELPER: Timestamp Normalizer ---
        // Handles both legacy Date.now() numbers and Firestore Timestamp objects
        const getMillis = (ts) => {
            if (!ts) return Date.now(); // FIX: Treat pending/null as "now" so it appears at the top
            if (typeof ts === 'number') return ts; // Legacy or client-side number
            if (typeof ts.toMillis === 'function') return ts.toMillis(); // Firestore Timestamp object
            if (ts.seconds) return ts.seconds * 1000; // Raw object fallback
            return 0;
        };

        // --- Loading Component ---
        const LoadingOverlay = ({ message }) => (
            <div className="fixed inset-0 z-[60] flex items-center justify-center bg-slate-900/40 backdrop-blur-sm fade-in">
                <div className="bg-white p-6 rounded-2xl shadow-2xl flex flex-col items-center gap-4 min-w-[200px]">
                    <div className="loader loader-lg"></div>
                    <p className="text-slate-600 font-semibold text-sm animate-pulse">{message || 'Processing...'}</p>
                </div>
            </div>
        );


        // --- List Management Component (Admin Only) ---
        const ListManagement = ({ therapists, services, durations, onAdd, onDelete, onEdit }) => {
            const [activeTab, setActiveTab] = useState('therapist'); 
            
            // Add State
            const [newItemName, setNewItemName] = useState('');
            const [newItemPrices, setNewItemPrices] = useState({}); 
            const [newItemCommission, setNewItemCommission] = useState(''); 
            
            // Edit State
            const [editingId, setEditingId] = useState(null);
            const [editName, setEditName] = useState('');
            const [editPrices, setEditPrices] = useState({});
            const [editCommission, setEditCommission] = useState(''); 


            const [modal, setModal] = useState({ isOpen: false, type: 'confirm', title: '', message: '', onConfirm: null, confirmColor: 'red' });
            const closeModal = () => setModal({ ...modal, isOpen: false });
            
            const handleFormSubmit = (e) => {
                e.preventDefault();
                let extraData = null;
                if (activeTab === 'service') {
                    extraData = newItemPrices;
                } else if (activeTab === 'therapist') {
                    extraData = { commissionRate: parseFloat(newItemCommission) || 0 };
                }

                onAdd(activeTab, newItemName, extraData);
                setNewItemName('');
                setNewItemPrices({});
                setNewItemCommission(''); 
            };
            
            const startEdit = (item) => {
                setEditingId(item.id);
                setEditName(item.name);
                setEditPrices(item.prices || {});
                setEditCommission(item.commissionRate !== undefined ? String(item.commissionRate) : ''); 
            };

            const cancelEdit = () => {
                setEditingId(null);
                setEditName('');
                setEditPrices({});
                setEditCommission('');
            };

            const saveEdit = () => {
                const updatedData = { name: editName };
                if (activeTab === 'service') {
                    updatedData.prices = editPrices;
                } else if (activeTab === 'therapist') { 
                    updatedData.commissionRate = parseFloat(editCommission) || 0;
                }
                onEdit(activeTab, editingId, updatedData);
                setEditingId(null);
            };

            const handlePriceChange = (durationName, val, isEdit = false) => {
                const setter = isEdit ? setEditPrices : setNewItemPrices;
                const current = isEdit ? editPrices : newItemPrices;
                
                if (!val) {
                    const copy = { ...current };
                    delete copy[durationName];
                    setter(copy);
                } else {
                    setter({ ...current, [durationName]: parseFloat(val) });
                }
            };

            let currentList = [];
            let placeholderText = "";
            let icon = null;

            if (activeTab === 'therapist') {
                currentList = therapists;
                placeholderText = "Enter Therapist Name";
                icon = <Icons.Users size={18} />;
            } else if (activeTab === 'service') {
                currentList = services;
                placeholderText = "Enter Service Name (e.g. Swedish)";
                icon = <Icons.Tag size={18} />;
            } else {
                currentList = durations;
                placeholderText = "Enter Duration (e.g. 60 Mins)";
                icon = <Icons.Hourglass size={18} />;
            }

            return (
                <div className="space-y-6 fade-in">
                    <h2 className="text-lg font-bold text-logo-green-800 flex gap-2 items-center"><Icons.ShieldCheck size={18} className="text-logo-green-700"/> Master Data Lists</h2>
                    
                    {/* Tabs */}
                    <div className="flex bg-slate-100 p-1 rounded-lg">
                        <button onClick={() => setActiveTab('therapist')} className={`flex-1 py-2 text-xs font-bold rounded-md flex items-center justify-center gap-1 ${activeTab==='therapist' ? 'bg-white shadow-sm text-logo-green-700' : 'text-slate-500'}`}>
                            <Icons.Users size={14}/> Therapists
                        </button>
                        <button onClick={() => setActiveTab('duration')} className={`flex-1 py-2 text-xs font-bold rounded-md flex items-center justify-center gap-1 ${activeTab==='duration' ? 'bg-white shadow-sm text-logo-green-700' : 'text-slate-500'}`}>
                            <Icons.Clock size={14}/> Minutes
                        </button>
                        <button onClick={() => setActiveTab('service')} className={`flex-1 py-2 text-xs font-bold rounded-md flex items-center justify-center gap-1 ${activeTab==='service' ? 'bg-white shadow-sm text-logo-green-700' : 'text-slate-500'}`}>
                            <Icons.Sparkles size={14}/> Services
                        </button>
                    </div>

                    {/* Add New Item */}
                    <div className="bg-white rounded-xl shadow-sm border border-logo-green-100 p-6">
                        <h3 className="font-bold mb-4 flex items-center gap-2 text-sm uppercase tracking-wide text-slate-500"><Icons.Plus size={16}/> Add New {activeTab.charAt(0).toUpperCase() + activeTab.slice(1)}</h3>
                        <form onSubmit={handleFormSubmit} className="flex flex-col gap-3">
                            <div className="flex gap-2">
                                <input 
                                    required 
                                    placeholder={placeholderText} 
                                    value={newItemName} 
                                    onChange={e => setNewItemName(e.target.value)} 
                                    className="flex-1 p-3 border rounded-lg bg-slate-50 focus:ring-2 focus:ring-logo-green-500 outline-none"
                                />
                            </div>
                            
                            {/* Dynamic Price Inputs for Services */}
                            {activeTab === 'service' && (
                                <div className="bg-slate-50 p-3 rounded-lg border border-slate-200">
                                    <p className="text-xs font-bold text-slate-500 mb-2 uppercase">Set Prices per Duration (Optional)</p>
                                    {durations.length === 0 && <p className="text-xs text-red-400 italic">Add items to "Minutes" tab first to set prices.</p>}
                                    <div className="grid grid-cols-2 gap-2">
                                        {durations.map(d => (
                                            <div key={d.id} className="flex items-center gap-2 bg-white p-2 border rounded">
                                                <span className="text-xs font-bold text-slate-600 whitespace-nowrap w-16">{d.name}:</span>
                                                <input 
                                                    type="number" 
                                                    placeholder="Price"
                                                    className="w-full text-sm outline-none"
                                                    value={newItemPrices[d.name] || ''}
                                                    onChange={e => handlePriceChange(d.name, e.target.value, false)}
                                                />
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                             {/* Commission Rate Input for Therapists */}
                             {activeTab === 'therapist' && (
                                <div className="bg-slate-50 p-3 rounded-lg border border-slate-200">
                                    <label className="text-xs font-bold text-slate-500 mb-2 uppercase block">Commission Rate (%)</label>
                                    <input
                                        type="number"
                                        min="0"
                                        max="100"
                                        step="0.1"
                                        placeholder="e.g., 30 for 30%"
                                        className="w-full p-2 border rounded-lg text-sm outline-none"
                                        value={newItemCommission}
                                        onChange={e => setNewItemCommission(e.target.value)}
                                    />
                                </div>
                            )}

                            <button type="submit" className="w-full bg-logo-green-600 text-white p-3 rounded-lg font-bold hover:bg-logo-green-700 transition shadow-sm">Add to List</button>
                        </form>
                    </div>

                    {/* Current List */}
                    <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                        <div className="p-4 bg-logo-green-50 font-bold text-logo-green-800 text-sm border-b border-logo-green-100 flex justify-between items-center">
                            <span>Current {activeTab === 'duration' ? 'Durations' : activeTab + 's'} ({currentList.length})</span>
                            {icon}
                        </div>
                        
                        <div className="max-h-[400px] overflow-y-auto">
                            {currentList.length === 0 ? (
                                <p className="text-center text-slate-400 p-6 italic">No items found.</p>
                            ) : (
                                currentList.map(item => (
                                    <div key={item.id} className="p-4 border-b flex flex-col gap-2 last:border-b-0 hover:bg-slate-50">
                                        <div className="flex justify-between items-center w-full">
                                            {editingId === item.id ? (
                                                // Edit Mode Header
                                                <input 
                                                    value={editName}
                                                    onChange={e => setEditName(e.target.value)}
                                                    className="flex-1 p-2 border rounded text-sm bg-white focus:ring-2 focus:ring-logo-green-500 mr-2"
                                                />
                                            ) : (
                                                // View Mode Header
                                                <span className="text-slate-700 font-medium">{item.name}</span>
                                            )}
                                            
                                            {/* Actions */}
                                            <div className="flex gap-1">
                                                {editingId === item.id ? (
                                                    <>
                                                        <button onClick={saveEdit} className="text-logo-green-600 hover:bg-logo-green-50 p-2 rounded transition"><Icons.CheckCircle2 size={18}/></button>
                                                        <button onClick={cancelEdit} className="text-slate-400 hover:bg-slate-100 p-2 rounded transition"><Icons.X size={18}/></button>
                                                    </>
                                                ) : (
                                                    <>
                                                        <button onClick={() => startEdit(item)} className="text-slate-300 hover:text-blue-500 p-2 rounded hover:bg-blue-50 transition" title="Edit Item">
                                                            <Icons.Pencil size={16} />
                                                        </button>
                                                        <button type="button" onClick={() => onDelete(activeTab, item.id, item.name)} className="text-slate-300 hover:text-red-500 p-2 rounded hover:bg-red-50 transition" title="Delete Item">
                                                            <Icons.Trash2 size={16}/>
                                                        </button>
                                                    </>
                                                )}
                                            </div>
                                        </div>

                                        {/* Service Pricing Details (View & Edit) */}
                                        {activeTab === 'service' && (
                                            <div className="text-xs text-slate-500 w-full">
                                                {editingId === item.id ? (
                                                    <div className="grid grid-cols-2 gap-2 mt-2 bg-slate-100 p-2 rounded">
                                                        {durations.map(d => (
                                                            <div key={d.id} className="flex items-center gap-2">
                                                                <span className="font-bold w-14">{d.name}:</span>
                                                                <input 
                                                                    type="number" 
                                                                    className="w-full p-1 border rounded text-xs"
                                                                    placeholder="0"
                                                                    value={editPrices[d.name] || ''}
                                                                    onChange={e => handlePriceChange(d.name, e.target.value, true)}
                                                                />
                                                            </div>
                                                        ))}
                                                    </div>
                                                ) : (
                                                    <div className="flex flex-wrap gap-2 mt-1">
                                                        {item.prices && Object.keys(item.prices).length > 0 ? (
                                                            Object.entries(item.prices).map(([dur, price]) => (
                                                                <span key={dur} className="bg-logo-green-50 text-logo-green-700 px-2 py-0.5 rounded border border-logo-green-100">
                                                                    {dur}: <span className="font-bold">P{price}</span>
                                                                </span>
                                                            ))
                                                        ) : (
                                                            <span className="italic text-slate-300">No specific prices set</span>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                        
                                        {/* Therapist Commission Details (View & Edit) */}
                                        {activeTab === 'therapist' && (
                                            <div className="text-xs text-slate-500 w-full">
                                                {editingId === item.id ? (
                                                    <div className="mt-2 bg-slate-100 p-2 rounded flex items-center gap-2">
                                                        <span className="font-bold w-20">Rate (%):</span>
                                                        <input 
                                                            type="number" 
                                                            min="0"
                                                            max="100"
                                                            step="0.1"
                                                            className="w-full p-1 border rounded text-xs"
                                                            placeholder="0"
                                                            value={editCommission}
                                                            onChange={e => setEditCommission(e.target.value)}
                                                        />
                                                    </div>
                                                ) : (
                                                    <div className="flex flex-wrap gap-2 mt-1">
                                                        <span className="bg-teal-50 text-teal-700 px-2 py-0.5 rounded border border-teal-100 font-bold">
                                                            Commission: {item.commissionRate !== undefined ? `${item.commissionRate}%` : 'N/A'}
                                                        </span>
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                      {modal.isOpen && <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60"><div className="bg-white rounded-xl p-6 max-w-sm"><h3 className="font-bold mb-2">{modal.title}</h3><p className="mb-4 text-sm">{modal.message}</p><div className="flex gap-2 justify-end">{modal.type==='confirm'&&<button onClick={closeModal} className="px-4 py-2 text-slate-500">Cancel</button>}<button onClick={modal.onConfirm||closeModal} className={`px-4 py-2 rounded text-white ${modal.confirmColor==='red'?'bg-red-500':'bg-logo-green-600'}`}>Okay</button></div></div></div>}
                </div>
            );
        };

        // --- Admin Reset User Modal ---
        const AdminResetUserModal = ({ editUserModal, setEditUserModal, handleResetPin }) => {
            if (!editUserModal.isOpen || !editUserModal.user) return null;

            const user = editUserModal.user;
            
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 fade-in">
                    <div className="bg-white rounded-xl p-6 w-full max-w-sm">
                        <h3 className="text-xl font-bold text-logo-green-800 mb-4 flex items-center gap-2">
                            <Icons.UserCog size={24}/> Reset Staff Credentials
                        </h3>

                        <div className="bg-slate-50 p-4 rounded-lg mb-4">
                            <p className="text-xs text-slate-500 uppercase font-bold">Staff Name:</p>
                            <p className="font-bold text-slate-800 text-lg mb-2">{user.name}</p>

                            <p className="text-xs text-slate-500 uppercase font-bold">Username:</p>
                            <p className="font-mono text-logo-green-700 text-sm">@{user.username}</p>
                        </div>

                        <form onSubmit={handleResetPin} className="space-y-4">
                            <label className="block">
                                <span className="text-sm font-semibold text-slate-700 block mb-1">Set New PIN (4 Digits)</span>
                                <input
                                    required
                                    type="password"
                                    inputMode="numeric"
                                    maxLength="4"
                                    value={editUserModal.newPin}
                                    onChange={(e) => setEditUserModal({ ...editUserModal, newPin: e.target.value })}
                                    placeholder="Enter new 4-digit PIN"
                                    className="w-full p-3 border rounded-lg font-mono focus:ring-2 focus:ring-logo-green-500"
                                />
                            </label>

                            <div className="flex justify-end gap-2 pt-2">
                                <button 
                                    type="button"
                                    onClick={() => setEditUserModal({ isOpen: false, user: null, newPin: '' })} 
                                    className="px-4 py-2 text-slate-500 rounded hover:bg-slate-100"
                                >
                                    Cancel
                                </button>
                                <button 
                                    type="submit" 
                                    className="px-4 py-2 rounded text-white bg-logo-green-600 hover:bg-logo-green-700 font-bold"
                                >
                                    Reset PIN
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };


        // --- MAIN APP ---
        const App = () => {
            const [fb, setFb] = useState(null);
            const [fbUser, setFbUser] = useState(null);
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            const [dbReady, setDbReady] = useState(false);
            const [configError, setConfigError] = useState(null); 
            const [isGlobalLoading, setIsGlobalLoading] = useState(false); // NEW: Global Loading State

            const [user, setUser] = useState(null);
            const [users, setUsers] = useState([]);
            const [transactions, setTransactions] = useState([]);
            const [history, setHistory] = useState([]);
            
            // NEW: Offline Queue State
            const [offlineQueue, setOfflineQueue] = useState([]);

            // Master Lists
            const [therapistsList, setTherapistsList] = useState([]);
            const [servicesList, setServicesList] = useState([]);
            const [durationsList, setDurationsList] = useState([]);
            
            const [view, setView] = useState('dashboard');
            const [expandedHistoryId, setExpandedHistoryId] = useState(null);
            
            // Staff Accountability State
            const [showMyShift, setShowMyShift] = useState(false);

            // History Filtering State
            const [historyStartDate, setHistoryStartDate] = useState('');
            const [historyEndDate, setHistoryEndDate] = useState('');
            
            // Forms
            const [loginUsername, setLoginUsername] = useState('');
            const [loginPin, setLoginPin] = useState('');
            const [loginBranch, setLoginBranch] = useState(''); 
            
            const [newUser, setNewUser] = useState({ name: '', username: '', pin: '', role: 'staff' });
            const [profileData, setProfileData] = useState({ username: '', pin: '' });
            
            // UPDATED: Added bookingType and additionalCharge fields
            const [formData, setFormData] = useState({
                clientName: '', 
                service: '', 
                therapist: '', 
                amount: '', 
                duration: '', 
                type: 'booking', // booking, sale, expense
                bookingType: BOOKING_TYPES[0], // ⬅️ NEW: Default to In-Spa
                additionalCharge: '', // ⬅️ NEW: For Transport Fee or Extra Tip
                time: new Date().toTimeString().slice(0, 5),
                targetBranch: '',
                notes: '',
                category: '' // Used for Expense reason
            });
            const [modal, setModal] = useState({
                isOpen: false, type: 'confirm', title: '', message: '', onConfirm: null, confirmColor: 'red'
            });

            const [editUserModal, setEditUserModal] = useState({ isOpen: false, user: null, newPin: '' });

            const closeModal = () => setModal({ ...modal, isOpen: false });
            const closeEditUserModal = () => setEditUserModal({ isOpen: false, user: null, newPin: '' });


            // --- 1. INITIALIZE FIREBASE ---
            useEffect(() => {
                // Load offline queue from local storage
                const savedQueue = localStorage.getItem('spa_offline_queue');
                if (savedQueue) {
                    try {
                        setOfflineQueue(JSON.parse(savedQueue));
                    } catch (e) {
                        console.error("Failed to parse offline queue");
                    }
                }

                // Restore session from Local Storage
                const savedUser = localStorage.getItem('spa_user');
                if (savedUser) {
                    try {
                        setUser(JSON.parse(savedUser));
                    } catch (e) {
                        console.error("Failed to parse saved user", e);
                        localStorage.removeItem('spa_user');
                    }
                }

                const initFirebase = async () => {
                    if (!firebaseConfig || !firebaseConfig.projectId) {
                        setConfigError("Firebase configuration is incomplete. Please check the firebaseConfig object.");
                        return;
                    }
                    
                    try {
                        if (!firebase.apps.length) {
                            firebase.initializeApp(firebaseConfig);
                        }
                        
                        const auth = firebase.auth();
                        const db = firebase.firestore();
                        const currentAppId = firebaseConfig.projectId || 'default-app-id';

                        if (initialAuthToken) {
                            await auth.signInWithCustomToken(initialAuthToken);
                        } else {
                            await auth.signInAnonymously();
                        }

                        auth.onAuthStateChanged((u) => {
                            if (u) {
                                setFbUser(u);
                                setFb({ db, auth, appId: currentAppId });
                            }
                        });
                    } catch (error) { 
                        console.error("FB Init Error:", error); 
                        
                        let msg = error.message || "Unknown connection error";
                        
                        if (error.code === 'auth/operation-not-allowed') {
                            msg = "Anonymous Authentication is DISABLED. Please go to Firebase Console -> Authentication -> Sign-in method -> Enable Anonymous.";
                        } else if (error.code === 'auth/unauthorized-domain') {
                            msg = "Domain not authorized. Go to Firebase Console -> Authentication -> Settings -> Authorized Domains and add 'vercel.app' or your custom domain.";
                        }

                        setConfigError(msg); 
                    }
                };

                setTimeout(initFirebase, 500);

                window.addEventListener('online', () => setIsOnline(true));
                window.addEventListener('offline', () => setIsOnline(false));
                return () => {
                    window.removeEventListener('online', () => setIsOnline(true));
                    window.removeEventListener('offline', () => setIsOnline(false));
                };
            }, []);

            // --- 1b. OFFLINE QUEUE PERSISTENCE & SYNC ---
            useEffect(() => {
                localStorage.setItem('spa_offline_queue', JSON.stringify(offlineQueue));
            }, [offlineQueue]);

            // Sync Logic
            useEffect(() => {
                const syncOfflineQueue = async () => {
                    if (isOnline && offlineQueue.length > 0 && fb) {
                        const basePath = `artifacts/${fb.appId}/public/data`;
                        const queueCopy = [...offlineQueue];
                        let syncedCount = 0;

                        setIsGlobalLoading(true);
                        try {
                            for (const item of queueCopy) {
                                // IMPORTANT: Restore serverTimestamp behavior
                                const itemPayload = {
                                    ...item,
                                    timestamp: firebase.firestore.FieldValue.serverTimestamp() 
                                };
                                // Remove local id used for keying
                                delete itemPayload.localId;

                                await fb.db.collection(`${basePath}/transactions`).add(itemPayload);
                                syncedCount++;
                            }
                            
                            // Clear queue only after success
                            setOfflineQueue([]);
                            setModal({ isOpen: true, type: 'alert', title: 'Sync Complete', message: `Successfully uploaded ${syncedCount} offline records.`, confirmColor: 'logo-green', onConfirm: closeModal });

                        } catch (error) {
                            console.error("Sync failed", error);
                            // Keep remaining items in queue if partial fail? 
                            // For simplicity, we keep all if one fails to prevent data loss, or just retry next time.
                        } finally {
                            setIsGlobalLoading(false);
                        }
                    }
                };

                syncOfflineQueue();
            }, [isOnline, fb, offlineQueue.length]);


            // --- 2. DATA SYNC (UPDATED: Lazy Loading History) ---
            
            useEffect(() => {
                if (!fb || !fbUser) return;
                const { db, appId } = fb;
                const basePath = `artifacts/${appId}/public/data`;
                
                const getCollection = (name) => db.collection(`${basePath}/${name}`);

                // Transactions (Small & Critical - Always Load)
                const unsubTrans = getCollection('transactions')
                    .onSnapshot((snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        // USE HELPER FOR SORTING
                        data.sort((a, b) => getMillis(b.timestamp) - getMillis(a.timestamp));
                        setTransactions(data);
                        setDbReady(true);
                    }, (error) => console.error("Sync Error: Transactions", error));

                // History (Removed from Global Sync for Scalability)
                // History is now loaded lazily in a separate useEffect below.

                // Users (Small - Always Load)
                const unsubUsers = getCollection('users')
                    .onSnapshot(async (snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        const userColl = getCollection('users');
                        
                        if (data.length === 0) {
                            seedDefaultUsers(db, basePath);
                            return; 
                        }

                        // Check hash updates
                        const needsUpdate = data.filter(u => u.username === 'admin' || u.username === 'morning' || u.username === 'night');
                        let shouldWait = false;
                        for (const u of needsUpdate) {
                            if (u.pin === '8888' || u.pin === '1111' || u.pin === '2222') {
                                const hashedPin = await hashPin(u.pin);
                                await userColl.doc(u.id).update({ pin: hashedPin });
                                shouldWait = true;
                            }
                        }
                        
                        if (!shouldWait) {
                            setUsers(data);
                        }

                    }, (error) => console.error("Sync Error: Users", error));

                // Therapists
                const unsubTherapists = getCollection('therapists')
                    .onSnapshot((snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setTherapistsList(data.sort((a, b) => a.name.localeCompare(b.name)));
                    }, (error) => console.error("Sync Error: Therapists", error));

                // Services
                const unsubServices = getCollection('services')
                    .onSnapshot((snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setServicesList(data.sort((a, b) => a.name.localeCompare(b.name)));
                    }, (error) => console.error("Sync Error: Services", error));

                // Durations
                const unsubDurations = getCollection('durations')
                    .onSnapshot((snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        
                        // Sort based on numeric value if possible, else string
                        setDurationsList(data.sort((a, b) => {
                            const valA = parseInt(a.name) || 0;
                            const valB = parseInt(b.name) || 0;
                            return valA - valB;
                        }));
                    }, (error) => console.error("Sync Error: Durations", error));


                return () => { 
                    unsubTrans(); 
                    // unsubHistory(); // Removed
                    unsubUsers(); 
                    unsubTherapists(); 
                    unsubServices();
                    unsubDurations();
                };
            }, [fb, fbUser]);

            // --- 2b. LAZY LOAD HISTORY (Only when View is 'history') ---
            // This prevents the app from crashing on load by avoiding fetching the massive history collection unnecessarily.
            useEffect(() => {
                // If we are not in history view, clear memory and do nothing
                if (!fb || !fbUser || view !== 'history') {
                    if (history.length > 0) setHistory([]); // Free up memory
                    return;
                }
                
                const { db, appId } = fb;
                const basePath = `artifacts/${appId}/public/data`;
                
                // No complex queries used here to maintain stability, but we now control *when* it loads.
                const unsub = db.collection(`${basePath}/history`)
                    .onSnapshot((snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        data.sort((a, b) => getMillis(b.timestamp_val) - getMillis(a.timestamp_val));
                        setHistory(data);
                    }, (error) => {
                        console.error("Sync Error: History", error);
                    });

                return () => unsub();
            }, [fb, fbUser, view]); // Re-run when view changes

            // --- 2c. REAL-TIME USER ROLE SYNC ---
            // Ensure that if the Admin changes my role while I'm logged in, I see the changes immediately.
            useEffect(() => {
                if (user && users.length > 0) {
                    const freshData = users.find(u => u.id === user.id);
                    if (freshData) {
                        // Check if relevant fields changed (role, name, username)
                        if (freshData.role !== user.role || freshData.name !== user.name || freshData.username !== user.username) {
                            const updatedUser = { ...freshData, currentBranch: user.currentBranch };
                            setUser(updatedUser);
                            localStorage.setItem('spa_user', JSON.stringify(updatedUser));
                        }
                    }
                }
            }, [users, user]);
            
            // --- 2d. PRESENCE SYSTEM (HEARTBEAT) ---
            useEffect(() => {
                if (!user || !fb) return;
                
                const updatePresence = () => {
                    const basePath = `artifacts/${fb.appId}/public/data`;
                    // ALSO Update current branch here to keep it fresh in DB
                    fb.db.collection(`${basePath}/users`).doc(user.id).update({
                        lastActive: firebase.firestore.FieldValue.serverTimestamp(),
                        currentBranch: user.currentBranch // Ensure DB knows where they are
                    }).catch(err => console.error("Presence update failed", err));
                };

                updatePresence(); // Run immediately on login/load
                const interval = setInterval(updatePresence, 60000); // Run every minute

                return () => clearInterval(interval);
            }, [user, fb]);

            // Helper: Check if a user is online (active in last 2 minutes)
            const isUserOnline = (lastActive) => {
                if (!lastActive) return false;
                const diff = Date.now() - getMillis(lastActive);
                return diff < 2 * 60 * 1000; // 2 minutes threshold
            };


            // --- 3. HELPERS ---
            
            const seedDefaultUsers = async (db, basePath) => {
                const defaults = [
                    { name: 'Owner Admin', username: 'admin', pin: '8888', role: 'admin' },
                    { name: 'Morning Rec.', username: 'morning', pin: '1111', role: 'staff' },
                    { name: 'Night Rec.', username: 'night', pin: '2222', role: 'staff' }
                ];
                const userColl = db.collection(`${basePath}/users`);
                const usersToSeed = await Promise.all(defaults.map(async u => {
                    const hashedPin = await hashPin(u.pin);
                    return { ...u, pin: hashedPin }; 
                }));
                for (const u of usersToSeed) await userColl.add(u);
            };

            useEffect(() => {
                if (view === 'profile' && user) {
                    const freshUser = users.find(u => u.id === user.id) || user;
                    setProfileData({ username: freshUser.username, pin: '' }); 
                }
            }, [view, user, users]);

            // Update form data's targetBranch when user or branch changes
            useEffect(() => {
                if (user && formData.targetBranch === '' && user.currentBranch !== 'ALL') {
                    setFormData(prev => ({ ...prev, targetBranch: user.currentBranch }));
                }
            }, [user]);

            const formatCurrency = (val) => {
                if (val === undefined || val === null || val === '') return '';
                // Handle negative display (for expenses)
                const isNegative = val < 0;
                const formatted = new Intl.NumberFormat('en-PH', { style: 'currency', currency: 'PHP' }).format(Math.abs(val));
                return isNegative ? `(${formatted})` : formatted;
            };
            
            // Updated to handle Firestore Timestamps
            const formatDate = (timestamp) => {
                const millis = getMillis(timestamp);
                if (!millis) return 'N/A';
                const date = new Date(millis);
                return date.toLocaleDateString();
            };
            
            // Filter Transactions by Branch AND My Shift Toggle
            const getFilteredData = () => {
                if (!user) return [];
                let data = transactions;

                // 1. Filter by Branch (if not ALL)
                if (user.currentBranch !== 'ALL') {
                    data = data.filter(t => t.branch === user.currentBranch);
                }

                // 2. Filter by User (if My Shift is toggled AND user is staff)
                if (showMyShift && user.role !== 'admin') {
                    data = data.filter(t => t.recordedBy === user.name);
                }
                
                return data;
            };

            const filteredTransactions = getFilteredData();

            const stats = useMemo(() => {
                const data = filteredTransactions;
                
                // Revenue is calculated only from completed sales/bookings (not expenses)
                const completedRevenue = data.filter(t => t.status === 'completed' && t.type !== 'expense').reduce((acc, curr) => {
                    // Sum the base amount AND any additional charges recorded
                    return acc + Number(curr.amount) + Number(curr.additionalCharge || 0);
                }, 0);
                
                // Calculate total expenses (which are stored as negative numbers)
                const totalExpenses = data.filter(t => t.type === 'expense').reduce((acc, curr) => acc + Math.abs(Number(curr.amount)), 0);
                
                // Pending value is calculated from pending bookings (base amount + additional charge)
                const pendingValue = data.filter(t => t.status === 'pending' && t.type !== 'expense').reduce((acc, curr) => {
                     return acc + Number(curr.amount) + Number(curr.additionalCharge || 0);
                }, 0);
                
                const totalBookings = data.filter(t => t.type === 'booking').length;
                const completedSales = data.filter(t => t.status === 'completed' && t.type !== 'expense').length;
                
                // Calculate Net Cash
                const netCash = completedRevenue - totalExpenses;

                return { 
                    totalRevenue: completedRevenue, // Total actual revenue collected (completed sales)
                    pendingValue, 
                    totalBookings, 
                    completedSales,
                    totalExpenses, // Total money paid out
                    netCash // Cash in hand (Completed Sales - Expenses)
                };
            }, [filteredTransactions]);

            // Therapist Stats by Branch
            const therapistStats = useMemo(() => {
                const grouped = {};
                
                // Only consider completed sales transactions for commission calculation
                const commissionableTransactions = filteredTransactions.filter(t => t.type !== 'expense' && t.status === 'completed');

                commissionableTransactions.forEach(t => {
                    const branch = t.branch || (user.currentBranch !== 'ALL' ? user.currentBranch : 'Unknown');
                    const name = t.therapist ? t.therapist.trim() : 'Unassigned';
                    
                    if (!name) return;

                    // Get therapist's rate from the master list
                    const therapist = therapistsList.find(th => th.name === name);
                    const rate = therapist?.commissionRate || 0; // Default to 0%

                    if (!grouped[branch]) grouped[branch] = {};
                    if (!grouped[branch][name]) grouped[branch][name] = { name, count: 0, amount: 0, commission: 0, rate };
                    
                    // Commission is calculated only on the base service amount, not the additional charge (like transpo)
                    const baseAmount = Number(t.amount); 
                    
                    grouped[branch][name].count++;
                    grouped[branch][name].amount += baseAmount;
                    // Calculate commission based on rate and base service amount
                    grouped[branch][name].commission += baseAmount * (rate / 100);
                });

                const result = {};
                Object.keys(grouped).forEach(branch => {
                    result[branch] = Object.values(grouped[branch]).sort((a, b) => b.count - a.count);
                });
                
                return result;
            }, [filteredTransactions, user, therapistsList]);
            
            // Filtered History Logic (for Admin view)
            const filteredHistory = useMemo(() => {
                let data = history;

                if (historyStartDate) {
                    const startTimestamp = new Date(historyStartDate).getTime();
                    data = data.filter(h => getMillis(h.timestamp_val) >= startTimestamp);
                }

                if (historyEndDate) {
                    const endTimestamp = new Date(historyEndDate);
                    endTimestamp.setDate(endTimestamp.getDate() + 1); 
                    const endTimestampVal = endTimestamp.getTime();
                    data = data.filter(h => getMillis(h.timestamp_val) < endTimestampVal);
                }

                return data;
            }, [history, historyStartDate, historyEndDate]);


            const downloadCSV = (record) => {
                const headers = ['Date', 'Branch', 'Time', 'Booking Type', 'Client Name / Description', 'Service / Category', 'Duration', 'Therapist', 'Base Amount', 'Additional Charge', 'Total Amount', 'Status', 'Recorded By', 'Notes']; // ⬅️ UPDATED: Detailed headers
                const rows = record.transactions.map(t => [
                    `"${record.date}"`, 
                    `"${t.branch || 'N/A'}"`, 
                    `"${t.time}"`, 
                    `"${t.bookingType || (t.type === 'expense' ? 'N/A' : 'In-Spa')}"`, // Booking Type
                    `"${t.clientName || t.description || ''}"`, 
                    `"${t.service || t.category || ''}"`, 
                    `"${t.duration || ''}"`, 
                    `"${t.therapist || ''}"`, 
                    // Base Amount (t.amount is negative for expense, but for sales, it's the base service price)
                    (t.type === 'expense' ? t.amount : t.amount - (t.additionalCharge || 0)), 
                    (t.type === 'expense' ? '' : t.additionalCharge || 0), // Additional Charge
                    (t.type === 'expense' ? t.amount : Number(t.amount) + Number(t.additionalCharge || 0)), // Total Amount
                    t.status, 
                    `"${t.recordedBy || 'System'}"`,
                    `"${t.notes || ''}"`
                ]);
                const csvContent = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `AtHome_Report_${record.date.replace(/,/g, '').replace(/ /g, '_')}.csv`;
                link.click();
            };


            // --- 4. ACTIONS ---

            // List Management Handlers
            const handleAddItem = async (listType, itemName, extraData = null) => {
                if (!itemName) return;

                const basePath = `artifacts/${fb.appId}/public/data`;
                let collectionName = '';
                let data = { name: itemName.trim() };
                let checkList = [];

                if (listType === 'therapist') {
                    collectionName = 'therapists';
                    checkList = therapistsList;
                    if (extraData) data = { ...data, ...extraData };
                } else if (listType === 'service') {
                    collectionName = 'services';
                    checkList = servicesList;
                    if (extraData) data.prices = extraData; 
                } else if (listType === 'duration') {
                    collectionName = 'durations';
                    checkList = durationsList;
                } else {
                    return;
                }
                
                if (checkList.some(item => item.name.toLowerCase() === itemName.trim().toLowerCase())) {
                    setModal({ isOpen: true, type: 'alert', title: 'Duplicate Item', message: `${itemName} already exists in ${listType}s.`, onConfirm: closeModal, confirmColor: 'red' });
                    return;
                }

                setIsGlobalLoading(true);
                try {
                    await fb.db.collection(`${basePath}/${collectionName}`).add(data);
                } catch (err) {
                    setModal({ isOpen: true, type: 'alert', title: 'Error', message: 'Failed to add item.', confirmColor: 'red', onConfirm: closeModal });
                } finally {
                    setIsGlobalLoading(false);
                }
            };

            const handleDeleteItem = (listType, id, name) => {
                let collectionName = '';
                if (listType === 'therapist') collectionName = 'therapists';
                else if (listType === 'service') collectionName = 'services';
                else if (listType === 'duration') collectionName = 'durations';
                else return;

                const basePath = `artifacts/${fb.appId}/public/data`;
                
                setModal({
                    isOpen: true, type: 'confirm', title: `Delete ${listType}?`, message: `Are you sure you want to permanently delete "${name}"?`, confirmColor: 'red',
                    onConfirm: async () => {
                        closeModal(); // Close confirm modal first
                        setIsGlobalLoading(true);
                        try {
                            await fb.db.collection(`${basePath}/${collectionName}`).doc(id).delete();
                        } catch (error) {
                            setModal({ isOpen: true, type: 'alert', title: 'Error', message: 'Deletion failed.', confirmColor: 'red', onConfirm: closeModal });
                        } finally {
                            setIsGlobalLoading(false);
                        }
                    }
                });
            };

            const handleEditItem = async (listType, id, updatedData) => {
                let collectionName = '';
                if (listType === 'therapist') collectionName = 'therapists';
                else if (listType === 'service') collectionName = 'services';
                else if (listType === 'duration') collectionName = 'durations';
                else return;

                const basePath = `artifacts/${fb.appId}/public/data`;
                setIsGlobalLoading(true);
                try {
                    await fb.db.collection(`${basePath}/${collectionName}`).doc(id).update(updatedData);
                    setModal({ isOpen: true, type: 'alert', title: 'Success', message: 'Item updated successfully.', onConfirm: closeModal, confirmColor: 'logo-green' });
                } catch (error) {
                    console.error("Update error:", error);
                    setModal({ isOpen: true, type: 'alert', title: 'Error', message: 'Failed to update item.', onConfirm: closeModal, confirmColor: 'red' });
                } finally {
                    setIsGlobalLoading(false);
                }
            };
            
            // History Deletion Handler (Admin Only)
            const handleDeleteHistory = (id, date) => {
                if (user?.role !== 'admin') return;

                 setModal({
                    isOpen: true, type: 'confirm', title: `Delete Report?`, message: `Are you sure you want to permanently delete the archived report for ${date}? This action cannot be undone.`, confirmColor: 'red',
                    onConfirm: async () => {
                        closeModal();
                        setIsGlobalLoading(true);
                        try {
                            const basePath = `artifacts/${fb.appId}/public/data`;
                            await fb.db.collection(`${basePath}/history`).doc(id).delete();
                        } catch (err) {
                            setModal({ isOpen: true, type: 'alert', title: 'Error', message: 'Could not delete history.', confirmColor: 'red', onConfirm: closeModal });
                        } finally {
                            setIsGlobalLoading(false);
                        }
                    }
                });
            };
            

            const handleLoginSubmit = async (e) => {
                e.preventDefault();
                if (!loginBranch) {
                    setModal({ isOpen: true, type: 'alert', title: 'Branch Required', message: 'Please select your branch location.', onConfirm: closeModal, confirmColor: 'red' });
                    return;
                }
                
                setIsGlobalLoading(true);
                try {
                    const hashedPinAttempt = await hashPin(loginPin);
                    if (!hashedPinAttempt) {
                        setModal({ isOpen: true, type: 'alert', title: 'Login Error', message: 'PIN must be at least 4 digits.', onConfirm: closeModal, confirmColor: 'red' });
                        return;
                    }

                    const found = users.find(u => u.username.toLowerCase() === loginUsername.toLowerCase() && u.pin === hashedPinAttempt);
                    
                    if (found) {
                        if (loginBranch === 'ALL' && found.username !== 'admin') {
                            setModal({ isOpen: true, type: 'alert', title: 'Access Denied', message: 'Only the Owner Admin can access the All Branches view.', onConfirm: closeModal, confirmColor: 'red' });
                            return;
                        }
                        
                        const loggedUser = { ...found, currentBranch: loginBranch };
                        
                        // UPDATE FIRESTORE WITH LOGIN BRANCH
                        const basePath = `artifacts/${fb.appId}/public/data`;
                        await fb.db.collection(`${basePath}/users`).doc(found.id).update({ 
                            currentBranch: loginBranch,
                            lastActive: firebase.firestore.FieldValue.serverTimestamp() 
                        });

                        setUser(loggedUser);
                        localStorage.setItem('spa_user', JSON.stringify(loggedUser));
                        setLoginUsername(''); setLoginPin(''); setLoginBranch(''); setView('dashboard');
                    } else {
                        setModal({ isOpen: true, type: 'alert', title: 'Login Failed', message: 'Check credentials.', onConfirm: closeModal, confirmColor: 'red' });
                    }
                } catch (err) {
                    setModal({ isOpen: true, type: 'alert', title: 'Error', message: 'Login processing error.', onConfirm: closeModal, confirmColor: 'red' });
                } finally {
                    setIsGlobalLoading(false);
                }
            };

            // HELPER: Calculate Price
            const calculatePrice = (serviceName, durationName) => {
                if (!serviceName) return '';
                
                const foundService = servicesList.find(s => s.name === serviceName);
                if (!foundService) return '';

                // 1. Try to find exact duration price
                if (durationName && foundService.prices && foundService.prices[durationName]) {
                    return foundService.prices[durationName];
                } 
                
                // 2. Fallback to base price (if any legacy price exists)
                if (foundService.price) {
                    return foundService.price;
                }

                return '';
            };

            const handleServiceChange = (serviceName) => {
                // Calculate price based on this NEW service + EXISTING duration
                const newPrice = calculatePrice(serviceName, formData.duration);
                
                setFormData({ 
                    ...formData, 
                    service: serviceName,
                    amount: newPrice 
                });
            };

            const handleDurationChange = (durationName) => {
                // Calculate price based on EXISTING service + NEW duration
                const newPrice = calculatePrice(formData.service, durationName);

                setFormData({ 
                    ...formData, 
                    duration: durationName,
                    amount: newPrice 
                });
            };

            // UPDATED: Unified submit handler for Booking/Sale/Expense
            const handleSubmit = async (e, typeOverride = null) => {
                e.preventDefault();
                const transactionType = typeOverride || formData.type;
                const transactionBranch = user.currentBranch === 'ALL' ? formData.targetBranch : user.currentBranch;

                if (user.currentBranch === 'ALL' && !formData.targetBranch) {
                    setModal({ isOpen: true, type: 'alert', title: 'Missing Branch', message: 'Please select a Target Branch.', onConfirm: closeModal, confirmColor: 'red' });
                    return;
                }

                if (transactionType === 'expense') {
                    if (!formData.amount || !formData.category || !formData.notes) {
                         setModal({ isOpen: true, type: 'alert', title: 'Missing Information', message: 'Please provide Amount, Category, and Description (Notes) for the expense.', onConfirm: closeModal, confirmColor: 'red' });
                        return;
                    }
                } else {
                    if (!formData.clientName || !formData.amount || !formData.service || !formData.therapist || !formData.bookingType) { // ⬅️ UPDATED: Added bookingType check
                        setModal({ isOpen: true, type: 'alert', title: 'Missing Information', message: 'Please ensure Client Name, Booking Type, Service, Therapist, and Price are all entered.', onConfirm: closeModal, confirmColor: 'red' });
                        return;
                    }

                    // VALIDATION: Check for conflicts (Same Therapist at Exact Same Time)
                    const allBookings = [...transactions, ...offlineQueue];
                    const isConflict = allBookings.some(t => 
                        t.therapist === formData.therapist && 
                        t.time === formData.time &&
                        t.type !== 'expense' // Don't check expenses
                    );

                    if (isConflict) {
                        setModal({ isOpen: true, type: 'alert', title: 'Booking Conflict', message: `Therapist ${formData.therapist} is already booked at ${formData.time}.`, onConfirm: closeModal, confirmColor: 'red' });
                        return;
                    }
                }
                
                let baseAmount = parseFloat(formData.amount);
                const additionalCharge = parseFloat(formData.additionalCharge) || 0; // The extra fee

                if (transactionType === 'expense') {
                    // Expenses must be stored as negative numbers for easy calculation
                    baseAmount = -Math.abs(baseAmount);
                } else {
                    // For sales, we store the BASE SERVICE PRICE in amount and the additional charge separately.
                    // This allows commission to be calculated correctly (only on base price).
                    // The client is charged: baseAmount + additionalCharge
                    baseAmount = Math.abs(baseAmount);
                }

                // Payload
                const transactionPayload = {
                    clientName: formData.clientName || formData.category, 
                    description: formData.notes, 
                    service: formData.service,
                    category: formData.category, 
                    therapist: formData.therapist,
                    amount: baseAmount, // Base service cost OR negative expense value
                    additionalCharge: transactionType === 'expense' ? 0 : additionalCharge, // Transpo/Tip is only for sales, 0 for expense
                    duration: formData.duration,
                    type: transactionType,
                    bookingType: formData.bookingType || (transactionType === 'expense' ? 'N/A' : BOOKING_TYPES[0]), // ⬅️ NEW: Include booking type
                    status: transactionType === 'expense' ? 'completed' : (transactionType === 'sale' ? 'completed' : 'pending'),
                    time: formData.time,
                    recordedBy: user.name,
                    branch: transactionBranch,
                    notes: formData.notes.trim()
                };

                // OFFLINE HANDLING
                if (!isOnline) {
                    const newOfflineItem = {
                        ...transactionPayload,
                        localId: Date.now(), 
                        timestamp: Date.now() 
                    };
                    setOfflineQueue(prev => [...prev, newOfflineItem]);
                    
                    const resetTargetBranch = user.currentBranch === 'ALL' ? transactionBranch : user.currentBranch;
                    setFormData({ 
                        clientName: '', service: '', duration: '', therapist: '', amount: '', 
                        type: 'booking', time: new Date().toTimeString().slice(0, 5), 
                        targetBranch: resetTargetBranch, notes: '', category: '', 
                        bookingType: BOOKING_TYPES[0], additionalCharge: ''
                    });

                    setModal({ isOpen: true, type: 'alert', title: 'Saved Offline', message: `${transactionType.charAt(0).toUpperCase() + transactionType.slice(1)} queued. Will sync when online.`, onConfirm: closeModal, confirmColor: 'orange' });
                    return;
                }

                // ONLINE HANDLING
                setIsGlobalLoading(true);
                try {
                    const basePath = `artifacts/${fb.appId}/public/data`;
                    await fb.db.collection(`${basePath}/transactions`).add({
                        ...transactionPayload,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    const resetTargetBranch = user.currentBranch === 'ALL' ? transactionBranch : user.currentBranch;
                    
                    setFormData({ 
                        clientName: '', service: '', duration: '', therapist: '', amount: '', 
                        type: 'booking', time: new Date().toTimeString().slice(0, 5),
                        targetBranch: resetTargetBranch, notes: '', category: '',
                        bookingType: BOOKING_TYPES[0], additionalCharge: '' // ⬅️ NEW: Reset new fields
                    });
                    
                    setModal({ isOpen: true, type: 'alert', title: 'Record Saved!', message: `${transactionType.charAt(0).toUpperCase() + transactionType.slice(1)} saved for ${transactionBranch}.`, onConfirm: closeModal, confirmColor: 'logo-green' });

                    setView('dashboard');
                } catch (error) {
                    setModal({ isOpen: true, type: 'alert', title: 'Error', message: 'Failed to save record. Please check connection.', onConfirm: closeModal, confirmColor: 'red' });
                } finally {
                    setIsGlobalLoading(false);
                }
            };

            const toggleStatus = async (t) => {
                if (t.type === 'expense') return; // Cannot toggle expense status

                const basePath = `artifacts/${fb.appId}/public/data`;
                const newStatus = t.status === 'pending' ? 'completed' : 'pending';
                // Optimistic or silent update is usually fine here, but let's wrap for safety if requested
                setIsGlobalLoading(true);
                try {
                    await fb.db.collection(`${basePath}/transactions`).doc(t.id).update({ status: newStatus });
                } catch(err) {
                    console.error("Status toggle failed");
                } finally {
                    setIsGlobalLoading(false);
                }
            };

            const requestDelete = (id) => {
                if (user?.role !== 'admin') {
                    setModal({ isOpen: true, type: 'alert', title: 'Access Denied', message: 'Only Admin can delete.', onConfirm: closeModal, confirmColor: 'red' });
                    return;
                }
                setModal({
                    isOpen: true, type: 'confirm', title: 'Delete Record?', message: 'Permanently remove from cloud?', confirmColor: 'red',
                    onConfirm: async () => {
                        closeModal();
                        setIsGlobalLoading(true);
                        try {
                            const basePath = `artifacts/${fb.appId}/public/data`;
                            await fb.db.collection(`${basePath}/transactions`).doc(id).delete();
                        } catch(err) {
                            setModal({ isOpen: true, type: 'alert', title: 'Error', message: 'Delete failed.', confirmColor: 'red', onConfirm: closeModal });
                        } finally {
                            setIsGlobalLoading(false);
                        }
                    }
                });
            };

            const requestEndDay = () => {
                if (user?.role !== 'admin') {
                    setModal({ isOpen: true, type: 'alert', title: 'Access Denied', message: 'Only Admin can close the day.', onConfirm: closeModal, confirmColor: 'red' });
                    return;
                }
                if (filteredTransactions.length === 0) {
                    setModal({ isOpen: true, type: 'alert', title: 'No Data', message: 'Nothing to save for this branch.', onConfirm: closeModal, confirmColor: 'logo-green' });
                    return;
                }

                setModal({
                    isOpen: true, type: 'confirm', title: 'Archive & Start New Day?', message: `This will MOVE all active bookings, sales, and expenses to the History tab and clear the dashboard for tomorrow. You can view and download this report in the History tab anytime.`, confirmColor: 'logo-green',
                    onConfirm: async () => {
                        closeModal();
                        setIsGlobalLoading(true);
                        try {
                            const basePath = `artifacts/${fb.appId}/public/data`;
                            const historyColl = fb.db.collection(`${basePath}/history`);
                            const transColl = fb.db.collection(`${basePath}/transactions`);

                            await historyColl.add({
                                date: new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }),
                                timestamp: new Date().toLocaleString(),
                                // SECURE: Use Server Timestamp
                                timestamp_val: firebase.firestore.FieldValue.serverTimestamp(),
                                transactions: filteredTransactions,
                                stats: stats,
                                branch: user.currentBranch,
                                closedBy: user.name
                            });

                            const deletePromises = filteredTransactions.map(t => transColl.doc(t.id).delete());
                            await Promise.all(deletePromises);

                            setView('history');
                        } catch (err) {
                            setModal({ isOpen: true, type: 'alert', title: 'Error', message: 'Failed to end day. Data preserved.', confirmColor: 'red', onConfirm: closeModal });
                        } finally {
                            setIsGlobalLoading(false);
                        }
                    }
                });
            };

            // User & Profile Handlers
            const handleAddUser = async (e) => {
                e.preventDefault();
                if (!newUser.name || !newUser.username || !newUser.pin) return;
                
                setIsGlobalLoading(true);
                try {
                    const hashedPin = await hashPin(newUser.pin);
                    if (!hashedPin) {
                        setModal({ isOpen: true, type: 'alert', title: 'Error', message: 'PIN hashing failed. Check PIN length.', onConfirm: closeModal, confirmColor: 'red' });
                        return;
                    }
                    
                    if (newUser.pin.length !== 4) {
                        setModal({ isOpen: true, type: 'alert', title: 'Policy Check', message: 'Staff and Admin PINs must be exactly 4 digits.', onConfirm: closeModal, confirmColor: 'red' });
                        return;
                    }

                    if (users.some(u => u.username.toLowerCase() === newUser.username.toLowerCase())) { 
                        setModal({ isOpen: true, type: 'alert', title: 'Username Taken', message: 'This username is already in use.', onConfirm: closeModal, confirmColor: 'red' });
                        return; 
                    }
                    
                    const basePath = `artifacts/${fb.appId}/public/data`;
                    const newUserPayload = { ...newUser, pin: hashedPin };
                    
                    // SMART ADD: Auto-tag with creator's branch if not owner/ALL
                    if (user.currentBranch !== 'ALL') {
                        newUserPayload.currentBranch = user.currentBranch;
                    }

                    await fb.db.collection(`${basePath}/users`).add(newUserPayload);
                    setNewUser({ name: '', username: '', pin: '', role: 'staff' });
                } catch(err) {
                    setModal({ isOpen: true, type: 'alert', title: 'Error', message: 'Failed to add user.', confirmColor: 'red', onConfirm: closeModal });
                } finally {
                    setIsGlobalLoading(false);
                }
            };

            const handleDeleteUser = (id) => {
                if (users.length <= 1) { 
                    setModal({ isOpen: true, type: 'alert', title: 'Action Denied', message: 'Cannot delete the last remaining user.', onConfirm: closeModal, confirmColor: 'red' });
                    return; 
                }
                setModal({ isOpen: true, type: 'confirm', title: 'Remove Staff?', message: 'Revoke access for this user?', confirmColor: 'red', onConfirm: async () => { 
                    closeModal();
                    setIsGlobalLoading(true);
                    try {
                        const basePath = `artifacts/${fb.appId}/public/data`;
                        await fb.db.collection(`${basePath}/users`).doc(id).delete(); 
                    } catch(err) {
                        setModal({ isOpen: true, type: 'alert', title: 'Error', message: 'Failed to delete user.', confirmColor: 'red', onConfirm: closeModal });
                    } finally {
                        setIsGlobalLoading(false);
                    }
                }});
            };

            // NEW: Owner Toggle Role Function
            const handleToggleRole = (targetUser) => {
                const newRole = targetUser.role === 'admin' ? 'staff' : 'admin';
                const action = newRole === 'admin' ? 'Promote' : 'Demote';
                
                setModal({
                    isOpen: true,
                    type: 'confirm',
                    title: `${action} Staff?`,
                    message: `Are you sure you want to change ${targetUser.name}'s role to ${newRole.toUpperCase()}?`,
                    confirmColor: 'logo-green',
                    onConfirm: async () => {
                        closeModal();
                        setIsGlobalLoading(true);
                        try {
                            const basePath = `artifacts/${fb.appId}/public/data`;
                            await fb.db.collection(`${basePath}/users`).doc(targetUser.id).update({ role: newRole });
                        } catch (error) {
                            setModal({ isOpen: true, type: 'alert', title: 'Error', message: 'Failed to update role.', confirmColor: 'red', onConfirm: closeModal });
                        } finally {
                            setIsGlobalLoading(false);
                        }
                    }
                });
            };

            const handleUpdateProfile = async (e) => {
                e.preventDefault();
                
                const newPin = profileData.pin;
                const updateData = { username: profileData.username };

                setIsGlobalLoading(true);
                try {
                    if (newPin && newPin.length > 0) {
                        // Policy Check: Owner 6 digits, Staff/Admin 4 digits
                        const requiredLen = user.username === 'admin' ? 6 : 4;
                        if (newPin.length !== requiredLen) {
                             setModal({ isOpen: true, type: 'alert', title: 'Policy Check', message: `Your PIN must be exactly ${requiredLen} digits.`, onConfirm: closeModal, confirmColor: 'red' });
                             return;
                        }

                        const hashedPin = await hashPin(newPin);
                        if (!hashedPin) {
                            setModal({ isOpen: true, type: 'alert', title: 'Error', message: 'New PIN hashing failed. Check PIN length.', onConfirm: closeModal, confirmColor: 'red' });
                            return;
                        }
                        updateData.pin = hashedPin;
                    }

                    if (users.some(u => u.username.toLowerCase() === profileData.username.toLowerCase() && u.id !== user.id)) { 
                        setModal({ isOpen: true, type: 'alert', title: 'Username Taken', message: 'This username is already in use by another staff.', onConfirm: closeModal, confirmColor: 'red' });
                        return; 
                    }
                    
                    const basePath = `artifacts/${fb.appId}/public/data`;
                    await fb.db.collection(`${basePath}/users`).doc(user.id).update(updateData);
                    
                    const updatedUser = { ...user, ...updateData };
                    setUser(updatedUser);
                    localStorage.setItem('spa_user', JSON.stringify(updatedUser)); // NEW: Update local storage too
                    setModal({ isOpen: true, type: 'alert', title: 'Updated', message: 'Credentials synced.', onConfirm: closeModal, confirmColor: 'logo-green' });
                } catch (err) {
                    setModal({ isOpen: true, type: 'alert', title: 'Error', message: 'Failed to update profile.', confirmColor: 'red', onConfirm: closeModal });
                } finally {
                    setIsGlobalLoading(false);
                }
            };
            
            const handleResetPin = async (e) => {
                e.preventDefault();
                const targetUser = editUserModal.user;
                const newPin = editUserModal.newPin;

                if (newPin.length !== 4) {
                    setModal({ isOpen: true, type: 'alert', title: 'PIN Error', message: 'Staff/Admin PIN must be exactly 4 digits.', onConfirm: closeModal, confirmColor: 'red' });
                    return;
                }
                
                setIsGlobalLoading(true);
                try {
                    const hashedPin = await hashPin(newPin);
                    if (!hashedPin) {
                        setModal({ isOpen: true, type: 'alert', title: 'Error', message: 'PIN hashing failed.', onConfirm: closeModal, confirmColor: 'red' });
                        return;
                    }

                    const basePath = `artifacts/${fb.appId}/public/data`;
                    await fb.db.collection(`${basePath}/users`).doc(targetUser.id).update({ pin: hashedPin });
                    
                    // Close modal and show success
                    setEditUserModal({ isOpen: false, user: null, newPin: '' });
                    setModal({ isOpen: true, type: 'alert', title: 'Success', message: `${targetUser.name}'s PIN has been reset.`, onConfirm: closeModal, confirmColor: 'logo-green' });
                } catch (error) {
                    setModal({ isOpen: true, type: 'alert', title: 'Error', message: 'Failed to update PIN: ' + error.message, onConfirm: closeModal, confirmColor: 'red' });
                } finally {
                    setIsGlobalLoading(false);
                }
            };

            // --- RENDER ---

            if (configError) return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-slate-100 text-center p-4">
                    <div className="bg-white p-8 rounded-xl shadow-lg max-w-md">
                        <Icons.Cloud size={48} className="mx-auto text-slate-400 mb-4"/>
                        <h2 className="text-xl font-bold text-slate-800 mb-2">Setup Failed</h2>
                        <p className="text-slate-500 text-sm mb-6 font-mono bg-slate-50 p-2 rounded border text-left text-xs">{configError}</p>
                        <p className="text-xs text-slate-400">
                            Check: 
                            <ol className="list-decimal text-left pl-6 mt-2 space-y-1">
                                <li>Did you create the Firestore Database?</li>
                                <li>Did you enable Anonymous Authentication?</li>
                                <li>Did you add the Vercel domain to Authorized Domains?</li>
                            </ol>
                        </p>
                    </div>
                </div>
            );

            if (!dbReady) return <div className="min-h-screen flex flex-col items-center justify-center bg-slate-50"><div className="loader mb-4"></div><p className="text-slate-400 text-sm">Connecting to Spa Cloud...</p></div>;

            // LOGIN SCREEN
            if (!user) {
                return (
                    <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-6 fade-in relative">
                        <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm border border-logo-green-100 text-center relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-logo-green-700 to-teal-600"></div>
                            <div className="w-20 h-20 bg-logo-green-50 rounded-full flex items-center justify-center mx-auto mb-6 shadow-sm border border-logo-green-100">
                                {/* Logo replaced with icon */}
                                <Icons.Lock size={32} className="text-logo-green-700" />
                            </div>
                            <h1 className="text-2xl font-bold text-logo-green-900 mb-1">At HOME Massage & Spa</h1>
                            <p className="text-slate-500 mb-6 text-sm">Staff Portal</p>
                            
                            <form onSubmit={handleLoginSubmit} className="space-y-4">
                                <div className="relative">
                                    <Icons.MapPin size={18} className="absolute left-3 top-3.5 text-slate-400" />
                                    <select required value={loginBranch} onChange={(e)=>setLoginBranch(e.target.value)} className="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-logo-green-700 bg-slate-50 focus:bg-white appearance-none text-slate-600">
                                        <option value="" disabled>Select Branch Location</option>
                                        {BRANCHES.map(b => <option key={b} value={b}>{b}</option>)}
                                        <option value="ALL" className="font-bold text-logo-green-700">ALL BRANCHES (Owner View)</option>
                                    </select>
                                    <Icons.ChevronDown size={16} className="absolute right-3 top-4 text-slate-400 pointer-events-none"/>
                                </div>
                                <div className="relative"><Icons.User size={18} className="absolute left-3 top-3.5 text-slate-400" /><input required value={loginUsername} onChange={(e)=>setLoginUsername(e.target.value)} placeholder="Username" className="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-logo-green-700 bg-slate-50 focus:bg-white" /></div>
                                <div className="relative"><Icons.Fingerprint size={18} className="absolute left-3 top-3.5 text-slate-400" /><input required type="password" inputMode="numeric" value={loginPin} onChange={(e)=>setLoginPin(e.target.value)} placeholder="PIN" className="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-logo-green-700 bg-slate-50 focus:bg-white" /></div>
                                <button className="w-full bg-logo-green-700 text-white font-bold py-3 rounded-xl hover:bg-logo-green-600 transition-all shadow-lg shadow-logo-green-200 mt-2">Login</button>
                            </form>
                            {!isOnline && <p className="mt-4 text-xs text-red-400 flex items-center justify-center gap-1"><Icons.WifiOff size={12}/> You are offline</p>}
                        </div>
                        {modal.isOpen && <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60"><div className="bg-white rounded-xl p-6 max-w-sm"><h3 className="font-bold mb-2">{modal.title}</h3><p className="mb-4 text-sm">{modal.message}</p><div className="flex gap-2 justify-end">{modal.type==='confirm'&&<button onClick={closeModal} className="px-4 py-2 text-slate-500">Cancel</button>}<button onClick={modal.onConfirm||closeModal} className={`px-4 py-2 rounded text-white ${modal.confirmColor==='red'?'bg-red-500':'bg-logo-green-600'}`}>Okay</button></div></div></div>}
                        {isGlobalLoading && <LoadingOverlay message="Verifying..." />}
                    </div>
                );
            }

            // DASHBOARD
            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-800 pb-24 relative fade-in">
                    <header className="bg-white border-b border-logo-green-100 sticky top-0 z-20 shadow-sm">
                        <div className="max-w-3xl mx-auto px-4 py-3 flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                {/* Logo replaced with icon */}
                                <div className={`p-2 rounded-lg shadow-md ${user.role==='admin'?'bg-logo-green-700 shadow-logo-green-200':'bg-slate-600 shadow-slate-200'}`}><Icons.Home size={22} className="text-white"/></div>
                                <div>
                                    <h1 className="text-lg font-bold text-logo-green-800 leading-tight">At HOME Massage & Spa</h1>
                                    <div className="flex items-center gap-2 text-[10px] font-bold uppercase tracking-wide text-slate-500">
                                        <span className="bg-logo-green-100 text-logo-green-700 px-2 py-0.5 rounded flex items-center gap-1"><Icons.MapPin size={10}/> {user.currentBranch}</span>
                                        <span className="flex items-center gap-1"><Icons.UserCircle2 size={10}/> {user.name}</span>
                                        {offlineQueue.length > 0 && (
                                            <span className="bg-orange-100 text-orange-600 px-2 py-0.5 rounded flex items-center gap-1 animate-pulse">
                                                <Icons.WifiOff size={10}/> {offlineQueue.length} Pending
                                            </span>
                                        )}
                                    </div>
                                </div>
                            </div>
                            <button onClick={()=>{
                                setUser(null);
                                localStorage.removeItem('spa_user');
                                setView('dashboard');
                            }} className="p-2 text-slate-400 hover:text-red-500 rounded-lg"><Icons.LogOut size={20}/></button>
                        </div>
                        {!isOnline && <div className="bg-red-500 text-white text-xs text-center py-1">No Internet - Sync Paused</div>}
                    </header>

                    <main className="max-w-3xl mx-auto px-4 py-6">
                        <div className="flex p-1 bg-slate-200/60 rounded-xl mb-6 sticky top-[70px] z-10 backdrop-blur-sm overflow-x-auto">
                            <button onClick={()=>setView('dashboard')} className={`flex-1 min-w-[70px] py-2.5 text-xs font-semibold rounded-lg flex flex-col sm:flex-row items-center justify-center gap-1 ${view==='dashboard'?'bg-white text-logo-green-700 shadow-sm':'text-slate-500'}`}><Icons.LayoutDashboard size={16}/> Daily</button>
                            <button onClick={()=>setView('add')} className={`flex-1 min-w-[70px] py-2.5 text-xs font-semibold rounded-lg flex flex-col sm:flex-row items-center justify-center gap-1 ${view==='add'?'bg-white text-logo-green-700 shadow-sm':'text-slate-500'}`}><Icons.Plus size={16}/> Booking</button>
                            <button onClick={()=>setView('expense')} className={`flex-1 min-w-[70px] py-2.5 text-xs font-semibold rounded-lg flex flex-col sm:flex-row items-center justify-center gap-1 ${view==='expense'?'bg-white text-logo-green-700 shadow-sm':'text-slate-500'}`}><Icons.MinusCircle size={16}/> Expense</button>
                            <button onClick={()=>setView('profile')} className={`flex-1 min-w-[70px] py-2.5 text-xs font-semibold rounded-lg flex flex-col sm:flex-row items-center justify-center gap-1 ${view==='profile'?'bg-white text-logo-green-700 shadow-sm':'text-slate-500'}`}><Icons.UserCog size={16}/> Profile</button>
                            {user.role === 'admin' && (
                                <>
                                    <button onClick={()=>setView('lists')} className={`flex-1 min-w-[70px] py-2.5 text-xs font-semibold rounded-lg flex flex-col sm:flex-row items-center justify-center gap-1 ${view==='lists'?'bg-white text-logo-green-700 shadow-sm':'text-slate-500'}`}><Icons.ShieldCheck size={16}/> Lists</button>
                                    <button onClick={()=>setView('history')} className={`flex-1 min-w-[70px] py-2.5 text-xs font-semibold rounded-lg flex flex-col sm:flex-row items-center justify-center gap-1 ${view==='history'?'bg-white text-logo-green-700 shadow-sm':'text-slate-500'}`}><Icons.History size={16}/> History</button>
                                    <button onClick={()=>setView('team')} className={`flex-1 min-w-[70px] py-2.5 text-xs font-semibold rounded-lg flex flex-col sm:flex-row items-center justify-center gap-1 ${view==='team'?'bg-white text-logo-green-700 shadow-sm':'text-slate-500'} relative`}>
                                        <Icons.Users size={16}/> Team
                                        {/* Badge on Navigation Tab */}
                                        {(() => {
                                            if (user.username !== 'admin') return null;
                                            const count = users.filter(u => isUserOnline(u.lastActive)).length;
                                            return count > 0 ? <span className="absolute -top-1 -right-1 bg-green-500 text-white text-[9px] font-bold w-4 h-4 flex items-center justify-center rounded-full border border-white animate-pulse">{count}</span> : null;
                                        })()}
                                    </button>
                                </>
                            )}
                        </div>

                        {view === 'dashboard' && (
                            <div className="space-y-6 fade-in">
                                <div className="grid grid-cols-3 gap-3">
                                    <div className="bg-white p-4 rounded-xl shadow-sm border border-logo-green-100"><p className="text-slate-500 text-xs font-medium uppercase">Sales (Completed)</p><h3 className="text-xl font-bold text-slate-800 mt-1">{formatCurrency(stats.totalRevenue)}</h3></div>
                                    <div className="bg-white p-4 rounded-xl shadow-sm border border-logo-green-100"><p className="text-slate-500 text-xs font-medium uppercase">Expenses</p><h3 className="text-xl font-bold text-slate-800 mt-1 text-red-600">{formatCurrency(stats.totalExpenses)}</h3></div>
                                    <div className="bg-white p-4 rounded-xl shadow-sm border border-logo-green-100 border-l-[3px] border-logo-green-500"><p className="text-slate-500 text-xs font-medium uppercase flex items-center gap-1"><Icons.Wallet size={12}/> Net Cash</p><h3 className="text-xl font-bold text-logo-green-700 mt-1">{formatCurrency(stats.netCash)}</h3></div>
                                </div>
                                <div className="bg-white p-4 rounded-xl shadow-sm border border-logo-green-100">
                                    <h3 className="text-sm font-bold text-slate-500 uppercase tracking-wider mb-4 flex items-center gap-2"><Icons.Trophy size={16} className="text-logo-green-700"/> Payroll Estimate ({user.currentBranch})</h3>
                                    
                                    {Object.keys(therapistStats).length === 0 ? (
                                        <p className="text-sm text-slate-400 italic text-center py-2">No completed activity yet.</p>
                                    ) : (
                                        Object.keys(therapistStats).sort((a, b) => {
                                             const idxA = BRANCHES.indexOf(a);
                                             const idxB = BRANCHES.indexOf(b);
                                             if (idxA === -1 && idxB === -1) return a.localeCompare(b);
                                             if (idxA === -1) return 1;
                                             if (idxB === -1) return -1;
                                             return idxA - idxB;
                                         }).map(branch => (
                                            <div key={branch} className="mb-4 last:mb-0">
                                                {(user.currentBranch === 'ALL' || Object.keys(therapistStats).length > 1) && (
                                                    <h4 className="text-[10px] font-bold text-logo-green-700 uppercase mb-2 bg-logo-green-50 px-2 py-1 rounded inline-block">
                                                        {branch}
                                                    </h4>
                                                )}
                                                <div className="space-y-2">
                                                    {therapistStats[branch].map((s) => (
                                                        <div key={s.name} className="flex justify-between items-center pb-2 border-b border-slate-50 last:border-0 last:pb-0 ml-1">
                                                            <div className="flex gap-2 items-center">
                                                                <span className="w-6 h-6 bg-logo-green-100 text-logo-green-700 rounded-full flex items-center justify-center text-[10px] font-bold">{s.name.charAt(0)}</span>
                                                                <span className="text-sm font-semibold text-slate-700">{s.name}</span>
                                                            </div>
                                                            <div className="text-right flex flex-col">
                                                                <span className="text-sm font-bold text-logo-green-700 flex items-center gap-1">
                                                                    <Icons.TrendingUp size={12} className="text-teal-600"/> {formatCurrency(s.commission)} 
                                                                </span>
                                                                <span className="text-[9px] text-slate-400">({s.rate}% of {formatCurrency(s.amount)})</span>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>

                                <div>
                                    <div className="flex justify-between items-center mb-4">
                                        <h2 className="text-lg font-bold text-logo-green-900 flex gap-2">
                                            <Icons.LayoutDashboard size={18}/> Live Records ({showMyShift ? 'My Shift' : user.currentBranch})
                                        </h2>
                                        <div className="flex items-center gap-2">
                                            {user.role !== 'admin' && (
                                                <button 
                                                    onClick={() => setShowMyShift(!showMyShift)}
                                                    className={`text-[10px] font-bold ${showMyShift ? 'bg-logo-green-700 text-white' : 'bg-logo-green-50 text-logo-green-700'} px-3 py-1.5 rounded-full border border-logo-green-200 flex gap-1 items-center transition-colors`}
                                                >
                                                    <Icons.User size={12}/> {showMyShift ? 'Showing My Shift' : 'Show Only Mine'}
                                                </button>
                                            )}
                                            {user.role === 'admin' && (
                                                <button onClick={requestEndDay} className="text-[10px] font-bold text-logo-green-700 bg-logo-green-50 px-3 py-1.5 rounded-full border border-logo-green-200 flex gap-1"><Icons.Archive size={12}/> End Day</button>
                                            )}
                                        </div>
                                    </div>
                                    
                                    {/* Performance Alert */}
                                    {filteredTransactions.length > 50 && (
                                        <div className="bg-orange-100 border-l-4 border-orange-500 text-orange-700 p-4 mb-4 text-sm flex justify-between items-center rounded-r shadow-sm">
                                            <span><span className="font-bold">Performance Alert:</span> You have {filteredTransactions.length} active records. End the day to archive and speed up the app.</span>
                                            {user.role === 'admin' && <button onClick={requestEndDay} className="underline font-bold hover:text-orange-900 ml-2 whitespace-nowrap">End Day Now</button>}
                                        </div>
                                    )}

                                    {filteredTransactions.length===0?<div className="text-center py-12 border border-dashed rounded-xl text-slate-400 text-sm">No records found for the current filter.</div>:
                                    <div className="space-y-3">
                                        {filteredTransactions.map(t=>(
                                            // Conditional styling based on type
                                            <div key={t.id} className={`bg-white p-4 rounded-xl border-l-[6px] flex justify-between items-start ${
                                                t.type === 'expense' ? 'border-l-red-500' : (t.status==='completed'?'border-l-logo-green-500':'border-l-orange-400')
                                            } shadow-sm`}>
                                                <div className="flex-1 pr-4">
                                                    {/* Displaying total price charged to client */}
                                                    {/* Displaying timestamp date for consistency */}
                                                    <div className="flex gap-2 mb-1 items-center">
                                                        <span className="text-[10px] font-bold bg-slate-100 px-2 rounded text-slate-500">{t.branch}</span>
                                                        <span className="text-xs font-mono text-slate-400">{formatDate(t.timestamp)} - {t.time}</span>
                                                    </div>
                                                    
                                                    {/* UPDATED: Display clientName or category */}
                                                    <h3 className={`font-bold ${t.type === 'expense' ? 'text-red-700' : 'text-slate-800'}`}>
                                                        {t.type === 'expense' ? `Expense: ${t.category}` : t.clientName}
                                                    </h3>
                                                    
                                                    <div className="text-xs text-slate-500 mt-1 flex gap-2 flex-wrap items-center">
                                                        {t.type === 'expense' ? (
                                                            <span>{t.notes}</span>
                                                        ) : (
                                                            <>
                                                                {/* ⬅️ NEW: Booking Type Badge */}
                                                                {t.bookingType === 'Home Service' && (
                                                                    <span className="bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full font-bold flex items-center gap-1">
                                                                        <Icons.Car size={10} /> Home Service
                                                                    </span>
                                                                )}
                                                                <span>{t.service}</span>
                                                                {t.duration && <span> • {t.duration}</span>}
                                                                <span> • {t.therapist}</span>
                                                            </>
                                                        )}
                                                    </div>
                                                    {t.notes && t.notes.trim() && t.type !== 'expense' && (
                                                        <div className="mt-2 text-xs bg-slate-50 p-2 rounded border border-slate-200 text-slate-700 flex items-start gap-1">
                                                            <Icons.ClipboardList size={14} className="min-w-[14px] text-logo-green-700 mt-[2px]"/>
                                                            <span className="font-medium">Notes: </span>
                                                            <span className="italic">{t.notes}</span>
                                                        </div>
                                                    )}
                                                    {/* ⬅️ NEW: Display Additional Charge Details */}
                                                    {t.type !== 'expense' && t.additionalCharge > 0 && (
                                                        <div className="mt-1 text-xs text-slate-500 flex items-center gap-1">
                                                            <Icons.DollarSign size={12}/> Base: {formatCurrency(t.amount)} + Fee: {formatCurrency(t.additionalCharge)}
                                                        </div>
                                                    )}
                                                </div>
                                                
                                                <div className="text-right min-w-[80px]">
                                                    {/* Displaying Total Amount Charged to Client */}
                                                    <div className={`font-bold text-lg ${t.type === 'expense' ? 'text-red-600' : (t.status==='completed'?'text-logo-green-700':'text-orange-600')}`}>
                                                        {t.type === 'expense' ? formatCurrency(t.amount) : formatCurrency(Number(t.amount) + Number(t.additionalCharge || 0))}
                                                    </div>
                                                    <div className="flex justify-end gap-2 mt-1">
                                                        {t.type !== 'expense' && (
                                                            <button onClick={()=>toggleStatus(t)} className={`p-1.5 rounded-full ${t.status==='completed'?'bg-logo-green-100 text-logo-green-700':'bg-orange-100 text-orange-600'}`}>
                                                                {t.status==='completed'?<Icons.CheckCircle2 size={16}/>:<Icons.DollarSign size={16}/>}
                                                            </button>
                                                        )}
                                                        {user.role==='admin'&&<button onClick={()=>requestDelete(t.id)} className="p-1.5 text-slate-300 hover:text-red-500"><Icons.Trash2 size={16}/></button>}
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>}
                                </div>
                            </div>
                        )}

                        {view === 'add' && (
                            <div className="bg-white rounded-2xl shadow-sm border border-logo-green-100 p-6 fade-in">
                                <h2 className="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2"><Icons.Plus size={24} className="text-logo-green-700"/> New Booking/Sale</h2>
                                <form onSubmit={handleSubmit} className="space-y-5">
                                    
                                    {/* Conditional Branch Selector for Owner Admin */}
                                    {user.currentBranch === 'ALL' ? (
                                        <div className="relative">
                                            <Icons.MapPin size={18} className="absolute left-3 top-3.5 text-slate-400" />
                                            <select 
                                                required 
                                                value={formData.targetBranch} 
                                                onChange={(e)=>setFormData({...formData, targetBranch:e.target.value})} 
                                                className="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-logo-green-700 bg-slate-50 focus:bg-white appearance-none text-slate-600 font-bold border-logo-green-400"
                                            >
                                                <option value="" disabled>SELECT TARGET BRANCH*</option>
                                                {BRANCHES.map(b => <option key={b} value={b}>{b}</option>)}
                                            </select>
                                            <Icons.ChevronDown size={16} className="absolute right-3 top-4 text-slate-400 pointer-events-none"/>
                                        </div>
                                    ) : (
                                        <div className="p-3 bg-logo-green-50 rounded-lg text-sm text-logo-green-800 font-medium flex items-center gap-2"><Icons.MapPin size={16}/> Adding to: {user.currentBranch}</div>
                                    )}

                                    <div className="grid grid-cols-2 gap-4">
                                        <label className={`border-2 rounded-xl p-3 flex flex-col items-center gap-2 ${formData.type==='booking'?'border-logo-green-700 bg-logo-green-50/50':'border-slate-100'}`}><input type="radio" name="type" value="booking" checked={formData.type==='booking'} onChange={(e)=>setFormData({...formData, type:e.target.value})} className="hidden"/><Icons.Calendar/><span className="text-sm font-bold">Appointment</span></label>
                                        <label className={`border-2 rounded-xl p-3 flex flex-col items-center gap-2 ${formData.type==='sale'?'border-teal-600 bg-teal-50/50':'border-slate-100'}`}><input type="radio" name="type" value="sale" checked={formData.type==='sale'} onChange={(e)=>setFormData({...formData, type:e.target.value})} className="hidden"/><Icons.DollarSign/><span className="text-sm font-bold">Direct Pay</span></label>
                                    </div>
                                    
                                    {/* ⬅️ NEW: Booking Type Selector */}
                                    <select required value={formData.bookingType} onChange={e=>setFormData({...formData, bookingType:e.target.value})} className="w-full p-3 border rounded-xl bg-slate-50 appearance-none">
                                        <option value="" disabled>Select Booking Type*</option>
                                        {BOOKING_TYPES.map(bt => <option key={bt} value={bt}>{bt}</option>)}
                                    </select>

                                    <input required placeholder="Client Name*" value={formData.clientName} onChange={e=>setFormData({...formData, clientName:e.target.value})} className="w-full p-3 border rounded-xl bg-slate-50"/>
                                    
                                    <div className="space-y-4">
                                        {/* Service Dropdown */}
                                        <select required value={formData.service} onChange={e=>handleServiceChange(e.target.value)} className="w-full p-3 border rounded-xl bg-slate-50 appearance-none">
                                            <option value="" disabled>Select Service*</option>
                                            {servicesList.map(s => <option key={s.id} value={s.name}>{s.name} {s.price ? `(${formatCurrency(s.price)})` : ''}</option>)}
                                        </select>
                                        
                                        {/* Duration Dropdown */}
                                        <select value={formData.duration} onChange={e=>handleDurationChange(e.target.value)} className="w-full p-3 border rounded-xl bg-slate-50 appearance-none">
                                            <option value="" disabled>Select Duration</option>
                                            {durationsList.map(d => <option key={d.id} value={d.name}>{d.name}</option>)}
                                        </select>

                                        {/* Therapist Dropdown */}
                                        <select required value={formData.therapist} onChange={e=>setFormData({...formData, therapist:e.target.value})} className="w-full p-3 border rounded-xl bg-slate-50 appearance-none">
                                            <option value="" disabled>Select Therapist*</option>
                                            {therapistsList.map(t => <option key={t.id} value={t.name}>{t.name}</option>)}
                                        </select>
                                    </div>
                                    
                                    {/* Service Notes Textarea */}
                                    <textarea 
                                        placeholder="Service Notes (e.g., Hard pressure, No oil on back, Client prefers quiet)" 
                                        rows="3"
                                        value={formData.notes} 
                                        onChange={e=>setFormData({...formData, notes:e.target.value})} 
                                        className="w-full p-3 border rounded-xl bg-slate-50 resize-none"
                                    />

                                    <div className="grid grid-cols-2 gap-4">
                                        {/* Base Service Price */}
                                        <input required 
                                            type="number" step="0.01" 
                                            placeholder="Base Service Price (P)*" 
                                            value={formData.amount} 
                                            onChange={e=>setFormData({...formData, amount:e.target.value})} 
                                            className="w-full p-3 border rounded-xl bg-slate-50"
                                        />
                                        {/* ⬅️ NEW: Additional Charge */}
                                        <input 
                                            type="number" step="0.01" 
                                            placeholder={formData.bookingType === 'Home Service' ? 'Transport Fee / Extra Charge (P)' : 'Additional Charge / Tip (P)'}
                                            value={formData.additionalCharge} 
                                            onChange={e=>setFormData({...formData, additionalCharge:e.target.value})} 
                                            className="w-full p-3 border rounded-xl bg-slate-50"
                                        />
                                    </div>
                                    <input type="time" value={formData.time} onChange={e=>setFormData({...formData, time:e.target.value})} className="w-full p-3 border rounded-xl bg-slate-50"/>

                                    <div className="p-3 bg-slate-100 rounded-lg text-sm font-bold text-slate-700">
                                        TOTAL CHARGED: {formatCurrency(Number(formData.amount || 0) + Number(formData.additionalCharge || 0))}
                                    </div>

                                    <button className="w-full bg-logo-green-700 text-white font-bold py-4 rounded-xl shadow-lg mt-2">Save Booking</button>
                                </form>
                            </div>
                        )}
                        
                        {/* NEW: Expense Tracking View */}
                        {view === 'expense' && (
                            <div className="bg-white rounded-2xl shadow-sm border border-red-100 p-6 fade-in">
                                {/* UPDATED: Header label */}
                                <h2 className="text-xl font-bold text-red-700 mb-6 flex items-center gap-2"><Icons.MinusCircle size={24}/> Log Expense</h2>
                                <form onSubmit={(e) => handleSubmit(e, 'expense')} className="space-y-5">
                                    
                                    {user.currentBranch === 'ALL' ? (
                                        <div className="relative">
                                            <Icons.MapPin size={18} className="absolute left-3 top-3.5 text-slate-400" />
                                            <select 
                                                required 
                                                value={formData.targetBranch} 
                                                onChange={(e)=>setFormData({...formData, targetBranch:e.target.value})} 
                                                className="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-red-700 bg-slate-50 focus:bg-white appearance-none text-slate-600 font-bold border-red-400"
                                            >
                                                <option value="" disabled>SELECT BRANCH AFFECTED*</option>
                                                {BRANCHES.map(b => <option key={b} value={b}>{b}</option>)}
                                            </select>
                                            <Icons.ChevronDown size={16} className="absolute right-3 top-4 text-slate-400 pointer-events-none"/>
                                        </div>
                                    ) : (
                                        <div className="p-3 bg-red-50 rounded-lg text-sm text-red-800 font-medium flex items-center gap-2"><Icons.MapPin size={16}/> Logging for: {user.currentBranch}</div>
                                    )}

                                    <div className="flex gap-2">
                                        <select required value={formData.category} onChange={e=>setFormData({...formData, category:e.target.value})} className="flex-1 p-3 border rounded-xl bg-slate-50 appearance-none">
                                            <option value="" disabled>Select Category*</option>
                                            <option value="Supplies">Supplies (Oil, Linens, etc.)</option>
                                            <option value="Maintenance">Maintenance/Repair</option>
                                            <option value="Utilities">Utilities Payment (Partial)</option>
                                            <option value="Food/Beverage">Staff Food/Beverage</option>
                                            <option value="Other">Other Expense</option>
                                        </select>
                                        <input type="time" value={formData.time} onChange={e=>setFormData({...formData, time:e.target.value})} className="w-[120px] p-3 border rounded-xl bg-slate-50"/>
                                    </div>
                                    
                                    <input required 
                                        type="number" step="0.01" 
                                        min="0.01"
                                        placeholder="Amount Spent (P)*" 
                                        value={formData.amount} 
                                        onChange={e=>setFormData({...formData, amount:e.target.value})} 
                                        className="w-full p-3 border rounded-xl bg-slate-50 border-red-300 font-bold"
                                    />
                                    
                                    <textarea 
                                        required
                                        placeholder="Description / Reason (e.g. Bought 1 bottle of Isopropyl Alcohol)" 
                                        rows="3"
                                        value={formData.notes} 
                                        onChange={e=>setFormData({...formData, notes:e.target.value})} 
                                        className="w-full p-3 border rounded-xl bg-slate-50 resize-none"
                                    />
                                    <button className="w-full bg-red-700 text-white font-bold py-4 rounded-xl shadow-lg mt-2 hover:bg-red-800">Submit Expense</button>
                                </form>
                            </div>
                        )}

                        {view === 'profile' && (
                            <div className="bg-white rounded-xl shadow-sm border border-logo-green-100 p-6 fade-in">
                                <h3 className="font-bold text-slate-800 mb-4 flex gap-2"><Icons.UserCog className="text-logo-green-700"/> Profile</h3>
                                <div className="bg-slate-50 p-4 rounded-xl border mb-6"><p className="text-xs text-slate-400 uppercase font-bold">Account</p><p className="font-bold text-logo-green-800 text-lg">{user.name}</p></div>
                                <form onSubmit={handleUpdateProfile} className="space-y-4">
                                    <input required value={profileData.username} onChange={e=>setProfileData({...profileData, username:e.target.value})} className="w-full p-3 border rounded-lg" placeholder="New Username"/>
                                    <input type="password" inputMode="numeric" maxLength="4" value={profileData.pin} onChange={e=>setProfileData({...profileData, pin:e.target.value})} className="w-full p-3 border rounded-lg font-mono" placeholder="New PIN (Leave blank to keep old)"/>
                                    <button className="w-full bg-logo-green-700 text-white font-bold py-3 rounded-lg">Update Credentials</button>
                                </form>
                            </div>
                        )}
                        
                        {/* Data List Management View */}
                        {view === 'lists' && user.role === 'admin' && (
                            <ListManagement 
                                therapists={therapistsList} 
                                services={servicesList}
                                durations={durationsList}
                                onAdd={handleAddItem} 
                                onDelete={handleDeleteItem}
                                onEdit={handleEditItem}
                            />
                        )}

                        {view === 'team' && user.role === 'admin' && (
                            <div className="space-y-6 fade-in">
                                <h2 className="text-lg font-bold text-logo-green-900 flex gap-2"><Icons.Users/> Manage Staff</h2>
                                <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                                    {users.filter(u => {
                                        // Owner Admin sees everyone
                                        if (user.username === 'admin') return true;

                                        // Regular Admin sees themselves
                                        if (u.id === user.id) return true;

                                        // Regular Admin sees staff/admins in their branch
                                        // We exclude the Owner ('admin') from regular views to avoid clutter
                                        if (u.username === 'admin') return false;

                                        return u.currentBranch === user.currentBranch;
                                    })
                                    .sort((a, b) => {
                                        // Sort by Online status first
                                        const aOnline = isUserOnline(a.lastActive);
                                        const bOnline = isUserOnline(b.lastActive);
                                        if (aOnline && !bOnline) return -1;
                                        if (!aOnline && bOnline) return 1;
                                        // Then by Name
                                        return a.name.localeCompare(b.name);
                                    })
                                    .map(u=>(
                                        <div 
                                            key={u.id} 
                                            className="p-4 border-b flex justify-between items-center hover:bg-slate-50 transition"
                                        >
                                            <div>
                                                <h3 className="font-bold flex items-center">
                                                    {u.name} 
                                                    {u.username === 'admin' && <span className="text-[10px] font-bold px-1.5 py-0.5 rounded bg-logo-green-100 text-logo-green-700 ml-2">OWNER</span>}
                                                    {u.username !== 'admin' && u.role === 'admin' && <span className="text-[10px] font-bold px-1.5 py-0.5 rounded bg-blue-100 text-blue-700 ml-2">ADMIN</span>}
                                                    {u.role === 'staff' && <span className="text-[10px] font-bold px-1.5 py-0.5 rounded bg-slate-100 text-slate-500 ml-2">STAFF</span>}
                                                    {/* Online Indicator */}
                                                    {isUserOnline(u.lastActive) && (
                                                        <span className="ml-2 flex items-center gap-1 text-[10px] font-bold text-green-600 bg-green-50 px-1.5 py-0.5 rounded-full border border-green-200 animate-pulse">
                                                            <span className="w-1.5 h-1.5 rounded-full bg-green-500"></span> Online
                                                        </span>
                                                    )}
                                                </h3>
                                                <p className="text-xs text-slate-400">
                                                    @{u.username} • {u.currentBranch || 'Unknown Branch'}
                                                </p>
                                            </div>
                                            <div className="flex gap-2 items-center">
                                                {/* Toggle Role Button (Owner Admin only) */}
                                                {user.username === 'admin' && u.username !== 'admin' && (
                                                    <button
                                                        onClick={(e)=>{e.stopPropagation(); handleToggleRole(u);}}
                                                        className={`p-1 rounded transition ${u.role === 'admin' ? 'text-orange-400 hover:text-orange-600 hover:bg-orange-50' : 'text-blue-400 hover:text-blue-600 hover:bg-blue-50'}`}
                                                        title={u.role === 'admin' ? "Demote to Staff" : "Promote to Admin"}
                                                    >
                                                        {u.role === 'admin' ? <Icons.User size={16}/> : <Icons.ShieldCheck size={16}/>}
                                                    </button>
                                                )}

                                                {/* Explicit View/Reset PIN button (Owner Admin only) */}
                                                {user.username === 'admin' && (
                                                    <button
                                                        onClick={(e)=>{e.stopPropagation(); setEditUserModal({ isOpen: true, user: u, newPin: '' });}}
                                                        className="text-slate-300 hover:text-logo-green-700 p-1"
                                                        title="View Username / Reset PIN"
                                                    >
                                                        <Icons.Lock size={16}/>
                                                    </button>
                                                )}

                                                {/* Delete button visible to all Admins */}
                                                {user.role === 'admin' && (
                                                    <button 
                                                        onClick={(e)=>{e.stopPropagation(); handleDeleteUser(u.id)}} 
                                                        className="text-slate-300 hover:text-red-500 p-1"
                                                        title="Delete User"
                                                    >
                                                        <Icons.Trash2 size={16}/>
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <div className="bg-white rounded-xl shadow-sm border p-6">
                                    <h3 className="font-bold mb-4">Add Staff</h3>
                                    <form onSubmit={handleAddUser} className="space-y-4">
                                        <input required placeholder="Name" value={newUser.name} onChange={e=>setNewUser({...newUser, name:e.target.value})} className="w-full p-2 border rounded"/>
                                        <input required placeholder="Username" value={newUser.username} onChange={e=>setNewUser({...newUser.username, username:e.target.value})} className="w-full p-2 border rounded"/>
                                        <div className="flex gap-2"><input required maxLength="4" placeholder="PIN (Min 4 digits)" type="password" inputMode="numeric" value={newUser.pin} onChange={e=>setNewUser({...newUser, pin:e.target.value})} className="w-full p-2 border rounded"/><select value={newUser.role} onChange={e=>setNewUser({...newUser, role:e.target.value})} className="w-full p-2 border rounded"><option value="staff">Staff</option><option value="admin">Admin</option></select></div>
                                        <button className="w-full bg-logo-green-700 text-white py-2 rounded font-bold">Add User</button>
                                    </form>
                                </div>
                            </div>
                        )}

                        {view === 'history' && user.role === 'admin' && (
                            <div className="space-y-4 fade-in">
                                <h2 className="text-lg font-bold text-logo-green-900 flex gap-2"><Icons.History/> History</h2>
                                
                                {/* Date Range Filters */}
                                <div className="bg-white p-4 rounded-xl shadow-sm border border-logo-green-100 grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="block text-xs font-medium text-slate-500 mb-1">Start Date</label>
                                        <input type="date" value={historyStartDate} onChange={(e) => setHistoryStartDate(e.target.value)} className="w-full p-2 border rounded-lg bg-slate-50 text-sm"/>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-medium text-slate-500 mb-1">End Date</label>
                                        <input type="date" value={historyEndDate} onChange={(e) => setHistoryEndDate(e.target.value)} className="w-full p-2 border rounded-lg bg-slate-50 text-sm"/>
                                    </div>
                                </div>

                                {filteredHistory.length === 0 ? (
                                    <div className="text-center py-12 border border-dashed rounded-xl text-slate-400 text-sm">No historical reports found for this period.</div>
                                ) : (
                                    filteredHistory.map(h => (
                                        <div key={h.id} className="bg-white rounded-xl shadow-sm border overflow-hidden">
                                            <div onClick={()=>setExpandedHistoryId(expandedHistoryId===h.id?null:h.id)} className="p-4 flex justify-between items-center cursor-pointer">
                                                <div><h3 className="font-bold text-slate-800">{h.date}</h3><p className="text-xs text-slate-400">{h.branch || 'Unknown'} • Closed by {h.closedBy}</p></div>
                                                <div className="flex items-center gap-4">
                                                    <button onClick={(e)=>{e.stopPropagation();downloadCSV(h)}} title="Download CSV"><Icons.Download size={20} className="text-slate-400 hover:text-logo-green-700"/></button>
                                                    <button onClick={(e)=>{e.stopPropagation();handleDeleteHistory(h.id, h.date)}} title="Delete Report"><Icons.Trash2 size={20} className="text-slate-400 hover:text-red-500"/></button>
                                                    <span className="font-bold text-logo-green-700">{formatCurrency(h.stats.netCash)}</span>
                                                    {expandedHistoryId===h.id?<Icons.ChevronUp size={20} className="text-slate-400"/>:<Icons.ChevronDown size={20} className="text-slate-400"/>}
                                                </div>
                                            </div>
                                            {expandedHistoryId===h.id && <div className="bg-slate-50 p-4 border-t text-sm">{h.transactions.map((t,i)=><div key={i} className="flex flex-col py-2 border-b last:border-0"><div className="flex justify-between"><span>{t.time} - {t.type==='expense'? t.category : t.clientName} ({t.type === 'expense' ? 'Expense' : t.service})</span><span className={`font-bold ${t.type==='expense'?'text-red-600':'text-logo-green-700'}`}>{t.type === 'expense' ? formatCurrency(t.amount) : formatCurrency(Number(t.amount) + Number(t.additionalCharge || 0))}</span></div>{t.notes && t.notes.trim() && <span className="text-xs text-slate-500 italic mt-1">Desc: {t.notes}</span>}</div>)}</div>}
                                        </div>
                                    ))
                                )}
                            </div>
                        )}

                        {/* Global Modal */}
                        {modal.isOpen && <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60"><div className="bg-white rounded-xl p-6 max-w-sm"><h3 className="font-bold mb-2">{modal.title}</h3><p className="mb-4 text-sm">{modal.message}</p><div className="flex gap-2 justify-end">{modal.type==='confirm'&&<button onClick={closeModal} className="px-4 py-2 text-slate-500">Cancel</button>}<button onClick={modal.onConfirm||closeModal} className={`px-4 py-2 rounded text-white ${modal.confirmColor==='red'?'bg-red-500':'bg-logo-green-600'}`}>Okay</button></div></div></div>}
                        
                        {/* Loading Overlay */}
                        {isGlobalLoading && <LoadingOverlay message="Processing..." />}
                    </main>
                    {view === 'dashboard' && <button onClick={()=>setView('add')} className="fixed bottom-6 right-6 bg-logo-green-700 text-white p-4 rounded-full shadow-lg hover:scale-105 transition-transform"><Icons.Plus size={28}/></button>}

                    {/* Admin Reset User Modal */}
                    <AdminResetUserModal 
                        editUserModal={editUserModal} 
                        setEditUserModal={setEditUserModal} 
                        handleResetPin={handleResetPin}
                    />
                </div>
            );
        };
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
