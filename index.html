<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>At HOME Massage & Spa Tracker</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- 3. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- 5. Firebase (Compat Version - CDN for single-file operation) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- 6. Custom Tailwind Config and Styles -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'logo-green': { 50: '#E6FFE6', 100: '#CCFFCC', 500: '#00B300', 600: '#009900', 700: '#008000', 800: '#006600', 900: '#004C00' },
                        'teal': { 600: '#008080' },
                        'red': { 50: '#FEF2F2', 100: '#FEE2E2', 500: '#EF4444', 600: '#DC2626', 700: '#B91C1C' }
                    }
                }
            }
        }
    </script>
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #008000; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        .loader-lg { width: 48px; height: 48px; border-width: 5px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- CONSTANTS ---
        const BRANCHES = ['Guadalupe', 'Mabolo', 'Talisay', 'Bacayan', 'Lapu-lapu', 'AS Fortuna'];
        
        // --- FIREBASE CONFIGURATION ---
        const MANUAL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyAKXcZwKtFBRFvGbOKd0UnQrLuOLt7wV9M",
            authDomain: "ahmas-tracker.firebaseapp.com",
            projectId: "ahmas-tracker",
            storageBucket: "ahmas-tracker.firebasestorage.app",
            messagingSenderId: "6650730194",
            appId: "1:6650730194:web:eedf9c5bcb25cfe12ebf0b",
            measurementId: "G-XW2GZJXN08"
        };
        
        const firebaseConfig = MANUAL_FIREBASE_CONFIG; 
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- ICON COMPONENT ---
        const Icon = ({ name, size = 24, className = "", ...props }) => {
            const wrapperRef = useRef(null);
            useEffect(() => {
                if (!wrapperRef.current) return;
                wrapperRef.current.innerHTML = '';
                const tempIcon = document.createElement('i');
                tempIcon.setAttribute('data-lucide', name);
                wrapperRef.current.appendChild(tempIcon);
                lucide.createIcons({ root: wrapperRef.current, nameAttr: 'data-lucide', attrs: { width: size, height: size, class: className, ...props } });
            }, [name, size, className]);
            return <span ref={wrapperRef} style={{ display: 'inline-flex', verticalAlign: 'middle' }}></span>;
        };

        const Icons = {
            LayoutDashboard: (p) => <Icon name="layout-dashboard" {...p} />,
            Plus: (p) => <Icon name="plus" {...p} />,
            DollarSign: (p) => <Icon name="dollar-sign" {...p} />,
            Calendar: (p) => <Icon name="calendar" {...p} />,
            CheckCircle2: (p) => <Icon name="check-circle-2" {...p} />,
            Clock: (p) => <Icon name="clock" {...p} />,
            Trash2: (p) => <Icon name="trash-2" {...p} />,
            Users: (p) => <Icon name="users" {...p} />,
            Sparkles: (p) => <Icon name="sparkles" {...p} />,
            Home: (p) => <Icon name="home" {...p} />,
            UserCircle2: (p) => <Icon name="user-circle-2" {...p} />,
            History: (p) => <Icon name="history" {...p} />,
            ChevronDown: (p) => <Icon name="chevron-down" {...p} />,
            ChevronUp: (p) => <Icon name="chevron-up" {...p} />,
            Archive: (p) => <Icon name="archive" {...p} />,
            AlertTriangle: (p) => <Icon name="alert-triangle" {...p} />,
            X: (p) => <Icon name="x" {...p} />,
            Download: (p) => <Icon name="download" {...p} />,
            LogOut: (p) => <Icon name="log-out" {...p} />,
            Lock: (p) => <Icon name="lock" {...p} />,
            ShieldCheck: (p) => <Icon name="shield-check" {...p} />,
            UserPlus: (p) => <Icon name="user-plus" {...p} />,
            User: (p) => <Icon name="user" {...p} />,
            Fingerprint: (p) => <Icon name="fingerprint" {...p} />,
            UserCog: (p) => <Icon name="user-cog" {...p} />,
            Cloud: (p) => <Icon name="cloud" {...p} />,
            WifiOff: (p) => <Icon name="wifi-off" {...p} />,
            Trophy: (p) => <Icon name="trophy" {...p} />,
            MapPin: (p) => <Icon name="map-pin" {...p} />,
            Tag: (p) => <Icon name="tag" {...p} />,
            Hourglass: (p) => <Icon name="hourglass" {...p} />,
            Pencil: (p) => <Icon name="pencil" {...p} />,
            Loader2: (p) => <Icon name="loader-2" {...p} />,
            Wallet: (p) => <Icon name="wallet" {...p} />,
            Receipt: (p) => <Icon name="receipt" {...p} />
        };

        // --- HELPERS ---
        const hashPin = async (pin) => {
            if (!pin || pin.length < 4) return null;
            try {
                const msgUint8 = new TextEncoder().encode(pin);
                const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            } catch (error) { return null; }
        };

        const getMillis = (ts) => {
            if (!ts) return Date.now();
            if (typeof ts === 'number') return ts;
            if (typeof ts.toMillis === 'function') return ts.toMillis();
            if (ts.seconds) return ts.seconds * 1000;
            return 0;
        };

        // --- COMPONENTS ---
        const LoadingOverlay = ({ message }) => (
            <div className="fixed inset-0 z-[60] flex items-center justify-center bg-slate-900/40 backdrop-blur-sm fade-in">
                <div className="bg-white p-6 rounded-2xl shadow-2xl flex flex-col items-center gap-4 min-w-[200px]">
                    <div className="loader loader-lg"></div>
                    <p className="text-slate-600 font-semibold text-sm animate-pulse">{message || 'Processing...'}</p>
                </div>
            </div>
        );

        const AdminResetUserModal = ({ editUserModal, setEditUserModal, handleResetPin }) => {
            if (!editUserModal.isOpen || !editUserModal.user) return null;
            const user = editUserModal.user;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 fade-in">
                    <div className="bg-white rounded-xl p-6 w-full max-w-sm">
                        <h3 className="text-xl font-bold text-logo-green-800 mb-4 flex items-center gap-2"><Icons.UserCog size={24}/> Reset Staff Credentials</h3>
                        <div className="bg-slate-50 p-4 rounded-lg mb-4">
                            <p className="text-xs text-slate-500 uppercase font-bold">Staff Name:</p><p className="font-bold text-slate-800 text-lg mb-2">{user.name}</p>
                            <p className="text-xs text-slate-500 uppercase font-bold">Username:</p><p className="font-mono text-logo-green-700 text-sm">@{user.username}</p>
                        </div>
                        <form onSubmit={handleResetPin} className="space-y-4">
                            <label className="block"><span className="text-sm font-semibold text-slate-700 block mb-1">Set New PIN (4 Digits)</span><input required type="password" inputMode="numeric" maxLength="4" value={editUserModal.newPin} onChange={(e) => setEditUserModal({ ...editUserModal, newPin: e.target.value })} placeholder="Enter new 4-digit PIN" className="w-full p-3 border rounded-lg font-mono focus:ring-2 focus:ring-logo-green-500" /></label>
                            <div className="flex justify-end gap-2 pt-2"><button type="button" onClick={() => setEditUserModal({ isOpen: false, user: null, newPin: '' })} className="px-4 py-2 text-slate-500 rounded hover:bg-slate-100">Cancel</button><button type="submit" className="px-4 py-2 rounded text-white bg-logo-green-600 hover:bg-logo-green-700 font-bold">Reset PIN</button></div>
                        </form>
                    </div>
                </div>
            );
        };

        const ListManagement = ({ therapists, services, durations, onAdd, onDelete, onEdit }) => {
            const [activeTab, setActiveTab] = useState('therapist'); 
            const [newItemName, setNewItemName] = useState('');
            const [newItemPrices, setNewItemPrices] = useState({}); 
            const [newItemCommission, setNewItemCommission] = useState('');
            const [editingId, setEditingId] = useState(null);
            const [editName, setEditName] = useState('');
            const [editPrices, setEditPrices] = useState({});
            const [editCommission, setEditCommission] = useState('');
            const [modal, setModal] = useState({ isOpen: false, type: 'confirm', title: '', message: '', onConfirm: null, confirmColor: 'red' });
            const closeModal = () => setModal({ ...modal, isOpen: false });
            
            const handleFormSubmit = (e) => { e.preventDefault(); let extraData = null; if (activeTab === 'service') extraData = newItemPrices; if (activeTab === 'therapist') extraData = newItemCommission; onAdd(activeTab, newItemName, extraData); setNewItemName(''); setNewItemPrices({}); setNewItemCommission(''); };
            const startEdit = (item) => { setEditingId(item.id); setEditName(item.name); setEditPrices(item.prices || {}); setEditCommission(item.commission || ''); };
            const cancelEdit = () => { setEditingId(null); setEditName(''); setEditPrices({}); setEditCommission(''); };
            const saveEdit = () => { const updatedData = { name: editName }; if (activeTab === 'service') updatedData.prices = editPrices; if (activeTab === 'therapist') updatedData.commission = editCommission; onEdit(activeTab, editingId, updatedData); setEditingId(null); };
            const handlePriceChange = (dName, val, isEdit) => { const setter = isEdit ? setEditPrices : setNewItemPrices; const current = isEdit ? editPrices : newItemPrices; if (!val) { const copy = { ...current }; delete copy[dName]; setter(copy); } else { setter({ ...current, [dName]: parseFloat(val) }); } };

            let currentList = [], placeholderText = "", icon = null;
            if (activeTab === 'therapist') { currentList = therapists; placeholderText = "Enter Therapist Name"; icon = <Icons.Users size={18} />; }
            else if (activeTab === 'service') { currentList = services; placeholderText = "Enter Service Name"; icon = <Icons.Tag size={18} />; }
            else { currentList = durations; placeholderText = "Enter Duration"; icon = <Icons.Hourglass size={18} />; }

            return (
                <div className="space-y-6 fade-in">
                    <h2 className="text-lg font-bold text-logo-green-800 flex gap-2 items-center"><Icons.ShieldCheck size={18} className="text-logo-green-700"/> Master Data Lists</h2>
                    <div className="flex bg-slate-100 p-1 rounded-lg">
                        <button onClick={() => setActiveTab('therapist')} className={`flex-1 py-2 text-xs font-bold rounded-md flex items-center justify-center gap-1 ${activeTab==='therapist' ? 'bg-white shadow-sm text-logo-green-700' : 'text-slate-500'}`}><Icons.Users size={14}/> Therapists</button>
                        <button onClick={() => setActiveTab('duration')} className={`flex-1 py-2 text-xs font-bold rounded-md flex items-center justify-center gap-1 ${activeTab==='duration' ? 'bg-white shadow-sm text-logo-green-700' : 'text-slate-500'}`}><Icons.Clock size={14}/> Minutes</button>
                        <button onClick={() => setActiveTab('service')} className={`flex-1 py-2 text-xs font-bold rounded-md flex items-center justify-center gap-1 ${activeTab==='service' ? 'bg-white shadow-sm text-logo-green-700' : 'text-slate-500'}`}><Icons.Sparkles size={14}/> Services</button>
                    </div>
                    <div className="bg-white rounded-xl shadow-sm border border-logo-green-100 p-6">
                        <h3 className="font-bold mb-4 flex items-center gap-2 text-sm uppercase tracking-wide text-slate-500"><Icons.Plus size={16}/> Add New {activeTab.charAt(0).toUpperCase() + activeTab.slice(1)}</h3>
                        <form onSubmit={handleFormSubmit} className="flex flex-col gap-3">
                            <div className="flex gap-2">
                                <input required placeholder={placeholderText} value={newItemName} onChange={e => setNewItemName(e.target.value)} className="flex-1 p-3 border rounded-lg bg-slate-50 focus:ring-2 focus:ring-logo-green-500 outline-none"/>
                                {activeTab === 'therapist' && <input type="number" placeholder="Comm %" value={newItemCommission} onChange={e => setNewItemCommission(e.target.value)} className="w-24 p-3 border rounded-lg bg-slate-50 focus:ring-2 focus:ring-logo-green-500 outline-none"/>}
                            </div>
                            {activeTab === 'service' && (
                                <div className="bg-slate-50 p-3 rounded-lg border border-slate-200">
                                    <p className="text-xs font-bold text-slate-500 mb-2 uppercase">Set Prices per Duration (Optional)</p>
                                    {durations.length === 0 && <p className="text-xs text-red-400 italic">Add items to "Minutes" tab first.</p>}
                                    <div className="grid grid-cols-2 gap-2">{durations.map(d => (<div key={d.id} className="flex items-center gap-2 bg-white p-2 border rounded"><span className="text-xs font-bold text-slate-600 whitespace-nowrap w-16">{d.name}:</span><input type="number" placeholder="Price" className="w-full text-sm outline-none" value={newItemPrices[d.name] || ''} onChange={e => handlePriceChange(d.name, e.target.value, false)}/></div>))}</div>
                                </div>
                            )}
                            <button type="submit" className="w-full bg-logo-green-600 text-white p-3 rounded-lg font-bold hover:bg-logo-green-700 transition shadow-sm">Add to List</button>
                        </form>
                    </div>
                    <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                        <div className="p-4 bg-logo-green-50 font-bold text-logo-green-800 text-sm border-b border-logo-green-100 flex justify-between items-center"><span>Current {activeTab === 'duration' ? 'Durations' : activeTab + 's'} ({currentList.length})</span>{icon}</div>
                        <div className="max-h-[400px] overflow-y-auto">
                            {currentList.length === 0 ? <p className="text-center text-slate-400 p-6 italic">No items found.</p> : currentList.map(item => (
                                <div key={item.id} className="p-4 border-b flex flex-col gap-2 last:border-b-0 hover:bg-slate-50">
                                    <div className="flex justify-between items-center w-full">
                                        {editingId === item.id ? (
                                            <div className="flex gap-2 flex-1 mr-2">
                                                <input value={editName} onChange={e => setEditName(e.target.value)} className="flex-1 p-2 border rounded text-sm bg-white focus:ring-2 focus:ring-logo-green-500"/>
                                                {activeTab === 'therapist' && <input type="number" placeholder="%" value={editCommission} onChange={e => setEditCommission(e.target.value)} className="w-16 p-2 border rounded text-sm bg-white focus:ring-2 focus:ring-logo-green-500"/>}
                                            </div>
                                        ) : <span className="text-slate-700 font-medium">{item.name}{item.commission && activeTab === 'therapist' && <span className="ml-2 text-xs bg-blue-100 text-blue-600 px-1.5 py-0.5 rounded">{item.commission}%</span>}</span>}
                                        <div className="flex gap-1">
                                            {editingId === item.id ? <><button onClick={saveEdit} className="text-logo-green-600 hover:bg-logo-green-50 p-2 rounded"><Icons.CheckCircle2 size={18}/></button><button onClick={cancelEdit} className="text-slate-400 hover:bg-slate-100 p-2 rounded"><Icons.X size={18}/></button></> : <><button onClick={() => startEdit(item)} className="text-slate-300 hover:text-blue-500 p-2 rounded hover:bg-blue-50"><Icons.Pencil size={16} /></button><button type="button" onClick={() => onDelete(activeTab, item.id, item.name)} className="text-slate-300 hover:text-red-500 p-2 rounded hover:bg-red-50"><Icons.Trash2 size={16}/></button></>}
                                        </div>
                                    </div>
                                    {activeTab === 'service' && <div className="text-xs text-slate-500 w-full">{editingId === item.id ? <div className="grid grid-cols-2 gap-2 mt-2 bg-slate-100 p-2 rounded">{durations.map(d => (<div key={d.id} className="flex items-center gap-2"><span className="font-bold w-14">{d.name}:</span><input type="number" className="w-full p-1 border rounded text-xs" placeholder="0" value={editPrices[d.name] || ''} onChange={e => handlePriceChange(d.name, e.target.value, true)}/></div>))}</div> : <div className="flex flex-wrap gap-2 mt-1">{item.prices && Object.keys(item.prices).length > 0 ? Object.entries(item.prices).map(([dur, price]) => (<span key={dur} className="bg-logo-green-50 text-logo-green-700 px-2 py-0.5 rounded border border-logo-green-100">{dur}: <span className="font-bold">P{price}</span></span>)) : <span className="italic text-slate-300">No specific prices set</span>}</div>}</div>}
                                </div>
                            ))}
                        </div>
                    </div>
                    {modal.isOpen && <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60"><div className="bg-white rounded-xl p-6 max-w-sm"><h3 className="font-bold mb-2">{modal.title}</h3><p className="mb-4 text-sm">{modal.message}</p><div className="flex gap-2 justify-end">{modal.type==='confirm'&&<button onClick={closeModal} className="px-4 py-2 text-slate-500">Cancel</button>}<button onClick={modal.onConfirm||closeModal} className={`px-4 py-2 rounded text-white ${modal.confirmColor==='red'?'bg-red-500':'bg-logo-green-600'}`}>Okay</button></div></div></div>}
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [fb, setFb] = useState(null);
            const [fbUser, setFbUser] = useState(null);
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            const [dbReady, setDbReady] = useState(false);
            const [configError, setConfigError] = useState(null); 
            const [isGlobalLoading, setIsGlobalLoading] = useState(false);

            const [user, setUser] = useState(null);
            const [users, setUsers] = useState([]);
            const [transactions, setTransactions] = useState([]);
            const [expenses, setExpenses] = useState([]);
            const [history, setHistory] = useState([]);
            const [offlineQueue, setOfflineQueue] = useState([]);

            const [therapistsList, setTherapistsList] = useState([]);
            const [servicesList, setServicesList] = useState([]);
            const [durationsList, setDurationsList] = useState([]);
            
            const [view, setView] = useState('dashboard');
            const [expandedHistoryId, setExpandedHistoryId] = useState(null);
            const [showMyShift, setShowMyShift] = useState(false);
            const [historyStartDate, setHistoryStartDate] = useState('');
            const [historyEndDate, setHistoryEndDate] = useState('');
            
            const [loginUsername, setLoginUsername] = useState('');
            const [loginPin, setLoginPin] = useState('');
            const [loginBranch, setLoginBranch] = useState(''); 
            
            const [newUser, setNewUser] = useState({ name: '', username: '', pin: '', role: 'staff' });
            const [profileData, setProfileData] = useState({ username: '', pin: '' });
            const [formData, setFormData] = useState({ clientName: '', service: '', therapist: '', amount: '', duration: '', type: 'booking', time: new Date().toTimeString().slice(0, 5), targetBranch: '' });
            const [expenseForm, setExpenseForm] = useState({ description: '', amount: '', targetBranch: '' });

            const [modal, setModal] = useState({ isOpen: false, type: 'confirm', title: '', message: '', onConfirm: null, confirmColor: 'red' });
            const [editUserModal, setEditUserModal] = useState({ isOpen: false, user: null, newPin: '' });

            const closeModal = () => setModal({ ...modal, isOpen: false });
            const closeEditUserModal = () => setEditUserModal({ isOpen: false, user: null, newPin: '' });

            // --- Helper: Check if user is online (Defined inside App to use in render) ---
            const isUserOnline = (lastActive) => {
                if (!lastActive) return false;
                const diff = Date.now() - getMillis(lastActive);
                return diff < 2 * 60 * 1000; // 2 minutes threshold
            };

            // --- 1. INITIALIZE ---
            useEffect(() => {
                const savedQueue = localStorage.getItem('spa_offline_queue');
                if (savedQueue) { try { setOfflineQueue(JSON.parse(savedQueue)); } catch (e) { console.error("Queue parse fail"); } }
                const savedUser = localStorage.getItem('spa_user');
                if (savedUser) { try { setUser(JSON.parse(savedUser)); } catch (e) { localStorage.removeItem('spa_user'); } }

                const initFirebase = async () => {
                    if (!firebaseConfig || !firebaseConfig.projectId) { setConfigError("Firebase config incomplete."); return; }
                    try {
                        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                        const auth = firebase.auth();
                        const db = firebase.firestore();
                        const currentAppId = firebaseConfig.projectId || 'default-app-id';
                        if (initialAuthToken) await auth.signInWithCustomToken(initialAuthToken); else await auth.signInAnonymously();
                        auth.onAuthStateChanged((u) => { if (u) { setFbUser(u); setFb({ db, auth, appId: currentAppId }); } });
                    } catch (error) { console.error("FB Init Error:", error); setConfigError("Connection Error. Check Config."); }
                };
                setTimeout(initFirebase, 500);
                window.addEventListener('online', () => setIsOnline(true)); window.addEventListener('offline', () => setIsOnline(false));
                return () => { window.removeEventListener('online', () => setIsOnline(true)); window.removeEventListener('offline', () => setIsOnline(false)); };
            }, []);

            // --- SYNC LOGIC ---
            useEffect(() => { localStorage.setItem('spa_offline_queue', JSON.stringify(offlineQueue)); }, [offlineQueue]);
            useEffect(() => {
                const syncOfflineQueue = async () => {
                    if (isOnline && offlineQueue.length > 0 && fb) {
                        const basePath = `artifacts/${fb.appId}/public/data`;
                        let syncedCount = 0;
                        setIsGlobalLoading(true);
                        try {
                            for (const item of [...offlineQueue]) {
                                const col = item.collectionType || 'transactions';
                                const payload = { ...item, timestamp: firebase.firestore.FieldValue.serverTimestamp() };
                                delete payload.localId; delete payload.collectionType;
                                await fb.db.collection(`${basePath}/${col}`).add(payload);
                                syncedCount++;
                            }
                            setOfflineQueue([]);
                            setModal({ isOpen: true, type: 'alert', title: 'Sync Complete', message: `Uploaded ${syncedCount} items.`, confirmColor: 'logo-green', onConfirm: closeModal });
                        } catch (error) { console.error("Sync failed", error); } finally { setIsGlobalLoading(false); }
                    }
                };
                syncOfflineQueue();
            }, [isOnline, fb, offlineQueue.length]);

            // --- DATA SYNC ---
            useEffect(() => {
                if (!fb || !fbUser) return;
                const { db, appId } = fb;
                const basePath = `artifacts/${appId}/public/data`;
                const getCollection = (name) => db.collection(`${basePath}/${name}`);

                const unsubTrans = getCollection('transactions').onSnapshot(s => { setTransactions(s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => getMillis(b.timestamp) - getMillis(a.timestamp))); setDbReady(true); });
                const unsubExp = getCollection('expenses').onSnapshot(s => setExpenses(s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => getMillis(b.timestamp) - getMillis(a.timestamp))));
                const unsubUsers = getCollection('users').onSnapshot(async (s) => {
                    const d = s.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (d.length === 0) seedDefaultUsers(db, basePath);
                    setUsers(d);
                });
                const unsubTherapists = getCollection('therapists').onSnapshot(s => setTherapistsList(s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => a.name.localeCompare(b.name))));
                const unsubServices = getCollection('services').onSnapshot(s => setServicesList(s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => a.name.localeCompare(b.name))));
                const unsubDurations = getCollection('durations').onSnapshot(s => setDurationsList(s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => (parseInt(a.name) || 0) - (parseInt(b.name) || 0))));

                return () => { unsubTrans(); unsubExp(); unsubUsers(); unsubTherapists(); unsubServices(); unsubDurations(); };
            }, [fb, fbUser]);

            useEffect(() => {
                if (!fb || !fbUser || view !== 'history') { if (history.length > 0) setHistory([]); return; }
                const unsub = fb.db.collection(`artifacts/${fb.appId}/public/data/history`).onSnapshot(s => setHistory(s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => getMillis(b.timestamp_val) - getMillis(a.timestamp_val))));
                return () => unsub();
            }, [fb, fbUser, view]);

            // --- USER & PRESENCE ---
            useEffect(() => {
                if (user && users.length > 0) {
                    const fresh = users.find(u => u.id === user.id);
                    if (fresh && (fresh.role !== user.role || fresh.name !== user.name)) {
                        const updated = { ...fresh, currentBranch: user.currentBranch };
                        setUser(updated); localStorage.setItem('spa_user', JSON.stringify(updated));
                    }
                }
            }, [users, user]);
            
            useEffect(() => {
                if (!user || !fb) return;
                const ping = () => fb.db.collection(`artifacts/${fb.appId}/public/data/users`).doc(user.id).update({ lastActive: firebase.firestore.FieldValue.serverTimestamp(), currentBranch: user.currentBranch }).catch(e => console.error("Ping fail", e));
                ping();
                const int = setInterval(ping, 60000);
                return () => clearInterval(int);
            }, [user, fb]);

            // --- DATA HELPERS ---
            const seedDefaultUsers = async (db, basePath) => { const u = [{name:'Owner Admin',username:'admin',pin:'8888',role:'admin'},{name:'Morning Rec.',username:'morning',pin:'1111',role:'staff'},{name:'Night Rec.',username:'night',pin:'2222',role:'staff'}]; for(const x of u){ const h=await hashPin(x.pin); await db.collection(`${basePath}/users`).add({...x, pin:h}); } };
            useEffect(() => { if (view === 'profile' && user) setProfileData({ username: user.username, pin: '' }); }, [view, user]);
            useEffect(() => { if (user && formData.targetBranch === '' && user.currentBranch !== 'ALL') setFormData(prev => ({ ...prev, targetBranch: user.currentBranch })); }, [user]);
            useEffect(() => { if (user && expenseForm.targetBranch === '' && user.currentBranch !== 'ALL') setExpenseForm(prev => ({ ...prev, targetBranch: user.currentBranch })); }, [user]);

            const formatCurrency = (v) => new Intl.NumberFormat('en-PH', { style: 'currency', currency: 'PHP' }).format(v || 0);
            const formatDate = (ts) => { const m = getMillis(ts); return m ? new Date(m).toLocaleDateString() : 'N/A'; };
            
            const getFilteredData = (data, isTx) => {
                if (!user) return [];
                let d = data;
                if (user.currentBranch !== 'ALL') d = d.filter(x => x.branch === user.currentBranch);
                if (showMyShift && user.role !== 'admin' && isTx) d = d.filter(x => x.recordedBy === user.name);
                return d;
            };

            const filteredTransactions = getFilteredData(transactions, true);
            const filteredExpenses = getFilteredData(expenses, false);

            const stats = useMemo(() => {
                const s = filteredTransactions.filter(t => t.status === 'completed').reduce((a, c) => a + Number(c.amount), 0);
                const p = filteredTransactions.filter(t => t.status === 'pending').reduce((a, c) => a + Number(c.amount), 0);
                const e = filteredExpenses.reduce((a, c) => a + Number(c.amount), 0);
                return { totalRevenue: s, pendingValue: p, totalExpenses: e, netCash: s - e };
            }, [filteredTransactions, filteredExpenses]);

            const therapistStats = useMemo(() => {
                const g = {};
                filteredTransactions.forEach(t => {
                    const b = t.branch || (user.currentBranch!=='ALL'?user.currentBranch:'Unknown');
                    const n = t.therapist ? t.therapist.trim() : 'Unassigned';
                    if (!n) return;
                    if (!g[b]) g[b] = {};
                    if (!g[b][n]) g[b][n] = { name: n, count: 0, amount: 0 };
                    g[b][n].count++; g[b][n].amount += Number(t.amount);
                });
                const r = {}; Object.keys(g).forEach(b => { r[b] = Object.values(g[b]).sort((a, x) => x.count - a.count); });
                return r;
            }, [filteredTransactions, user]);
            
            const filteredHistory = useMemo(() => {
                let d = history;
                if (historyStartDate) d = d.filter(h => getMillis(h.timestamp_val) >= new Date(historyStartDate).getTime());
                if (historyEndDate) { const e = new Date(historyEndDate); e.setDate(e.getDate()+1); d = d.filter(h => getMillis(h.timestamp_val) < e.getTime()); }
                return d;
            }, [history, historyStartDate, historyEndDate]);

            const downloadCSV = (r) => {
                const h = ['Date', 'Branch', 'Time', 'Type', 'Client/Desc', 'Service/Item', 'Therapist', 'Amount', 'Status', 'Recorded By'];
                const tx = r.transactions.map(t => [`"${r.date}"`, `"${t.branch||''}"`, `"${t.time}"`, '"Sale"', `"${t.clientName}"`, `"${t.service}"`, `"${t.therapist}"`, t.amount, t.status, `"${t.recordedBy||''}"`]);
                const ex = (r.expenses||[]).map(e => [`"${r.date}"`, `"${e.branch||''}"`, `"${new Date(getMillis(e.timestamp)).toLocaleTimeString()}"`, '"Expense"', `"${e.description}"`, '"-"', '"-"', -Math.abs(e.amount), '"Paid"', `"${e.recordedBy||''}"`]);
                const c = [h.join(','), ...tx.map(x=>x.join(',')), ...ex.map(x=>x.join(','))].join('\n');
                const b = new Blob([c], { type: 'text/csv;charset=utf-8;' });
                const l = document.createElement('a'); l.href = URL.createObjectURL(b); l.download = `Report_${r.date.replace(/,/g,'').replace(/ /g,'_')}.csv`; l.click();
            };

            // --- HANDLERS ---
            const handleLoginSubmit = async (e) => {
                e.preventDefault(); if(!loginBranch) return;
                setIsGlobalLoading(true);
                try {
                    const h = await hashPin(loginPin); if(!h) throw new Error();
                    const u = users.find(x => x.username.toLowerCase() === loginUsername.toLowerCase() && x.pin === h);
                    if(u) {
                        if(loginBranch==='ALL' && u.username!=='admin') { setModal({isOpen:true, type:'alert', title:'Denied', message:'Owner only.', confirmColor:'red', onConfirm:closeModal}); return; }
                        const lu = {...u, currentBranch: loginBranch};
                        await fb.db.collection(`artifacts/${fb.appId}/public/data/users`).doc(u.id).update({currentBranch:loginBranch, lastActive:firebase.firestore.FieldValue.serverTimestamp()});
                        setUser(lu); localStorage.setItem('spa_user', JSON.stringify(lu)); setLoginUsername(''); setLoginPin(''); setLoginBranch(''); setView('dashboard');
                    } else { setModal({isOpen:true, type:'alert', title:'Failed', message:'Check login.', confirmColor:'red', onConfirm:closeModal}); }
                } catch(err) { setModal({isOpen:true, type:'alert', title:'Error', message:'Login error.', confirmColor:'red', onConfirm:closeModal}); }
                finally { setIsGlobalLoading(false); }
            };

            const toggleStatus = async (t) => { await fb.db.collection(`artifacts/${fb.appId}/public/data/transactions`).doc(t.id).update({status:t.status==='pending'?'completed':'pending'}); };
            const requestDelete = (id) => { if(user.role!=='admin') return; setModal({isOpen:true, type:'confirm', title:'Delete?', message:'Sure?', confirmColor:'red', onConfirm:async()=>{await fb.db.collection(`artifacts/${fb.appId}/public/data/transactions`).doc(id).delete(); closeModal();} }); };
            
            const calculatePrice = (sName, dName) => { if(!sName) return ''; const s = servicesList.find(x=>x.name===sName); if(!s) return ''; if(dName && s.prices && s.prices[dName]) return s.prices[dName]; return s.price || ''; };
            const handleServiceChange = (v) => setFormData({...formData, service:v, amount:calculatePrice(v, formData.duration)});
            const handleDurationChange = (v) => setFormData({...formData, duration:v, amount:calculatePrice(formData.service, v)});

            const handleSubmit = async (e) => {
                e.preventDefault();
                const br = user.currentBranch==='ALL'?formData.targetBranch:user.currentBranch;
                if(!formData.clientName||!formData.amount||!formData.service||!formData.therapist) return;
                if(user.currentBranch==='ALL' && !formData.targetBranch) return;
                
                const conflict = [...transactions, ...offlineQueue.filter(x=>x.collectionType!=='expenses')].some(t => t.therapist===formData.therapist && t.time===formData.time);
                if(conflict) { setModal({isOpen:true, type:'alert', title:'Conflict', message:'Therapist busy.', confirmColor:'red', onConfirm:closeModal}); return; }
                
                const payload = { ...formData, amount:parseFloat(formData.amount), status:formData.type==='sale'?'completed':'pending', recordedBy:user.name, branch:br, collectionType:'transactions' };
                
                if(!isOnline) {
                    setOfflineQueue(prev=>[...prev, {...payload, localId:Date.now(), timestamp:Date.now()}]);
                    setFormData({clientName:'', service:'', duration:'', therapist:'', amount:'', type:'booking', time:new Date().toTimeString().slice(0,5), targetBranch:br});
                    setModal({isOpen:true, type:'alert', title:'Offline', message:'Queued.', confirmColor:'orange', onConfirm:closeModal});
                } else {
                    setIsGlobalLoading(true);
                    try {
                        delete payload.collectionType;
                        await fb.db.collection(`artifacts/${fb.appId}/public/data/transactions`).add({...payload, timestamp:firebase.firestore.FieldValue.serverTimestamp()});
                        setFormData({clientName:'', service:'', duration:'', therapist:'', amount:'', type:'booking', time:new Date().toTimeString().slice(0,5), targetBranch:br});
                        setModal({isOpen:true, type:'alert', title:'Saved', message:'Booking recorded.', confirmColor:'logo-green', onConfirm:closeModal});
                        setView('dashboard');
                    } catch(e) { setModal({isOpen:true, type:'alert', title:'Error', message:'Failed.', confirmColor:'red', onConfirm:closeModal}); }
                    finally { setIsGlobalLoading(false); }
                }
            };

            const handleExpenseSubmit = async (e) => {
                e.preventDefault();
                const br = user.currentBranch==='ALL'?expenseForm.targetBranch:user.currentBranch;
                if(!expenseForm.description||!expenseForm.amount) return;
                if(user.currentBranch==='ALL'&&!expenseForm.targetBranch) return;
                
                const payload = { description:expenseForm.description, amount:parseFloat(expenseForm.amount), recordedBy:user.name, branch:br, collectionType:'expenses' };
                
                if(!isOnline) {
                    setOfflineQueue(prev=>[...prev, {...payload, localId:Date.now(), timestamp:Date.now()}]);
                    setExpenseForm({description:'', amount:'', targetBranch:br});
                    setModal({isOpen:true, type:'alert', title:'Offline', message:'Expense queued.', confirmColor:'orange', onConfirm:closeModal});
                } else {
                    setIsGlobalLoading(true);
                    try {
                        delete payload.collectionType;
                        await fb.db.collection(`artifacts/${fb.appId}/public/data/expenses`).add({...payload, timestamp:firebase.firestore.FieldValue.serverTimestamp()});
                        setExpenseForm({description:'', amount:'', targetBranch:br});
                        setModal({isOpen:true, type:'alert', title:'Saved', message:'Expense recorded.', confirmColor:'logo-green', onConfirm:closeModal});
                        setView('dashboard');
                    } catch(e) { setModal({isOpen:true, type:'alert', title:'Error', message:'Failed.', confirmColor:'red', onConfirm:closeModal}); }
                    finally { setIsGlobalLoading(false); }
                }
            };
            const handleDeleteExpense = (id) => { if(user.role!=='admin') return; setModal({isOpen:true, type:'confirm', title:'Delete?', message:'Sure?', confirmColor:'red', onConfirm:async()=>{await fb.db.collection(`artifacts/${fb.appId}/public/data/expenses`).doc(id).delete(); closeModal();} }); };

            const requestEndDay = () => {
                if(user.role!=='admin') return;
                if(filteredTransactions.length===0 && filteredExpenses.length===0) { setModal({isOpen:true, type:'alert', title:'Empty', message:'No data.', confirmColor:'logo-green', onConfirm:closeModal}); return; }
                setModal({isOpen:true, type:'confirm', title:'End Day?', message:'Archive all data?', confirmColor:'logo-green', onConfirm:async()=>{
                    closeModal(); setIsGlobalLoading(true);
                    try {
                        const bp = `artifacts/${fb.appId}/public/data`;
                        await fb.db.collection(`${bp}/history`).add({
                            date: new Date().toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' }),
                            timestamp: new Date().toLocaleString(), timestamp_val: firebase.firestore.FieldValue.serverTimestamp(),
                            transactions: filteredTransactions, expenses: filteredExpenses, stats: stats, branch: user.currentBranch, closedBy: user.name
                        });
                        await Promise.all([...filteredTransactions.map(t=>fb.db.collection(`${bp}/transactions`).doc(t.id).delete()), ...filteredExpenses.map(e=>fb.db.collection(`${bp}/expenses`).doc(e.id).delete())]);
                        setView('history');
                    } catch(e) { setModal({isOpen:true, type:'alert', title:'Error', message:'Archive failed.', confirmColor:'red', onConfirm:closeModal}); }
                    finally { setIsGlobalLoading(false); }
                }});
            };

            // User Mgmt
            const handleAddUser = async (e) => {
                e.preventDefault(); if(!newUser.name||!newUser.username||!newUser.pin) return;
                setIsGlobalLoading(true);
                try {
                    const h = await hashPin(newUser.pin);
                    if(newUser.pin.length!==4) throw new Error('4digit');
                    if(users.some(u=>u.username===newUser.username)) throw new Error('taken');
                    const p = { ...newUser, pin: h }; if(user.currentBranch!=='ALL') p.currentBranch=user.currentBranch;
                    await fb.db.collection(`artifacts/${fb.appId}/public/data/users`).add(p);
                    setNewUser({name:'', username:'', pin:'', role:'staff'});
                } catch(err) { setModal({isOpen:true, type:'alert', title:'Error', message:err.message==='4digit'?'PIN must be 4 digits.':'Failed to add user.', confirmColor:'red', onConfirm:closeModal}); }
                finally { setIsGlobalLoading(false); }
            };
            const handleDeleteUser = (id) => { if(users.length<=1) return; setModal({isOpen:true, type:'confirm', title:'Delete?', message:'Sure?', confirmColor:'red', onConfirm:async()=>{await fb.db.collection(`artifacts/${fb.appId}/public/data/users`).doc(id).delete(); closeModal();} }); };
            const handleToggleRole = (u) => { const nr = u.role==='admin'?'staff':'admin'; setModal({isOpen:true, type:'confirm', title:'Change Role?', message:`Make ${nr.toUpperCase()}?`, confirmColor:'logo-green', onConfirm:async()=>{await fb.db.collection(`artifacts/${fb.appId}/public/data/users`).doc(u.id).update({role:nr}); closeModal();} }); };
            const handleResetPin = async (e) => {
                e.preventDefault(); if(editUserModal.newPin.length!==4) return;
                setIsGlobalLoading(true);
                try { const h = await hashPin(editUserModal.newPin); await fb.db.collection(`artifacts/${fb.appId}/public/data/users`).doc(editUserModal.user.id).update({pin:h}); closeModal(); closeEditUserModal(); setModal({isOpen:true, type:'alert', title:'Success', message:'PIN Reset.', confirmColor:'logo-green', onConfirm:closeModal}); }
                catch(e) { setModal({isOpen:true, type:'alert', title:'Error', message:'Failed.', confirmColor:'red', onConfirm:closeModal}); } finally { setIsGlobalLoading(false); }
            };
            const handleUpdateProfile = async (e) => {
                e.preventDefault(); setIsGlobalLoading(true);
                try {
                    const d = {username:profileData.username};
                    if(profileData.pin) {
                        const len = user.username==='admin'?6:4; if(profileData.pin.length!==len) throw new Error();
                        d.pin = await hashPin(profileData.pin);
                    }
                    if(users.some(u=>u.username===profileData.username && u.id!==user.id)) throw new Error();
                    await fb.db.collection(`artifacts/${fb.appId}/public/data/users`).doc(user.id).update(d);
                    const nu = {...user, ...d}; setUser(nu); localStorage.setItem('spa_user', JSON.stringify(nu));
                    setModal({isOpen:true, type:'alert', title:'Updated', message:'Profile saved.', confirmColor:'logo-green', onConfirm:closeModal});
                } catch(e) { setModal({isOpen:true, type:'alert', title:'Error', message:'Update failed. Check PIN length/Username.', confirmColor:'red', onConfirm:closeModal}); }
                finally { setIsGlobalLoading(false); }
            };
            const handleDeleteHistory = (id) => { setModal({isOpen:true, type:'confirm', title:'Delete Log?', message:'Forever?', confirmColor:'red', onConfirm:async()=>{await fb.db.collection(`artifacts/${fb.appId}/public/data/history`).doc(id).delete(); closeModal();} }); };

            // --- RENDER ---
            if (configError) return <div className="min-h-screen flex flex-col items-center justify-center p-4"><div className="bg-white p-8 rounded-xl shadow-lg text-center"><Icons.Cloud size={48} className="mx-auto mb-4 text-slate-400"/><h2 className="text-xl font-bold mb-2">Setup Required</h2><p className="text-xs text-slate-500">{configError}</p></div></div>;
            if (!dbReady) return <div className="min-h-screen flex flex-col items-center justify-center"><div className="loader mb-4"></div></div>;

            if (!user) return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-slate-50 relative">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm text-center border-t-4 border-logo-green-600">
                        <div className="w-16 h-16 bg-logo-green-50 rounded-full flex items-center justify-center mx-auto mb-4"><Icons.Lock size={32} className="text-logo-green-700"/></div>
                        <h1 className="text-2xl font-bold text-logo-green-900 mb-1">At HOME Spa</h1>
                        <p className="text-slate-400 text-sm mb-6">Staff Portal</p>
                        <form onSubmit={handleLoginSubmit} className="space-y-4">
                            <div className="relative"><Icons.MapPin size={18} className="absolute left-3 top-3.5 text-slate-400"/><select required value={loginBranch} onChange={(e)=>setLoginBranch(e.target.value)} className="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 outline-none focus:border-logo-green-500 bg-white text-slate-600"><option value="" disabled>Branch</option>{BRANCHES.map(b=><option key={b} value={b}>{b}</option>)}<option value="ALL" className="font-bold">Owner View</option></select></div>
                            <div className="relative"><Icons.User size={18} className="absolute left-3 top-3.5 text-slate-400"/><input required value={loginUsername} onChange={(e)=>setLoginUsername(e.target.value)} placeholder="Username" className="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 outline-none focus:border-logo-green-500"/></div>
                            <div className="relative"><Icons.Fingerprint size={18} className="absolute left-3 top-3.5 text-slate-400"/><input required type="password" inputMode="numeric" value={loginPin} onChange={(e)=>setLoginPin(e.target.value)} placeholder="PIN" className="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 outline-none focus:border-logo-green-500"/></div>
                            <button className="w-full bg-logo-green-600 text-white font-bold py-3 rounded-xl shadow-lg shadow-logo-green-200 hover:bg-logo-green-700 transition">Login</button>
                        </form>
                    </div>
                    {modal.isOpen && <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60"><div className="bg-white rounded-xl p-6 max-w-sm"><h3 className="font-bold mb-2">{modal.title}</h3><p className="mb-4 text-sm">{modal.message}</p><div className="flex gap-2 justify-end">{modal.type==='confirm'&&<button onClick={closeModal} className="px-4 py-2 text-slate-500">Cancel</button>}<button onClick={modal.onConfirm||closeModal} className={`px-4 py-2 rounded text-white ${modal.confirmColor==='red'?'bg-red-500':'bg-logo-green-600'}`}>Okay</button></div></div></div>}
                    {isGlobalLoading && <LoadingOverlay message="Authenticating..." />}
                </div>
            );

            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-800 pb-24 relative fade-in">
                    <header className="bg-white border-b border-logo-green-100 sticky top-0 z-20 shadow-sm">
                        <div className="max-w-3xl mx-auto px-4 py-3 flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <div className={`p-2 rounded-lg shadow-md ${user.role==='admin'?'bg-logo-green-600':'bg-slate-600'}`}><Icons.Home size={20} className="text-white"/></div>
                                <div><h1 className="text-lg font-bold text-logo-green-800 leading-tight">At HOME Spa</h1><div className="flex items-center gap-2 text-[10px] font-bold uppercase tracking-wide text-slate-500"><span className="bg-logo-green-50 text-logo-green-700 px-2 py-0.5 rounded">{user.currentBranch}</span><span>{user.name}</span>{offlineQueue.length>0 && <span className="text-orange-500 animate-pulse">{offlineQueue.length} Offline</span>}</div></div>
                            </div>
                            <button onClick={()=>{setUser(null); localStorage.removeItem('spa_user'); setView('dashboard');}} className="p-2 text-slate-400 hover:text-red-500"><Icons.LogOut size={20}/></button>
                        </div>
                        {!isOnline && <div className="bg-red-500 text-white text-xs text-center py-1">No Internet - Sync Paused</div>}
                    </header>

                    <main className="max-w-3xl mx-auto px-4 py-6">
                        <div className="flex p-1 bg-slate-200/60 rounded-xl mb-6 sticky top-[70px] z-10 backdrop-blur-sm overflow-x-auto">
                            <button onClick={()=>setView('dashboard')} className={`flex-1 min-w-[70px] py-2.5 text-xs font-bold rounded-lg flex flex-col items-center justify-center gap-1 ${view==='dashboard'?'bg-white text-logo-green-700 shadow-sm':'text-slate-500'}`}><Icons.LayoutDashboard size={16}/> Daily</button>
                            <button onClick={()=>setView('add')} className={`flex-1 min-w-[70px] py-2.5 text-xs font-bold rounded-lg flex flex-col items-center justify-center gap-1 ${view==='add'?'bg-white text-logo-green-700 shadow-sm':'text-slate-500'}`}><Icons.Plus size={16}/> Booking</button>
                            <button onClick={()=>setView('expenses')} className={`flex-1 min-w-[70px] py-2.5 text-xs font-bold rounded-lg flex flex-col items-center justify-center gap-1 ${view==='expenses'?'bg-white text-logo-green-700 shadow-sm':'text-slate-500'}`}><Icons.Wallet size={16}/> Cost</button>
                            <button onClick={()=>setView('profile')} className={`flex-1 min-w-[70px] py-2.5 text-xs font-bold rounded-lg flex flex-col items-center justify-center gap-1 ${view==='profile'?'bg-white text-logo-green-700 shadow-sm':'text-slate-500'}`}><Icons.UserCog size={16}/> Profile</button>
                            {user.role === 'admin' && <>
                                <button onClick={()=>setView('lists')} className={`flex-1 min-w-[70px] py-2.5 text-xs font-bold rounded-lg flex flex-col items-center justify-center gap-1 ${view==='lists'?'bg-white text-logo-green-700 shadow-sm':'text-slate-500'}`}><Icons.ShieldCheck size={16}/> Lists</button>
                                <button onClick={()=>setView('team')} className={`flex-1 min-w-[70px] py-2.5 text-xs font-bold rounded-lg flex flex-col items-center justify-center gap-1 ${view==='team'?'bg-white text-logo-green-700 shadow-sm':'text-slate-500'} relative`}><Icons.Users size={16}/> Team {user.username==='admin' && users.filter(u=>isUserOnline(u.lastActive)).length>0 && <span className="absolute top-1 right-1 w-2 h-2 bg-green-500 rounded-full"></span>}</button>
                                <button onClick={()=>setView('history')} className={`flex-1 min-w-[70px] py-2.5 text-xs font-bold rounded-lg flex flex-col items-center justify-center gap-1 ${view==='history'?'bg-white text-logo-green-700 shadow-sm':'text-slate-500'}`}><Icons.History size={16}/> Logs</button>
                            </>}
                        </div>

                        {view === 'dashboard' && (
                            <div className="space-y-6 fade-in">
                                <div className="grid grid-cols-3 gap-2">
                                    <div className="bg-white p-3 rounded-xl shadow-sm border border-logo-green-100"><p className="text-slate-400 text-[10px] font-bold uppercase">Sales</p><h3 className="text-lg font-bold text-logo-green-700">{formatCurrency(stats.totalRevenue)}</h3></div>
                                    <div className="bg-white p-3 rounded-xl shadow-sm border border-red-100"><p className="text-slate-400 text-[10px] font-bold uppercase">Expenses</p><h3 className="text-lg font-bold text-red-600">{formatCurrency(stats.totalExpenses)}</h3></div>
                                    <div className={`p-3 rounded-xl shadow-sm border ${stats.netCash >= 0 ? 'bg-teal-50 border-teal-200' : 'bg-red-50 border-red-200'}`}><p className="text-slate-400 text-[10px] font-bold uppercase">Net Cash</p><h3 className={`text-lg font-bold ${stats.netCash >= 0 ? 'text-teal-700' : 'text-red-700'}`}>{formatCurrency(stats.netCash)}</h3></div>
                                </div>
                                
                                <div className="bg-white p-4 rounded-xl shadow-sm border border-logo-green-100">
                                    <h3 className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4 flex items-center gap-2"><Icons.Trophy size={14}/> Handles Today</h3>
                                    {Object.keys(therapistStats).length === 0 ? <p className="text-xs text-slate-400 italic text-center">No data.</p> : Object.keys(therapistStats).sort().map(b=>(<div key={b} className="mb-4 last:mb-0"><h4 className="text-[10px] font-bold text-logo-green-700 uppercase mb-1">{b}</h4>{therapistStats[b].map(s=>(<div key={s.name} className="flex justify-between text-sm py-1 border-b border-slate-50 last:border-0"><span>{s.name}</span><span className="font-bold text-slate-700">{s.count} <span className="text-[10px] font-normal text-slate-400">({formatCurrency(s.amount)})</span></span></div>))}</div>))}
                                </div>

                                <div>
                                    <div className="flex justify-between items-center mb-4">
                                        <h2 className="text-lg font-bold text-logo-green-900 flex gap-2"><Icons.LayoutDashboard size={18}/> Today's Bookings</h2>
                                        <div className="flex gap-2">{user.role!=='admin' && <button onClick={()=>setShowMyShift(!showMyShift)} className={`text-[10px] font-bold px-3 py-1.5 rounded-full border transition-colors ${showMyShift?'bg-logo-green-600 text-white':'bg-white text-slate-500'}`}>My Shift</button>}
                                        {user.role==='admin' && <button onClick={requestEndDay} className="text-[10px] font-bold text-white bg-logo-green-700 px-3 py-1.5 rounded-full shadow-sm hover:bg-logo-green-800">End Day</button>}</div>
                                    </div>
                                    {filteredTransactions.length===0 ? <div className="text-center py-8 border border-dashed rounded-xl text-slate-400 text-sm">No bookings yet.</div> : 
                                    <div className="space-y-3">{filteredTransactions.map(t=>(<div key={t.id} className={`bg-white p-3 rounded-xl border-l-4 shadow-sm flex justify-between items-center ${t.status==='completed'?'border-l-logo-green-500':'border-l-orange-400'}`}><div className="flex-1"><div className="flex gap-2 mb-1"><span className="text-[9px] font-bold bg-slate-100 px-1.5 rounded text-slate-500">{t.branch}</span><span className="text-[10px] font-mono text-slate-400">{formatDate(t.timestamp)} {t.time}</span></div><h4 className="font-bold text-sm">{t.clientName}</h4><p className="text-xs text-slate-500">{t.service} {t.duration && ` ${t.duration}`}  {t.therapist}</p></div><div className="text-right"><div className="font-bold text-sm">{formatCurrency(t.amount)}</div><div className="flex justify-end gap-1 mt-1"><button onClick={()=>toggleStatus(t)} className={`p-1 rounded ${t.status==='completed'?'bg-green-100 text-green-700':'bg-orange-100 text-orange-600'}`}>{t.status==='completed'?<Icons.CheckCircle2 size={14}/>:<Icons.DollarSign size={14}/>}</button>{user.role==='admin'&&<button onClick={()=>requestDelete(t.id)} className="p-1 text-slate-300 hover:text-red-500"><Icons.Trash2 size={14}/></button>}</div></div></div>))}</div>}
                                </div>
                            </div>
                        )}
                        
                        {view === 'expenses' && (
                            <div className="space-y-6 fade-in">
                                <div className="bg-white rounded-xl shadow-sm border border-red-100 p-6">
                                    <h3 className="font-bold text-red-600 mb-4 flex gap-2"><Icons.Receipt size={18}/> Log Expense</h3>
                                    <form onSubmit={handleExpenseSubmit} className="flex flex-col gap-3">
                                        {user.currentBranch === 'ALL' && (
                                            <div className="relative"><Icons.MapPin size={16} className="absolute left-3 top-3.5 text-slate-400"/><select required value={expenseForm.targetBranch} onChange={e=>setExpenseForm({...expenseForm, targetBranch:e.target.value})} className="w-full pl-9 p-3 border rounded-lg bg-slate-50 outline-none text-sm"><option value="" disabled>Branch</option>{BRANCHES.map(b=><option key={b} value={b}>{b}</option>)}</select></div>
                                        )}
                                        <input required placeholder="Description (e.g. Meals, Transpo)" value={expenseForm.description} onChange={e=>setExpenseForm({...expenseForm, description:e.target.value})} className="w-full p-3 border rounded-lg bg-slate-50 outline-none text-sm"/>
                                        <input required type="number" placeholder="Amount" value={expenseForm.amount} onChange={e=>setExpenseForm({...expenseForm, amount:e.target.value})} className="w-full p-3 border rounded-lg bg-slate-50 outline-none text-sm"/>
                                        <button className="w-full bg-red-600 text-white font-bold py-3 rounded-lg hover:bg-red-700">Record Expense</button>
                                    </form>
                                </div>
                                <div>
                                    <h3 className="font-bold text-slate-700 mb-3">Today's Expenses</h3>
                                    {filteredExpenses.length===0 ? <p className="text-center text-slate-400 text-sm py-4">No expenses recorded today.</p> : 
                                    <div className="space-y-2">{filteredExpenses.map(e=>(
                                        <div key={e.id} className="bg-white p-3 rounded-lg border-l-4 border-l-red-400 shadow-sm flex justify-between items-center">
                                            <div><p className="font-bold text-sm">{e.description}</p><p className="text-[10px] text-slate-400">{e.branch}  {e.recordedBy}</p></div>
                                            <div className="text-right"><span className="font-bold text-red-600">-{formatCurrency(e.amount)}</span>{user.role==='admin'&&<button onClick={()=>handleDeleteExpense(e.id)} className="block ml-auto mt-1 text-slate-300 hover:text-red-500"><Icons.Trash2 size={14}/></button>}</div>
                                        </div>
                                    ))}</div>}
                                </div>
                            </div>
                        )}

                        {view === 'add' && (
                            <div className="bg-white rounded-2xl shadow-sm border border-logo-green-100 p-6 fade-in">
                                <h2 className="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2"><Icons.Plus size={24} className="text-logo-green-700"/> New Booking</h2>
                                <form onSubmit={handleSubmit} className="space-y-4">
                                    {user.currentBranch === 'ALL' ? (
                                        <div className="relative"><Icons.MapPin size={18} className="absolute left-3 top-3.5 text-slate-400" /><select required value={formData.targetBranch} onChange={(e)=>setFormData({...formData, targetBranch:e.target.value})} className="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 bg-slate-50 outline-none"><option value="" disabled>SELECT TARGET BRANCH*</option>{BRANCHES.map(b => <option key={b} value={b}>{b}</option>)}</select><Icons.ChevronDown size={16} className="absolute right-3 top-4 text-slate-400 pointer-events-none"/></div>
                                    ) : <div className="p-3 bg-logo-green-50 rounded-lg text-sm text-logo-green-800 font-medium flex items-center gap-2"><Icons.MapPin size={16}/> Adding to: {user.currentBranch}</div>}
                                    <div className="grid grid-cols-2 gap-3">
                                        <label className={`border-2 rounded-xl p-3 flex flex-col items-center gap-1 cursor-pointer ${formData.type==='booking'?'border-logo-green-600 bg-logo-green-50':'border-slate-100'}`}><input type="radio" name="type" value="booking" checked={formData.type==='booking'} onChange={(e)=>setFormData({...formData, type:e.target.value})} className="hidden"/><Icons.Calendar size={18}/><span className="text-xs font-bold">Booking</span></label>
                                        <label className={`border-2 rounded-xl p-3 flex flex-col items-center gap-1 cursor-pointer ${formData.type==='sale'?'border-teal-600 bg-teal-50':'border-slate-100'}`}><input type="radio" name="type" value="sale" checked={formData.type==='sale'} onChange={(e)=>setFormData({...formData, type:e.target.value})} className="hidden"/><Icons.DollarSign size={18}/><span className="text-xs font-bold">Direct Sale</span></label>
                                    </div>
                                    <input required placeholder="Client Name*" value={formData.clientName} onChange={e=>setFormData({...formData, clientName:e.target.value})} className="w-full p-3 border rounded-xl bg-slate-50 outline-none"/>
                                    <div className="space-y-3">
                                        <select required value={formData.service} onChange={e=>handleServiceChange(e.target.value)} className="w-full p-3 border rounded-xl bg-slate-50 outline-none appearance-none"><option value="" disabled>Select Service*</option>{servicesList.map(s => <option key={s.id} value={s.name}>{s.name} {s.price ? `(${formatCurrency(s.price)})` : ''}</option>)}</select>
                                        <select value={formData.duration} onChange={e=>handleDurationChange(e.target.value)} className="w-full p-3 border rounded-xl bg-slate-50 outline-none appearance-none"><option value="" disabled>Select Duration</option>{durationsList.map(d => <option key={d.id} value={d.name}>{d.name}</option>)}</select>
                                        <select required value={formData.therapist} onChange={e=>setFormData({...formData, therapist:e.target.value})} className="w-full p-3 border rounded-xl bg-slate-50 outline-none appearance-none"><option value="" disabled>Select Therapist*</option>{therapistsList.map(t => <option key={t.id} value={t.name}>{t.name}</option>)}</select>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3"><input required type="number" step="0.01" placeholder="Price (P)*" value={formData.amount} onChange={e=>setFormData({...formData, amount:e.target.value})} className="w-full p-3 border rounded-xl bg-slate-50 outline-none"/><input type="time" value={formData.time} onChange={e=>setFormData({...formData, time:e.target.value})} className="w-full p-3 border rounded-xl bg-slate-50 outline-none"/></div>
                                    <button className="w-full bg-logo-green-700 text-white font-bold py-4 rounded-xl shadow-lg mt-2 hover:bg-logo-green-800">Save Booking</button>
                                </form>
                            </div>
                        )}

                        {view === 'profile' && <div className="bg-white rounded-xl shadow-sm border border-logo-green-100 p-6 fade-in"><h3 className="font-bold text-slate-800 mb-4 flex gap-2"><Icons.UserCog className="text-logo-green-700"/> Profile</h3><div className="bg-slate-50 p-4 rounded-xl border mb-6"><p className="text-xs text-slate-400 uppercase font-bold">Account</p><p className="font-bold text-logo-green-800 text-lg">{user.name}</p></div><form onSubmit={handleUpdateProfile} className="space-y-4"><input required value={profileData.username} onChange={e=>setProfileData({...profileData, username:e.target.value})} className="w-full p-3 border rounded-lg outline-none" placeholder="New Username"/><input type="password" inputMode="numeric" maxLength="4" value={profileData.pin} onChange={e=>setProfileData({...profileData, pin:e.target.value})} className="w-full p-3 border rounded-lg font-mono outline-none" placeholder="New PIN (Leave blank to keep old)"/><button className="w-full bg-logo-green-700 text-white font-bold py-3 rounded-lg">Update Credentials</button></form></div>}
                        
                        {/* Admin Views */}
                        {view === 'lists' && user.role === 'admin' && <ListManagement therapists={therapistsList} services={servicesList} durations={durationsList} onAdd={handleAddItem} onDelete={handleDeleteItem} onEdit={handleEditItem} />}
                        {view === 'team' && user.role === 'admin' && <div className="space-y-6 fade-in"><h2 className="text-lg font-bold text-logo-green-900 flex gap-2"><Icons.Users/> Manage Staff</h2><div className="bg-white rounded-xl shadow-sm border overflow-hidden">{users.filter(u => { if (user.username === 'admin') return true; if (u.id === user.id) return true; if (u.username === 'admin') return false; return u.currentBranch === user.currentBranch; }).sort((a, b) => { const aOnline = isUserOnline(a.lastActive); const bOnline = isUserOnline(b.lastActive); if (aOnline && !bOnline) return -1; if (!aOnline && bOnline) return 1; return a.name.localeCompare(b.name); }).map(u=>(<div key={u.id} className="p-4 border-b flex justify-between items-center hover:bg-slate-50 transition"><div><h3 className="font-bold flex items-center">{u.name} {u.username === 'admin' && <span className="text-[10px] font-bold px-1.5 py-0.5 rounded bg-logo-green-100 text-logo-green-700 ml-2">OWNER</span>}{u.username !== 'admin' && u.role === 'admin' && <span className="text-[10px] font-bold px-1.5 py-0.5 rounded bg-blue-100 text-blue-700 ml-2">ADMIN</span>}{u.role === 'staff' && <span className="text-[10px] font-bold px-1.5 py-0.5 rounded bg-slate-100 text-slate-500 ml-2">STAFF</span>}{isUserOnline(u.lastActive) && <span className="ml-2 flex items-center gap-1 text-[10px] font-bold text-green-600 bg-green-50 px-1.5 py-0.5 rounded-full border border-green-200 animate-pulse"><span className="w-1.5 h-1.5 rounded-full bg-green-500"></span> Online</span>}</h3><p className="text-xs text-slate-400">@{u.username}  {u.currentBranch || 'Unknown'}</p></div><div className="flex gap-2 items-center">{user.username === 'admin' && u.username !== 'admin' && (<button onClick={(e)=>{e.stopPropagation(); handleToggleRole(u);}} className={`p-1 rounded transition ${u.role === 'admin' ? 'text-orange-400 hover:text-orange-600 hover:bg-orange-50' : 'text-blue-400 hover:text-blue-600 hover:bg-blue-50'}`} title={u.role === 'admin' ? "Demote to Staff" : "Promote to Admin"}>{u.role === 'admin' ? <Icons.User size={16}/> : <Icons.ShieldCheck size={16}/>}</button>)}{user.username === 'admin' && (<button onClick={(e)=>{e.stopPropagation(); setEditUserModal({ isOpen: true, user: u, newPin: '' });}} className="text-slate-300 hover:text-logo-green-700 p-1" title="Reset PIN"><Icons.Lock size={16}/></button>)}{user.role === 'admin' && (<button onClick={(e)=>{e.stopPropagation(); handleDeleteUser(u.id)}} className="text-slate-300 hover:text-red-500 p-1" title="Delete User"><Icons.Trash2 size={16}/></button>)}</div></div>))}</div><div className="bg-white rounded-xl shadow-sm border p-6"><h3 className="font-bold mb-4">Add Staff</h3><form onSubmit={handleAddUser} className="space-y-4"><input required placeholder="Name" value={newUser.name} onChange={e=>setNewUser({...newUser, name:e.target.value})} className="w-full p-2 border rounded"/><input required placeholder="Username" value={newUser.username} onChange={e=>setNewUser({...newUser, username:e.target.value})} className="w-full p-2 border rounded"/><div className="flex gap-2"><input required maxLength="4" placeholder="PIN (4 digits)" type="password" inputMode="numeric" value={newUser.pin} onChange={e=>setNewUser({...newUser, pin:e.target.value})} className="w-full p-2 border rounded"/><select value={newUser.role} onChange={e=>setNewUser({...newUser, role:e.target.value})} className="w-full p-2 border rounded"><option value="staff">Staff</option><option value="admin">Admin</option></select></div><button className="w-full bg-logo-green-700 text-white py-2 rounded font-bold">Add User</button></form></div></div>}
                        
                        {view === 'history' && user.role === 'admin' && (
                            <div className="space-y-4 fade-in">
                                <h2 className="text-lg font-bold text-logo-green-900 flex gap-2"><Icons.History/> History</h2>
                                <div className="bg-white p-4 rounded-xl shadow-sm border border-logo-green-100 grid grid-cols-2 gap-3"><div><label className="block text-xs font-medium text-slate-500 mb-1">Start Date</label><input type="date" value={historyStartDate} onChange={(e) => setHistoryStartDate(e.target.value)} className="w-full p-2 border rounded-lg bg-slate-50 text-sm"/></div><div><label className="block text-xs font-medium text-slate-500 mb-1">End Date</label><input type="date" value={historyEndDate} onChange={(e) => setHistoryEndDate(e.target.value)} className="w-full p-2 border rounded-lg bg-slate-50 text-sm"/></div></div>
                                {filteredHistory.length === 0 ? <div className="text-center py-12 border border-dashed rounded-xl text-slate-400 text-sm">No historical reports.</div> : filteredHistory.map(h => (<div key={h.id} className="bg-white rounded-xl shadow-sm border overflow-hidden"><div onClick={()=>setExpandedHistoryId(expandedHistoryId===h.id?null:h.id)} className="p-4 flex justify-between items-center cursor-pointer"><div><h3 className="font-bold text-slate-800">{h.date}</h3><p className="text-xs text-slate-400">{h.branch || 'Unknown'}  Closed by {h.closedBy}</p></div><div className="flex items-center gap-4"><button onClick={(e)=>{e.stopPropagation();downloadCSV(h)}}><Icons.Download size={20} className="text-slate-400 hover:text-logo-green-700"/></button><button onClick={(e)=>{e.stopPropagation();handleDeleteHistory(h.id)}}><Icons.Trash2 size={20} className="text-slate-400 hover:text-red-500"/></button><span className="font-bold text-logo-green-700">{formatCurrency(h.stats.totalRevenue)}</span>{expandedHistoryId===h.id?<Icons.ChevronUp size={20} className="text-slate-400"/>:<Icons.ChevronDown size={20} className="text-slate-400"/>}</div></div>{expandedHistoryId===h.id && <div className="bg-slate-50 p-4 border-t text-sm"><h4 className="font-bold text-xs uppercase text-slate-400 mb-2">Transactions</h4>{h.transactions.map((t,i)=><div key={i} className="flex justify-between py-1 border-b last:border-0 border-slate-200"><span>{t.time} - {t.clientName} ({t.service})</span><span className="font-bold">{formatCurrency(t.amount)}</span></div>)}<h4 className="font-bold text-xs uppercase text-slate-400 mt-4 mb-2">Expenses</h4>{(h.expenses||[]).map((e,i)=><div key={i} className="flex justify-between py-1 border-b last:border-0 border-red-100 text-red-600"><span>{e.description} ({e.recordedBy})</span><span className="font-bold">-{formatCurrency(e.amount)}</span></div>)}</div>}</div>))}
                            </div>
                        )}

                        {/* Global Modal & Loader */}
                        {modal.isOpen && <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60"><div className="bg-white rounded-xl p-6 max-w-sm"><h3 className="font-bold mb-2">{modal.title}</h3><p className="mb-4 text-sm">{modal.message}</p><div className="flex gap-2 justify-end">{modal.type==='confirm'&&<button onClick={closeModal} className="px-4 py-2 text-slate-500">Cancel</button>}<button onClick={modal.onConfirm||closeModal} className={`px-4 py-2 rounded text-white ${modal.confirmColor==='red'?'bg-red-500':'bg-logo-green-600'}`}>Okay</button></div></div></div>}
                        {isGlobalLoading && <LoadingOverlay message="Processing..." />}
                    </main>
                    {view === 'dashboard' && <button onClick={()=>setView('add')} className="fixed bottom-6 right-6 bg-logo-green-700 text-white p-4 rounded-full shadow-lg hover:scale-105 transition-transform"><Icons.Plus size={28}/></button>}
                    <AdminResetUserModal editUserModal={editUserModal} setEditUserModal={setEditUserModal} handleResetPin={handleResetPin} />
                </div>
            );
        };
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
